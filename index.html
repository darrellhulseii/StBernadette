<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#000000">
<title>I Am Bernadette ‚Äî The Sacred Journey of Lourdes</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@400;700&family=Cinzel:wght@400;600&family=IM+Fell+English:ital@0;1&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html{height:100%;-webkit-text-size-adjust:100%;text-size-adjust:100%}
body{background:#000;overflow:hidden;font-family:'IM Fell English',Georgia,serif;touch-action:none;overscroll-behavior:none;-webkit-overscroll-behavior:none;position:fixed;width:100%;height:100%;
  height:100%;height:100dvh;-webkit-overflow-scrolling:touch;}
#gameCanvas{display:block;position:fixed;top:0;left:0;width:100%;height:100%;}
#ui{position:fixed;inset:0;pointer-events:none;z-index:10}

/* ‚îÄ‚îÄ TITLE SCREEN ‚îÄ‚îÄ */
#titleScreen{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;
background:radial-gradient(ellipse at 50% 60%,rgba(8,4,28,0.55),rgba(0,0,0,0.93));
z-index:100;pointer-events:all;transition:opacity 1.8s;
padding:env(safe-area-inset-top,0) env(safe-area-inset-right,0) env(safe-area-inset-bottom,0) env(safe-area-inset-left,0);}
#titleScreen h1{font-family:‚ÄòCinzel Decorative‚Äô,serif;font-size:clamp(22px,5vw,56px);color:#f5e6c0;
text-shadow:0 0 40px rgba(255,200,80,0.9),0 0 90px rgba(255,150,30,0.4);
letter-spacing:0.07em;text-align:center;line-height:1.25;margin-bottom:8px;padding:0 16px;}
#titleScreen h2{font-family:‚ÄòCinzel‚Äô,serif;font-size:clamp(12px,2.5vw,21px);color:#c4a882;letter-spacing:0.18em;margin-bottom:5px;text-align:center;}
#titleScreen .sub{font-family:‚ÄòIM Fell English‚Äô,serif;font-style:italic;font-size:clamp(11px,2vw,16px);color:#9a7850;margin-bottom:32px;text-align:center;padding:0 20px;}
#titleScreen .cross{font-size:clamp(36px,7vw,72px);color:#f0d080;margin-bottom:24px;animation:GLOW 2s infinite alternate;}
@keyframes GLOW{from{text-shadow:0 0 18px rgba(255,220,80,0.5)}to{text-shadow:0 0 60px #ffd700,0 0 130px rgba(255,160,30,0.5)}}
#startBtn{font-family:‚ÄòCinzel‚Äô,serif;font-size:clamp(13px,2.2vw,17px);letter-spacing:0.16em;color:#f5e6c0;
background:rgba(255,200,80,0.1);border:1px solid rgba(255,200,80,0.45);padding:16px 48px;
cursor:pointer;pointer-events:all;transition:all 0.4s;text-transform:uppercase;
-webkit-tap-highlight-color:transparent;touch-action:manipulation;min-height:52px;}
#startBtn:hover,#startBtn:active{background:rgba(255,200,80,0.22);border-color:rgba(255,200,80,0.85);box-shadow:0 0 28px rgba(255,200,80,0.35);}
.tv{font-family:‚ÄòIM Fell English‚Äô,serif;font-style:italic;font-size:clamp(10px,1.5vw,14px);
color:rgba(180,150,80,0.7);margin-top:24px;text-align:center;max-width:500px;line-height:1.6;padding:0 20px;}

/* ‚îÄ‚îÄ CHAPTER BANNER ‚îÄ‚îÄ */
#chapterBanner{position:fixed;top:0;left:0;width:100%;padding:max(14px,env(safe-area-inset-top,14px)) 16px 18px;text-align:center;
background:linear-gradient(to bottom,rgba(0,0,0,0.82),transparent);
opacity:0;transition:opacity 1s;pointer-events:none;}
#chapterBanner.show{opacity:1}
#chapterTitle{font-family:‚ÄòCinzel Decorative‚Äô,serif;font-size:clamp(12px,2.8vw,28px);color:#f5e6c0;
text-shadow:0 0 22px rgba(255,200,80,0.65);letter-spacing:0.08em;}
#chapterDate{font-family:‚ÄòCinzel‚Äô,serif;font-size:clamp(9px,1.6vw,14px);color:#c4a870;letter-spacing:0.18em;margin-top:4px;}
#ageBadge{position:fixed;top:max(68px, calc(env(safe-area-inset-top,0px) + 56px));left:50%;transform:translateX(-50%);
font-family:‚ÄòCinzel‚Äô,serif;font-size:clamp(9px,1.3vw,11px);letter-spacing:0.1em;color:rgba(200,170,80,0.85);
background:rgba(5,3,20,0.72);border:1px solid rgba(200,160,60,0.3);padding:5px 14px;
display:none;pointer-events:none;z-index:60;text-align:center;white-space:nowrap;max-width:90vw;overflow:hidden;text-overflow:ellipsis;}

/* ‚îÄ‚îÄ DIALOGUE ‚îÄ‚îÄ */
#dialogue{position:fixed;top:max(10%, env(safe-area-inset-top,10px));left:50%;transform:translateX(-50%);
width:min(96vw,830px);max-height:55vh;overflow-y:auto;
background:rgba(4,2,18,0.78);
backdrop-filter:blur(16px) saturate(1.5);-webkit-backdrop-filter:blur(16px) saturate(1.5);
border:1.5px solid rgba(215,175,65,0.52);border-radius:8px;
box-shadow:0 8px 50px rgba(0,0,0,0.72),inset 0 1px 0 rgba(255,230,120,0.1);
padding:20px 24px 16px;display:none;pointer-events:all;z-index:500;cursor:pointer;}
#dialogue::before,#dialogue::after{content:‚Äô‚Äô;position:absolute;width:18px;height:18px;
border-color:rgba(215,175,65,0.72);border-style:solid;pointer-events:none;}
#dialogue::before{top:-1px;left:-1px;border-width:2px 0 0 2px;border-radius:5px 0 0 0;}
#dialogue::after{bottom:-1px;right:-1px;border-width:0 2px 2px 0;border-radius:0 0 5px 0;}
#dialogueSpeaker{font-family:‚ÄòCinzel‚Äô,serif;font-size:clamp(10px,2.4vw,14px);color:#ffd055;
letter-spacing:0.18em;text-transform:uppercase;margin-bottom:10px;padding-bottom:8px;
border-bottom:1px solid rgba(215,175,65,0.28);text-align:center;
text-shadow:0 0 16px rgba(255,210,55,0.65),0 0 3px rgba(0,0,0,0.9);min-height:1.3em;}
#dialogueText{font-family:‚ÄòIM Fell English‚Äô,serif;font-size:clamp(15px,3.2vw,23px);color:#fff8ec;
line-height:1.8;text-align:center;text-shadow:0 2px 10px rgba(0,0,0,1);padding:0 4px;}
#dialogueContinue{font-family:‚ÄòCinzel‚Äô,serif;font-size:clamp(9px,1.8vw,12px);color:rgba(215,178,68,0.78);
text-align:center;margin-top:12px;letter-spacing:0.15em;animation:BLINK 1.3s infinite;}
@keyframes BLINK{0%,100%{opacity:0.28}50%{opacity:1}}
.kb-hint{display:inline;}
@media (pointer:coarse){.kb-hint{display:none;}}
#dialogueDimmer{position:fixed;inset:0;background:radial-gradient(ellipse at 50% 20%,rgba(0,0,0,0),rgba(0,0,0,0.32));
display:none;z-index:499;pointer-events:none;}

/* ‚îÄ‚îÄ TASKS ‚îÄ‚îÄ */
#taskPanel{position:fixed;top:max(88px, calc(env(safe-area-inset-top,0px) + 80px));right:max(12px,env(safe-area-inset-right,12px));
background:rgba(5,3,20,0.88);border:1px solid rgba(200,160,60,0.3);
padding:12px 16px;min-width:min(185px,42vw);max-width:min(220px,48vw);display:none;z-index:60;border-radius:4px;}
#taskPanel h3{font-family:‚ÄòCinzel‚Äô,serif;font-size:clamp(9px,1.4vw,12px);color:#f0c060;letter-spacing:0.1em;margin-bottom:8px;text-transform:uppercase;}
.task-item{font-family:‚ÄòIM Fell English‚Äô,serif;font-size:clamp(11px,1.8vw,14px);color:#c0b090;margin:4px 0;
padding-left:18px;position:relative;transition:color 0.5s;line-height:1.4;}
.task-item::before{content:‚Äò‚óã‚Äô;position:absolute;left:0;color:#6a5830;}
.task-item.done{color:#80c080;text-decoration:line-through;}
.task-item.done::before{content:‚Äò‚úì‚Äô;color:#80c080;}

/* ‚îÄ‚îÄ INTERACT PROMPT ‚îÄ‚îÄ */
#interactPrompt{position:fixed;bottom:max(190px, calc(env(safe-area-inset-bottom,0px) + 190px));left:50%;transform:translateX(-50%);border-radius:20px;
font-family:‚ÄòCinzel‚Äô,serif;font-size:clamp(11px,1.6vw,14px);letter-spacing:0.12em;
color:#f0e0a0;background:rgba(5,3,20,0.85);border:1px solid rgba(200,160,60,0.5);
padding:9px 26px;display:none;text-transform:uppercase;animation:PULSE 1.5s infinite;z-index:200;border-radius:3px;
white-space:nowrap;}
@keyframes PULSE{0%,100%{border-color:rgba(200,160,60,0.35)}50%{border-color:rgba(200,160,60,0.85)}}

/* ‚îÄ‚îÄ CONTROLS HINT ‚îÄ‚îÄ */
#controls{position:fixed;bottom:max(8px,env(safe-area-inset-bottom,8px));left:50%;transform:translateX(-50%);
font-family:‚ÄòCinzel‚Äô,serif;font-size:clamp(7px,1.2vw,10px);color:rgba(180,160,100,0.38);
letter-spacing:0.1em;text-align:center;pointer-events:none;display:none;}

/* ‚îÄ‚îÄ NOTIFICATION ‚îÄ‚îÄ */
#notification{position:fixed;top:48%;left:50%;transform:translate(-50%,-50%);
font-family:‚ÄòCinzel Decorative‚Äô,serif;font-size:clamp(13px,2.5vw,22px);
color:#f5e6c0;text-shadow:0 0 28px rgba(255,200,80,0.85);text-align:center;
display:none;pointer-events:none;padding:18px 24px;z-index:601;}

/* ‚îÄ‚îÄ FADE ‚îÄ‚îÄ */
#fade{position:fixed;inset:0;background:#000;opacity:0;pointer-events:none;z-index:99;transition:opacity 1.5s;}
#fade.in{opacity:1;pointer-events:all;}
#vignette{position:fixed;inset:0;pointer-events:none;z-index:8;
background:radial-gradient(ellipse at 50% 50%, transparent 40%, rgba(0,0,0,0.62) 100%);
transition:opacity 0.8s;}

/* ‚îÄ‚îÄ ATMOSPHERE ‚îÄ‚îÄ */
#springGlow{position:fixed;inset:0;background:radial-gradient(ellipse at 50% 62%,rgba(0,180,255,0.14),transparent 68%);
display:none;pointer-events:none;animation:SPING 3s infinite;}
@keyframes SPING{0%,100%{opacity:0.3}50%{opacity:1}}
#holyGlow{position:fixed;inset:0;background:radial-gradient(ellipse at 50% 28%,rgba(255,255,200,0.18),transparent 58%);
display:none;pointer-events:none;animation:HPULSE 2s infinite;}
@keyframes HPULSE{0%,100%{opacity:0.45}50%{opacity:1}}

/* ‚îÄ‚îÄ SOUND HINT ‚îÄ‚îÄ */
#soundHint{position:fixed;top:max(8px,env(safe-area-inset-top,8px));left:max(8px,env(safe-area-inset-left,8px));z-index:200;
font-family:‚ÄòCinzel‚Äô,serif;font-size:clamp(9px,1.2vw,11px);letter-spacing:0.1em;color:rgba(200,170,70,0.5);
pointer-events:all;cursor:pointer;background:rgba(5,3,20,0.6);padding:6px 10px;
border:1px solid rgba(200,160,60,0.2);border-radius:3px;touch-action:manipulation;
-webkit-tap-highlight-color:transparent;min-height:36px;display:flex;align-items:center;}
#soundHint:hover,#soundHint:active{color:rgba(200,170,70,0.9);}

/* ‚îÄ‚îÄ WALK / SPRING / COMMUNION PROMPTS ‚îÄ‚îÄ */
#springPrompt,#communionPrompt,#walkPrompt{position:fixed;top:28%;left:50%;transform:translateX(-50%);
font-family:‚ÄòCinzel‚Äô,serif;font-size:clamp(12px,2.2vw,15px);letter-spacing:0.1em;
background:rgba(5,3,20,0.8);border:1px solid rgba(100,160,255,0.48);
padding:11px 28px;display:none;text-align:center;animation:PULSE 1.5s infinite;z-index:200;
border-radius:4px;max-width:90vw;}
#springPrompt{color:#88ccff;border-color:rgba(100,160,255,0.48);text-shadow:0 0 10px rgba(100,180,255,0.65);}
#communionPrompt{color:#f0d060;border-color:rgba(200,160,60,0.48);text-shadow:0 0 10px rgba(255,200,60,0.5);}
#walkPrompt{color:#c0e0a0;border-color:rgba(100,180,100,0.48);text-shadow:0 0 10px rgba(120,200,80,0.5);}

/* ‚îÄ‚îÄ OVERLAY PANELS (rosary, quiz, interrogation, candle) ‚îÄ‚îÄ */
.overlay-panel{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
display:none;flex-direction:column;align-items:center;gap:12px;
backdrop-filter:blur(14px) saturate(1.4);-webkit-backdrop-filter:blur(14px) saturate(1.4);
border-radius:10px;padding:24px 20px;
width:min(96vw,620px);max-height:90vh;overflow-y:auto;
z-index:600;pointer-events:all;}
.overlay-panel.show{display:flex;}
#rosaryUI{background:rgba(4,2,18,0.92);border:1.5px solid rgba(215,175,65,0.55);}
#rosaryTitle{font-family:‚ÄòCinzel Decorative‚Äô,serif;font-size:clamp(14px,3vw,20px);color:#f0d060;
text-shadow:0 0 18px rgba(255,200,60,0.75);letter-spacing:0.1em;text-align:center;}
#rosaryMystery{font-family:‚ÄòIM Fell English‚Äô,serif;font-style:italic;font-size:clamp(14px,2.4vw,17px);
color:#f8f0e0;text-align:center;max-width:480px;line-height:1.65;text-shadow:0 2px 8px rgba(0,0,0,0.9);}
#rosaryBeads{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;padding:6px 0;}
.rbead{width:44px;height:44px;border-radius:50%;cursor:pointer;touch-action:manipulation;
background:radial-gradient(circle at 35% 30%,rgba(255,230,120,0.95),rgba(160,100,20,0.82));
border:2px solid rgba(255,210,70,0.82);box-shadow:0 3px 10px rgba(0,0,0,0.6);
transition:transform 0.12s;display:grid;place-items:center;font-size:16px;color:rgba(80,40,0,0.8);
-webkit-tap-highlight-color:transparent;}
.rbead:hover,.rbead:active{transform:scale(1.22);box-shadow:0 3px 18px rgba(0,0,0,0.85),0 0 20px rgba(255,190,40,0.85);}
.rbead.prayed{background:radial-gradient(circle at 35% 30%,rgba(200,230,255,0.95),rgba(30,60,160,0.82));
border-color:rgba(140,180,255,0.9);}
#rosaryProgress{font-family:‚ÄòCinzel‚Äô,serif;font-size:clamp(10px,1.8vw,13px);color:rgba(200,170,70,0.9);letter-spacing:0.12em;text-align:center;}

#quizUI{background:rgba(4,2,18,0.92);border:1.5px solid rgba(215,175,65,0.55);}
#quizTitle{font-family:‚ÄòCinzel Decorative‚Äô,serif;font-size:clamp(13px,2.6vw,18px);color:#f0d060;letter-spacing:0.08em;text-align:center;}
#quizQ{font-family:‚ÄòIM Fell English‚Äô,serif;font-size:clamp(15px,2.8vw,19px);color:#f8f0e0;text-align:center;line-height:1.7;max-width:500px;}
#quizAnswers{display:flex;flex-direction:column;gap:10px;width:100%;}
.qAnswer{font-family:‚ÄòCinzel‚Äô,serif;font-size:clamp(12px,2vw,14px);color:#f5e6c0;
background:rgba(255,200,80,0.08);border:1px solid rgba(200,160,60,0.38);
padding:13px 18px;cursor:pointer;text-align:center;letter-spacing:0.06em;
transition:all 0.2s;border-radius:4px;touch-action:manipulation;
-webkit-tap-highlight-color:transparent;min-height:48px;display:flex;align-items:center;justify-content:center;}
.qAnswer:hover,.qAnswer:active{background:rgba(255,200,80,0.22);border-color:rgba(200,160,60,0.85);}
.qAnswer.correct{background:rgba(80,200,80,0.25);border-color:rgba(100,220,100,0.85);color:#90f090;}
.qAnswer.wrong{background:rgba(200,60,60,0.22);border-color:rgba(220,80,80,0.75);color:#f08080;}
#quizProgress{font-family:‚ÄòCinzel‚Äô,serif;font-size:clamp(10px,1.6vw,11px);color:rgba(200,170,70,0.7);letter-spacing:0.12em;}

#interrUI{background:rgba(4,2,18,0.94);border:1.5px solid rgba(180,100,60,0.55);}
#interrLabel{font-family:‚ÄòCinzel‚Äô,serif;font-size:clamp(11px,2.2vw,15px);color:#f0c080;letter-spacing:0.06em;text-align:center;text-transform:uppercase;}
#interrText{font-family:‚ÄòIM Fell English‚Äô,serif;font-size:clamp(14px,2.6vw,18px);color:#f8f0e0;text-align:center;line-height:1.7;max-width:480px;}
#interrChoices{display:flex;flex-direction:column;gap:10px;width:100%;}
.iChoice{font-family:‚ÄòIM Fell English‚Äô,serif;font-style:italic;font-size:clamp(14px,2.4vw,17px);
color:#f5e6c0;background:rgba(180,100,60,0.1);border:1px solid rgba(180,100,60,0.38);
padding:13px 18px;cursor:pointer;text-align:center;transition:all 0.2s;border-radius:4px;
touch-action:manipulation;-webkit-tap-highlight-color:transparent;min-height:52px;
display:flex;align-items:center;justify-content:center;}
.iChoice:hover,.iChoice:active{background:rgba(180,100,60,0.28);border-color:rgba(180,100,60,0.85);}

#candleUI{background:rgba(4,2,18,0.92);border:1.5px solid rgba(255,160,30,0.55);}
#candleTitle{font-family:‚ÄòCinzel‚Äô,serif;font-size:clamp(13px,2.5vw,17px);color:#ffa040;letter-spacing:0.1em;text-align:center;}
#candleDesc{font-family:‚ÄòIM Fell English‚Äô,serif;font-style:italic;font-size:clamp(13px,2.4vw,17px);color:#f8f0e0;text-align:center;line-height:1.7;max-width:420px;}
#candleFlame{font-size:clamp(48px,10vw,72px);text-align:center;animation:FLICKER 0.3s infinite alternate;}
@keyframes FLICKER{from{transform:scaleY(1) rotate(-1deg)}to{transform:scaleY(1.08) rotate(1.5deg)}}
#candleBar{width:min(280px,78vw);height:20px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,160,30,0.5);border-radius:10px;overflow:hidden;margin:4px 0;}
#candleFill{height:100%;width:0%;background:linear-gradient(90deg,#ff6600,#ffd700);transition:width 0.1s;border-radius:10px;}
#candleBtn{font-family:‚ÄòCinzel‚Äô,serif;font-size:clamp(13px,2.2vw,15px);letter-spacing:0.1em;
color:#ffa040;background:rgba(255,160,30,0.12);border:1.5px solid rgba(255,160,30,0.5);
padding:16px 40px;cursor:pointer;transition:all 0.2s;user-select:none;-webkit-user-select:none;
border-radius:6px;touch-action:manipulation;-webkit-tap-highlight-color:transparent;min-height:56px;}
#candleBtn.held{background:rgba(255,160,30,0.38);border-color:rgba(255,160,30,0.9);box-shadow:0 0 22px rgba(255,160,30,0.55);}

/* ‚îÄ‚îÄ JOYSTICK ‚îÄ‚îÄ */
#joystickWrap{position:fixed;bottom:max(30px,env(safe-area-inset-bottom,30px));
left:max(24px,env(safe-area-inset-left,24px));
width:clamp(130px,20vw,160px);height:clamp(130px,20vw,160px);
pointer-events:all;user-select:none;-webkit-user-select:none;z-index:50;touch-action:none;}
#joystickBase{position:absolute;inset:0;border-radius:50%;
background:radial-gradient(circle at 38% 35%,rgba(255,220,120,0.16),rgba(10,5,30,0.72));
border:2px solid rgba(200,160,60,0.48);box-shadow:0 0 16px rgba(200,160,60,0.14);backdrop-filter:blur(4px);}
#joystickBase::before{content:‚Äô‚Äô;position:absolute;inset:10px;border-radius:50%;border:1px dashed rgba(200,160,60,0.22);}
#joystickBase::after{content:‚Äô‚Äô;position:absolute;inset:0;border-radius:50%;
background:linear-gradient(rgba(200,160,60,0.12) 0,rgba(200,160,60,0.12) 100%) center/1px 100% no-repeat,
linear-gradient(rgba(200,160,60,0.12) 0,rgba(200,160,60,0.12) 100%) center/100% 1px no-repeat;}
#joystickKnob{position:absolute;width:clamp(46px,8vw,58px);height:clamp(46px,8vw,58px);
top:50%;left:50%;transform:translate(-50%,-50%);
border-radius:50%;background:radial-gradient(circle at 35% 30%,rgba(255,230,140,0.95),rgba(160,100,20,0.88));
border:2px solid rgba(255,210,80,0.88);box-shadow:0 4px 18px rgba(0,0,0,0.62),0 0 13px rgba(255,200,60,0.32);
display:grid;place-items:center;font-size:18px;color:rgba(255,240,180,0.72);cursor:grab;touch-action:none;}
.jDir{position:absolute;font-size:10px;color:rgba(200,160,60,0.44);pointer-events:none;}
.jDir.u{top:3px;left:50%;transform:translateX(-50%)}
.jDir.d{bottom:3px;left:50%;transform:translateX(-50%)}
.jDir.l{left:3px;top:50%;transform:translateY(-50%)}
.jDir.r{right:3px;top:50%;transform:translateY(-50%)}

/* ‚îÄ‚îÄ ACTION BUTTONS ‚îÄ‚îÄ */
#actionButtons{position:fixed;bottom:max(26px,env(safe-area-inset-bottom,26px));
right:max(22px,env(safe-area-inset-right,22px));
display:flex;flex-direction:column;align-items:center;gap:12px;
pointer-events:all;z-index:50;user-select:none;}
.actBtn{width:clamp(62px,12vw,76px);height:clamp(62px,12vw,76px);border-radius:50%;
display:grid;place-items:center;font-family:‚ÄòCinzel‚Äô,serif;font-weight:600;
cursor:pointer;border:none;outline:none;transition:transform 0.08s,filter 0.08s;
-webkit-tap-highlight-color:transparent;touch-action:manipulation;position:relative;overflow:hidden;}
.actBtn:active{transform:scale(0.84);filter:brightness(1.38);}
#btnE{background:radial-gradient(circle at 38% 32%,rgba(255,230,120,0.95),rgba(155,88,10,0.9));
border:2.5px solid rgba(255,210,70,0.9);box-shadow:0 4px 20px rgba(0,0,0,0.72),0 0 18px rgba(255,190,40,0.4);
font-size:clamp(18px,4vw,24px);color:#3a1a00;}
#btnContinue{background:radial-gradient(circle at 38% 32%,rgba(180,210,255,0.9),rgba(38,58,120,0.88));
border:2.5px solid rgba(140,180,255,0.8);box-shadow:0 4px 20px rgba(0,0,0,0.72),0 0 18px rgba(100,140,255,0.28);
font-size:clamp(20px,4.5vw,26px);color:#f5f0ff;}
.actLabel{font-family:‚ÄòCinzel‚Äô,serif;font-size:clamp(7px,1.4vw,10px);letter-spacing:0.1em;
color:rgba(200,170,80,0.65);text-transform:uppercase;margin-top:-6px;pointer-events:none;}

/* ‚îÄ‚îÄ LANDSCAPE-ONLY ORIENTATION HINT (show in portrait on tiny phones) ‚îÄ‚îÄ */
#orientHint{position:fixed;inset:0;background:rgba(4,2,18,0.96);z-index:9999;
display:none;flex-direction:column;align-items:center;justify-content:center;
font-family:‚ÄòCinzel‚Äô,serif;color:#f5e6c0;text-align:center;gap:18px;pointer-events:none;}
#orientHint .oh-icon{font-size:56px;animation:ROTATE 2s ease-in-out infinite;}
@keyframes ROTATE{0%,100%{transform:rotate(0deg)}50%{transform:rotate(90deg)}}
#orientHint p{font-size:clamp(13px,3vw,18px);letter-spacing:0.12em;color:#c4a870;padding:0 24px;}

/* ‚îÄ‚îÄ RESPONSIVE ‚Äî SMALL PHONES ‚îÄ‚îÄ */
@media (max-width: 480px) {
#dialogue{top:max(8%, env(safe-area-inset-top,8%));padding:16px 16px 14px;}
#dialogueText{font-size:clamp(14px,4.2vw,20px);}
#taskPanel{min-width:min(160px,44vw);padding:10px 12px;}
#interactPrompt{bottom:max(175px, calc(env(safe-area-inset-bottom,0px) + 175px));font-size:12px;padding:8px 18px;}
.overlay-panel{padding:18px 14px;gap:10px;}
#rosaryBeads{gap:8px;}
.rbead{width:40px;height:40px;}
}

/* ‚îÄ‚îÄ RESPONSIVE ‚Äî LANDSCAPE MOBILE ‚îÄ‚îÄ */  
@media (max-height: 450px) and (orientation: landscape) {
#dialogue{top:max(6%, env(safe-area-inset-top,6%));max-height:60vh;padding:14px 20px 12px;}
#dialogueText{font-size:clamp(13px,2.8vw,18px);line-height:1.6;}
#taskPanel{top:max(52px, calc(env(safe-area-inset-top,0px) + 48px));}
#chapterBanner{padding:max(8px,env(safe-area-inset-top,8px)) 12px 12px;}
#joystickWrap{bottom:max(16px,env(safe-area-inset-bottom,16px));left:max(16px,env(safe-area-inset-left,16px));width:120px;height:120px;}
#actionButtons{bottom:max(16px,env(safe-area-inset-bottom,16px));right:max(16px,env(safe-area-inset-right,16px));gap:8px;}
.actBtn{width:58px;height:58px;}
.overlay-panel{max-height:88vh;padding:14px 16px;gap:8px;}
}
</style>

</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="orientHint">
  <div class="oh-icon">üì±</div>
  <p>Rotate your device to landscape<br>for the best experience</p>
</div>
<div id="ui">
  <div id="titleScreen">
    <div class="cross">‚úù</div>
    <h1>I Am Bernadette</h1>
    <h2>The Sacred Journey of Lourdes</h2>
    <div class="sub">The Complete Life of Saint Bernadette Soubirous ¬∑ 1844‚Äì1879</div>
    <button id="startBtn" onclick="startGame()">‚úù Begin the Sacred Journey ‚úù</button>
    <div class="tv">"I do not promise to make you happy in this world, but in the next."<br>‚Äî Our Lady of Lourdes to Bernadette, 1858<br><br><span style="font-size:0.85em;opacity:0.55;letter-spacing:0.08em">18 Chapters ¬∑ Lourdes, France ¬∑ 1844‚Äì1879</span></div>
  </div>
  <div id="chapterBanner"><div id="chapterTitle"></div><div id="chapterDate"></div></div>
  <div id="ageBadge"></div>
  <div id="dialogueDimmer"></div>
  <div id="dialogue">
    <div id="dialogueSpeaker"></div>
    <div id="dialogueText"></div>
    <div id="dialogueContinue">‚è© <span class="kb-hint">Space ¬∑ Enter ¬∑ </span>Tap to continue</div>
  </div>
  <div id="taskPanel"><h3>‚úù Today's Duties</h3><div id="taskList"></div></div>
  <div id="interactPrompt">‚úã Tap ¬∑ [ E ]</div>
  <div id="notification"></div>
  <div id="controls">WASD ¬∑ Joystick to Move &nbsp;|&nbsp; E to Interact</div>
  <div id="vignette"></div>
  <div id="zoomHint" style="position:fixed;bottom:8px;left:50%;transform:translateX(-50%);
    color:rgba(255,255,255,0.32);font-size:11px;font-family:inherit;pointer-events:none;
    letter-spacing:0.08em;z-index:20;text-align:center;transition:opacity 1.5s;">
    <span class="kb-hint">Q = zoom out &nbsp;¬∑&nbsp; Z = reset &nbsp;¬∑&nbsp; </span>Pinch to zoom</div>
  <div id="fade"></div>
  <div id="springGlow"></div>
  <div id="holyGlow"></div>
  <div id="springPrompt">üíß Walk to the muddy spot at the base of the cliff</div>
  <div id="communionPrompt">‚úù Walk to the altar to receive Holy Communion</div>
  <div id="walkPrompt">üö∂ Walk toward Massabielle</div>
  <div id="soundHint" onclick="toggleAmbient()">‚ô™ Sound: OFF</div>
  <div id="rosaryUI" class="overlay-panel">
    <div id="rosaryTitle">‚úù The Holy Rosary ‚úù</div>
    <div id="rosaryMystery">Click each bead to pray a Mystery.</div>
    <div id="rosaryBeads"></div>
    <div id="rosaryProgress">0 / 5 Mysteries prayed</div>
  </div>
  <div id="quizUI" class="overlay-panel">
    <div id="quizTitle">‚úù Catechism Lesson ‚úù</div>
    <div id="quizQ"></div>
    <div id="quizAnswers"></div>
    <div id="quizProgress"></div>
  </div>
  <div id="interrUI" class="overlay-panel">
    <div id="interrLabel">Commissioner Jacomet Questions You</div>
    <div id="interrText"></div>
    <div id="interrChoices"></div>
  </div>
  <div id="candleUI" class="overlay-panel">
    <div id="candleTitle">‚ú¶ The Candle Ecstasy ‚ú¶</div>
    <div id="candleDesc">Bernadette holds a flame against her bare hands during prayer. She feels nothing. Hold to pray through the ecstasy.</div>
    <div id="candleFlame">üïØÔ∏è</div>
    <div id="candleBar"><div id="candleFill"></div></div>
    <button id="candleBtn">Hold to Pray in Ecstasy</button>
  </div>
  <div id="joystickWrap">
    <div id="joystickBase">
      <span class="jDir u">‚ñ≤</span><span class="jDir d">‚ñº</span>
      <span class="jDir l">‚óÄ</span><span class="jDir r">‚ñ∂</span>
    </div>
    <div id="joystickKnob">‚úù</div>
  </div>
  <div id="actionButtons">
    <button class="actBtn" id="btnContinue">‚è©</button>
    <div class="actLabel">Continue</div>
    <button class="actBtn" id="btnE">E</button>
    <div class="actLabel">Interact</div>
  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
'use strict';

// Position helper ‚Äî avoids overwriting THREE.Vector3
function pm(mesh,x,y,z){mesh.position.set(x,y,z);return mesh;}
const canvas=document.getElementById(‚ÄògameCanvas‚Äô);
let W=window.innerWidth,H=window.innerHeight;
const renderer=new THREE.WebGLRenderer({canvas,antialias:window.devicePixelRatio<2,powerPreference:‚Äòhigh-performance‚Äô});
renderer.setSize(W,H);renderer.setPixelRatio(Math.min(devicePixelRatio,2));
renderer.shadowMap.enabled=true;renderer.shadowMap.type=THREE.PCFSoftShadowMap;
renderer.toneMapping=THREE.ACESFilmicToneMapping;renderer.toneMappingExposure=1.15;
const scene=new THREE.Scene();
const camera=new THREE.PerspectiveCamera(56,W/H,0.1,1000);
const clock=new THREE.Clock();
function onResize(){
W=window.innerWidth;H=window.innerHeight;
renderer.setSize(W,H);camera.aspect=W/H;camera.updateProjectionMatrix();
// Show orientation hint on portrait phones (not tablets)
const oh=document.getElementById(‚ÄòorientHint‚Äô);
if(oh){const isPortrait=W<H,isPhone=Math.min(W,H)<600;
oh.style.display=(isPortrait&&isPhone&&G.chapter>=0)?‚Äòflex‚Äô:‚Äònone‚Äô;}
}
window.addEventListener(‚Äòresize‚Äô,onResize);
window.addEventListener(‚Äòorientationchange‚Äô,()=>setTimeout(onResize,300));

const G={
chapter:-1,dialogueActive:false,dialogueQueue:[],dialogueIdx:0,dialogueCb:null,
tasks:{},completedTasks:{},
player:{mesh:null,canMove:true},
camera:{
// follow: trails behind player. fixed: locked position. cinematic: scripted arc. zoom: close-up
mode:‚Äòfollow‚Äô,
offset:new THREE.Vector3(0,9,13),  // used in follow mode
// fixed/cinematic/zoom targets (set per chapter)
pos:null, look:null,
// Dynamic FOV ‚Äî zoom in for intimate scenes, out for vistas
fov:56, fovCur:56,
// Who/what to look toward (overrides default player-tracking)
focusMesh:null, focusWeight:0,
// Cinematic orbit
orbitCenter:null, orbitR:0, orbitY:0, orbitSpeed:0, _orbitAngle:0,
shake:0, _orbitAngle:0,
},
nearbyInteractable:null,interactables:[],npcs:[],chapterObjects:[],
ourLady:null,springWater:null,keys:{},joy:{x:0,y:0},groundFn:null,
time:0,transitioning:false,bernadetteStage:0,_eHeld:false,
_awaitingSpring:false,_springTarget:null,_onSpringArrived:null,
_awaitingWalk:false,_walkTarget:null,_walkRadius:2,_onWalkArrived:null,
_nicheLight:null,_fireLight:null,_candleLight:null,_springPts:null,_springPtsPos:null,
};

window.addEventListener(‚Äòkeydown‚Äô,e=>{
G.keys[e.code]=true;
if(e.code===‚ÄòSpace‚Äô||e.code===‚ÄòEnter‚Äô)advanceDialogue();
// Q/E zoom out/in manually
if(e.code===‚ÄòKeyQ‚Äô)G.camera.fov=Math.min(G.camera.fov+6,75);
if(e.code===‚ÄòKeyE‚Äô&&!G._eHeld){
// E is interact; only zoom if no interactable nearby
if(!G.nearbyInteractable&&!G.dialogueActive)G.camera.fov=Math.max(G.camera.fov-6,30);
}
// Z = reset zoom
if(e.code===‚ÄòKeyZ‚Äô){G.camera.fov=56;G.camera.mode=‚Äòfollow‚Äô;}
});

// Tap dialogue to advance (mobile)
(function(){
const dlg=document.getElementById(‚Äòdialogue‚Äô);
let lastTap=0;
dlg.addEventListener(‚Äòtouchend‚Äô,e=>{
const now=Date.now();
if(now-lastTap<600)return; // debounce
lastTap=now;
e.preventDefault();
advanceDialogue();
},{passive:false});
dlg.addEventListener(‚Äòclick‚Äô,advanceDialogue);
})();
window.addEventListener(‚Äòkeyup‚Äô,e=>{G.keys[e.code]=false;});

// Joystick
(function(){
const wrap=document.getElementById(‚ÄòjoystickWrap‚Äô),base=document.getElementById(‚ÄòjoystickBase‚Äô),knob=document.getElementById(‚ÄòjoystickKnob‚Äô);
const R=52,DEAD=0.14,SZ=152;let active=false,touchId=null,ox=0,oy=0;
function centre(){const r=wrap.getBoundingClientRect();return{cx:r.left+r.width/2,cy:r.top+r.height/2};}
function place(x,y){let l=Math.max(8,Math.min(W-SZ-8,x-SZ/2)),t=Math.max(8,Math.min(H-SZ-8,y-SZ/2));
wrap.style.cssText+=`;left:${l}px;top:${t}px;bottom:auto;right:auto;`;}
function move(cx,cy){const dx=cx-ox,dy=cy-oy,dist=Math.sqrt(dx*dx+dy*dy),cl=Math.min(dist,R),a=Math.atan2(dy,dx);
const kx=Math.cos(a)*cl,ky=Math.sin(a)*cl;
knob.style.transform=`translate(calc(-50% + ${kx}px),calc(-50% + ${ky}px))`;
const nx=kx/R,ny=ky/R;
if(Math.abs(nx)<DEAD&&Math.abs(ny)<DEAD){G.joy.x=0;G.joy.y=0;}
else{const a8=Math.round(Math.atan2(ny,nx)/(Math.PI/4))*(Math.PI/4),mag=Math.min(Math.sqrt(nx*nx+ny*ny),1);
G.joy.x=+(Math.cos(a8)*mag).toFixed(2);G.joy.y=+(Math.sin(a8)*mag).toFixed(2);}}
function reset(){active=false;touchId=null;G.joy.x=0;G.joy.y=0;knob.style.transform=‚Äòtranslate(-50%,-50%)‚Äô;}
base.addEventListener(‚Äòmousedown‚Äô,e=>{if(active)return;e.preventDefault();active=true;const c=centre();ox=c.cx;oy=c.cy;move(e.clientX,e.clientY);});
window.addEventListener(‚Äòmousemove‚Äô,e=>{if(!active||touchId!==null)return;move(e.clientX,e.clientY);});
window.addEventListener(‚Äòmouseup‚Äô,()=>{if(active&&touchId===null)reset();});
window.addEventListener(‚Äòtouchstart‚Äô,e=>{
if(active)return;
// Don‚Äôt intercept touches on UI panels, dialogue, or buttons
const target=e.target;
const isUI=target.closest(‚Äô.overlay-panel,#dialogue,#actionButtons,#soundHint,#titleScreen,#taskPanel,#interrUI,#quizUI,#rosaryUI,#candleUI‚Äô);
if(isUI)return;
const t=Array.from(e.changedTouches).find(t=>t.clientX<W*0.65);
if(!t)return;
e.preventDefault();active=true;touchId=t.identifier;ox=t.clientX;oy=t.clientY;place(ox,oy);move(ox,oy);
},{passive:false});
window.addEventListener(‚Äòtouchmove‚Äô,e=>{if(!active)return;e.preventDefault();for(const t of e.changedTouches){if(t.identifier===touchId){move(t.clientX,t.clientY);break;}}},{passive:false});
window.addEventListener(‚Äòtouchend‚Äô,e=>{for(const t of e.changedTouches){if(t.identifier===touchId){reset();break;}}});
window.addEventListener(‚Äòtouchcancel‚Äô,()=>reset());
wrap.addEventListener(‚Äòtouchcancel‚Äô,()=>reset());
})();

// ‚îÄ‚îÄ Pinch-to-zoom ‚îÄ‚îÄ
(function(){
let lastDist=0;
window.addEventListener(‚Äòtouchstart‚Äô,e=>{if(e.touches.length===2)lastDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);},{passive:true});
window.addEventListener(‚Äòtouchmove‚Äô,e=>{
if(e.touches.length!==2)return;
const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
if(lastDist>0){const delta=(lastDist-d)*0.08;G.camera.fov=Math.max(28,Math.min(78,G.camera.fov+delta));}
lastDist=d;
},{passive:true});
window.addEventListener(‚Äòtouchend‚Äô,e=>{if(e.touches.length<2)lastDist=0;},{passive:true});
})();

// Action buttons
(function(){
const btnE=document.getElementById(‚ÄòbtnE‚Äô),btnC=document.getElementById(‚ÄòbtnContinue‚Äô);
function pe(e){e.preventDefault();if(G.nearbyInteractable&&!G.dialogueActive)G.nearbyInteractable.onInteract();}
function pc(e){e.preventDefault();advanceDialogue();}
btnE.addEventListener(‚Äòtouchstart‚Äô,pe,{passive:false});btnE.addEventListener(‚Äòmousedown‚Äô,pe);
btnC.addEventListener(‚Äòtouchstart‚Äô,pc,{passive:false});btnC.addEventListener(‚Äòmousedown‚Äô,pc);
function tick(){btnC.style.opacity=G.dialogueActive?‚Äò1‚Äô:‚Äò0.35‚Äô;btnE.style.opacity=(!G.dialogueActive&&G.nearbyInteractable)?‚Äò1‚Äô:‚Äò0.38‚Äô;requestAnimationFrame(tick);}tick();
})();

// Audio
const AUDIO=(function(){
let ctx=null,wind=null,water=null,church=null,enabled=false;
function ensure(){if(!ctx)ctx=new(window.AudioContext||window.webkitAudioContext)();}
function makeNoise(freq){const buf=ctx.createBuffer(1,ctx.sampleRate*4,ctx.sampleRate),d=buf.getChannelData(0);
for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;
const src=ctx.createBufferSource();src.buffer=buf;src.loop=true;
const lp=ctx.createBiquadFilter();lp.type=‚Äòlowpass‚Äô;lp.frequency.value=freq;
const g=ctx.createGain();g.gain.value=0;src.connect(lp);lp.connect(g);g.connect(ctx.destination);src.start();return{gain:g};}
function makeChurch(){const o1=ctx.createOscillator(),o2=ctx.createOscillator();o1.type=‚Äòsine‚Äô;o2.type=‚Äòsine‚Äô;
o1.frequency.value=220;o2.frequency.value=277;const g=ctx.createGain();g.gain.value=0;
o1.connect(g);o2.connect(g);g.connect(ctx.destination);o1.start();o2.start();return{gain:g};}
function ramp(n,v,t=1.2){if(n&&enabled&&ctx)n.gain.gain.linearRampToValueAtTime(v,ctx.currentTime+t);}
return{
start(){ensure();enabled=true;wind=makeNoise(400);water=makeNoise(900);church=makeChurch();document.getElementById(‚ÄòsoundHint‚Äô).textContent=‚Äò‚ô™ Sound: ON‚Äô;},
stop(){enabled=false;[wind,water,church].forEach(n=>{if(n)n.gain.gain.value=0;});wind=null;water=null;church=null;document.getElementById(‚ÄòsoundHint‚Äô).textContent=‚Äò‚ô™ Sound: OFF‚Äô;},
setWind(v){ramp(wind,v*0.055);},setWater(v){ramp(water,v*0.07);},setChurch(v){ramp(church,v*0.028);},isOn(){return enabled;}
};
})();
function toggleAmbient(){if(AUDIO.isOn())AUDIO.stop();else{AUDIO.start();AUDIO.setWind(0.4);}}

// Utilities
function rand(a,b){return a+(b-a)*Math.random();}
function addC(o){scene.add(o);G.chapterObjects.push(o);return o;}
function notify(txt,dur=2600){const n=document.getElementById(‚Äònotification‚Äô);n.textContent=txt;n.style.display=‚Äòblock‚Äô;setTimeout(()=>n.style.display=‚Äònone‚Äô,dur);}
function fadeOut(cb){document.getElementById(‚Äòfade‚Äô).classList.add(‚Äòin‚Äô);setTimeout(cb,1500);}
function fadeIn(cb){setTimeout(()=>{document.getElementById(‚Äòfade‚Äô).classList.remove(‚Äòin‚Äô);if(cb)cb();},400);}
function showChapter(title,date){const b=document.getElementById(‚ÄòchapterBanner‚Äô);
document.getElementById(‚ÄòchapterTitle‚Äô).textContent=title;document.getElementById(‚ÄòchapterDate‚Äô).textContent=date;
b.classList.add(‚Äòshow‚Äô);setTimeout(()=>b.classList.remove(‚Äòshow‚Äô),3500);}
function showAge(txt){const a=document.getElementById(‚ÄòageBadge‚Äô);a.textContent=txt;a.style.display=‚Äòblock‚Äô;}
function hideEl(id){document.getElementById(id).style.display=‚Äònone‚Äô;}
function showEl(id){document.getElementById(id).style.display=‚Äòblock‚Äô;}

// Dialogue
function speak(queue,cb){
G.dialogueQueue=queue;G.dialogueIdx=0;G.dialogueCb=cb;G.dialogueActive=true;G.player.canMove=false;
showEl(‚Äòdialogue‚Äô);showEl(‚ÄòdialogueDimmer‚Äô);showLine(0);}
function showLine(i){if(i>=G.dialogueQueue.length){endDialogue();return;}
const l=G.dialogueQueue[i];
document.getElementById(‚ÄòdialogueSpeaker‚Äô).textContent=l.speaker||‚Äô‚Äô;
document.getElementById(‚ÄòdialogueText‚Äô).textContent=l.text;}
function advanceDialogue(){if(!G.dialogueActive)return;G.dialogueIdx++;if(G.dialogueIdx>=G.dialogueQueue.length){endDialogue();return;}showLine(G.dialogueIdx);}
function endDialogue(){G.dialogueActive=false;G.player.canMove=true;hideEl(‚Äòdialogue‚Äô);hideEl(‚ÄòdialogueDimmer‚Äô);if(G.dialogueCb){const c=G.dialogueCb;G.dialogueCb=null;c();}}

// Tasks
function initTasks(arr){G.tasks={};G.completedTasks={};arr.forEach(t=>{G.tasks[t.id]=t;});renderTasks();showEl(‚ÄòtaskPanel‚Äô);}
function completeTask(id){if(!G.completedTasks[id]){G.completedTasks[id]=true;renderTasks();notify(‚Äò‚úì ‚Äò+G.tasks[id].label);checkTasks();}}
function renderTasks(){const l=document.getElementById(‚ÄòtaskList‚Äô);l.innerHTML=‚Äô‚Äô;Object.values(G.tasks).forEach(t=>{const d=document.createElement(‚Äòdiv‚Äô);d.className=‚Äòtask-item‚Äô+(G.completedTasks[t.id]?‚Äô done‚Äô:‚Äô‚Äô);d.textContent=t.label;l.appendChild(d);});}
function checkTasks(){if(Object.keys(G.tasks).every(id=>G.completedTasks[id]))setTimeout(onAllTasksDone,900);}
let onAllTasksDone=()=>{};
function hideTasks(){hideEl(‚ÄòtaskPanel‚Äô);}

// Interactables
function createInteractable(mesh,label,onInteract){
const item={mesh,label,onInteract};
// Glowing orb above the object
const gg=new THREE.Mesh(new THREE.SphereGeometry(0.15,10,10),new THREE.MeshBasicMaterial({color:0xffee55,transparent:true,opacity:0.8}));
gg.position.copy(mesh.position);gg.position.y+=1.85;
item.glowMesh=gg;item.glowMat=gg.material;
// Small cross on top of the orb (sacred marker)
const crx=new THREE.Mesh(new THREE.BoxGeometry(0.04,0.22,0.04),new THREE.MeshBasicMaterial({color:0xffd700}));
crx.position.copy(gg.position);crx.position.y+=0.22;
const crxh=new THREE.Mesh(new THREE.BoxGeometry(0.14,0.04,0.04),new THREE.MeshBasicMaterial({color:0xffd700}));
crxh.position.copy(crx.position);crxh.position.y+=0.05;
addC(gg);addC(crx);addC(crxh);
item._crx=crx;item._crxh=crxh;
G.interactables.push(item);return item;}

// Clear chapter
function clearChapter(){
G.chapterObjects.forEach(o=>scene.remove(o));G.chapterObjects=[];G.interactables=[];G.npcs=[];
G.ourLady=null;G.springWater=null;G._nicheLight=null;G._fireLight=null;G._candleLight=null;
G._springPts=null;G._springPtsPos=null;
G._awaitingSpring=false;G._springTarget=null;G._onSpringArrived=null;
G._awaitingWalk=false;G._walkTarget=null;G._onWalkArrived=null;
[‚ÄòholyGlow‚Äô,‚ÄòspringGlow‚Äô,‚ÄòspringPrompt‚Äô,‚ÄòcommunionPrompt‚Äô,‚ÄòwalkPrompt‚Äô].forEach(hideEl);
[‚ÄòrosaryUI‚Äô,‚ÄòquizUI‚Äô,‚ÄòinterrUI‚Äô,‚ÄòcandleUI‚Äô].forEach(id=>{const el=document.getElementById(id);el.style.display=‚Äònone‚Äô;el.classList.remove(‚Äòshow‚Äô);});
AUDIO.setWind(0);AUDIO.setWater(0);AUDIO.setChurch(0);hideTasks();onAllTasksDone=()=>{};G._walkRadius=2;G.groundFn=null;G._fireflies=null;G._stepT=null;
if(G.player.mesh){G.player.mesh.rotation.x=0;G.player.mesh.rotation.z=0;}
// Reset camera to default follow mode
G.camera.mode=‚Äòfollow‚Äô;G.camera.fov=56;G.camera.focusMesh=null;G.camera.focusWeight=0;
G.camera.pos=null;G.camera.look=null;G.camera.orbitCenter=null;G.camera.orbitSpeed=0;
camera.fov=56;camera.updateProjectionMatrix();}

// Transition
function transitionTo(idx){
const oh=document.getElementById(‚ÄòorientHint‚Äô);if(oh)oh.style.display=‚Äònone‚Äô;
if(G.transitioning)return;G.transitioning=true;G.player.canMove=false;
fadeOut(()=>{G.chapter=idx;const ch=CHAPTERS[idx];scene.clear();clearChapter();
hideEl(‚Äòdialogue‚Äô);hideEl(‚ÄòdialogueDimmer‚Äô);G.dialogueActive=false;
ch.init();fadeIn(()=>{G.transitioning=false;showChapter(ch.title,ch.date);});});}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BERNADETTE ‚Äî 4 VISUAL STAGES
//  0=small child(9-10)  1=teen(14-15)  2=young woman(16-22)  3=nun(22-35)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function createBernadette(stage){
stage=stage||0;
const cfg=[
{s:0.65,hR:0.36,hY:1.52,bH:0.68,lH:0.48,skinC:0xf5d4a8,clothC:0x7a6048,hairC:0x2a1a0a,veilC:0xcfba82,apronC:0xe2d0a8,lW:0.12,chubby:true,label:‚ÄòAge 9 ¬∑ Bartres‚Äô},
{s:0.80,hR:0.32,hY:1.68,bH:0.76,lH:0.60,skinC:0xf0c89a,clothC:0x6b5040,hairC:0x2a1a0a,veilC:0xc8b880,apronC:0xd8c8a0,lW:0.105,chubby:false,label:‚ÄòAge 14 ¬∑ Lourdes 1858‚Äô},
{s:0.90,hR:0.29,hY:1.74,bH:0.80,lH:0.66,skinC:0xeec090,clothC:0x5a4535,hairC:0x2a1a0a,veilC:0xc0b070,apronC:0xd0c098,lW:0.100,chubby:false,label:‚ÄòAge 18-22 ¬∑ After Apparitions‚Äô},
{s:0.90,hR:0.28,hY:1.74,bH:0.80,lH:0.66,skinC:0xe8c4a0,clothC:0xf0ece8,hairC:0x1a1010,veilC:0xf5f0ea,apronC:0xf5f0ea,lW:0.100,chubby:false,label:‚ÄòSister Marie-Bernard ¬∑ Nevers‚Äô,nun:true},
][stage];
const g=new THREE.Group();
const M=c=>new THREE.MeshPhongMaterial({color:c});
// Legs + feet
[-cfg.lW,cfg.lW].forEach(x=>{
const leg=new THREE.Mesh(new THREE.CylinderGeometry(cfg.lW,cfg.lW,cfg.lH,8),M(cfg.clothC));leg.position.set(x,cfg.lH/2,0);leg.castShadow=true;g.add(leg);
const foot=new THREE.Mesh(new THREE.BoxGeometry(0.14,0.09,0.2),M(0x3d2b1f));foot.position.set(x,0.045,0.07);g.add(foot);});
// Body (slightly wider/rounder for child)
const bR=cfg.chubby?0.28:0.24;
const body=new THREE.Mesh(new THREE.CylinderGeometry(bR-0.02,bR+0.03,cfg.bH,10),M(cfg.clothC));
body.position.y=cfg.lH+cfg.bH/2;body.castShadow=true;g.add(body);
// Apron
const apron=new THREE.Mesh(new THREE.BoxGeometry(cfg.chubby?0.38:0.33,cfg.bH*0.62,0.05),M(cfg.apronC));
apron.position.set(0,cfg.lH+cfg.bH*0.44,bR+0.01);g.add(apron);
// Arms
const aH=cfg.chubby?0.50:0.60,aR=cfg.chubby?0.10:0.085;
[[-1,0.32],[1,-0.32]].forEach(([s,rz])=>{
const arm=new THREE.Mesh(new THREE.CylinderGeometry(aR,aR-0.01,aH,8),M(cfg.clothC));
arm.position.set(s*(bR+0.07),cfg.lH+cfg.bH-0.09,0);arm.rotation.z=rz;arm.castShadow=true;g.add(arm);
if(s===-1)g._armL=arm;else g._armR=arm;
const hand=new THREE.Mesh(new THREE.SphereGeometry(aR*1.1,8,8),M(cfg.skinC));
hand.position.set(s*(bR+0.07+Math.sin(Math.abs(rz))*aH*0.48),cfg.lH+cfg.bH-0.09-Math.cos(Math.abs(rz))*aH*0.48,0.09);g.add(hand);});
// Neck
const neck=new THREE.Mesh(new THREE.CylinderGeometry(0.11,0.12,0.16,8),M(cfg.skinC));neck.position.y=cfg.lH+cfg.bH+0.07;g.add(neck);
// Head ‚Äî larger/rounder for child (bigger head-to-body ratio)
const headS=cfg.chubby?1.05:1.08;
const head=new THREE.Mesh(new THREE.SphereGeometry(cfg.hR,16,14),M(cfg.skinC));
head.scale.set(1,headS,1);head.position.y=cfg.hY;head.castShadow=true;g.add(head);g._head=head;
// Chubby cheeks for child
if(cfg.chubby){[-1,1].forEach(s=>{const ch=new THREE.Mesh(new THREE.SphereGeometry(0.11,8,8),new THREE.MeshPhongMaterial({color:0xf0a090,transparent:true,opacity:0.42}));ch.position.set(s*0.22,cfg.hY-0.04,cfg.hR*0.88);g.add(ch);});}
// Hair
const hGeo=new THREE.SphereGeometry(cfg.hR+0.032,12,10,0,Math.PI*2,0,Math.PI*0.62);
const hm=new THREE.Mesh(hGeo,new THREE.MeshPhongMaterial({color:cfg.hairC,side:THREE.BackSide}));hm.position.y=cfg.hY;g.add(hm);
// Eyes ‚Äî bigger/more spaced for child face
const eR=cfg.chubby?0.048:0.040,eSep=cfg.chubby?0.11:0.10;
[-eSep,eSep].forEach(x=>{const e=new THREE.Mesh(new THREE.SphereGeometry(eR,6,6),new THREE.MeshBasicMaterial({color:0x2a1a0a}));e.position.set(x,cfg.hY+(cfg.chubby?0.05:0.07),cfg.hR*0.92);g.add(e);});
// Veil/cap
const veil=new THREE.Mesh(new THREE.ConeGeometry(cfg.hR+0.07,0.17,14,1,true),new THREE.MeshPhongMaterial({color:cfg.veilC,side:THREE.DoubleSide}));
veil.position.y=cfg.hY+(cfg.chubby?0.17:0.20);g.add(veil);
// Nun coif (stage 3)
if(cfg.nun){
const coif=new THREE.Mesh(new THREE.SphereGeometry(cfg.hR+0.04,12,10,0,Math.PI*2,0,Math.PI*0.55),M(0xffffff));coif.position.y=cfg.hY;g.add(coif);
const veilB=new THREE.Mesh(new THREE.PlaneGeometry(0.72,0.9,2,5),new THREE.MeshPhongMaterial({color:0x1a1010,side:THREE.DoubleSide,transparent:true,opacity:0.92}));
veilB.position.set(0,cfg.hY-0.08,0.3);veilB.rotation.x=-0.15;g.add(veilB);}
// Small rosary (always carried)
const rosM=new THREE.MeshPhongMaterial({color:0xb08020,emissive:0x604000,emissiveIntensity:0.38});
for(let i=0;i<7;i++){const a=i/7*Math.PI*1.1-0.55,r=0.14;const b=new THREE.Mesh(new THREE.SphereGeometry(0.020,5,5),rosM);b.position.set(-bR-0.04+Math.sin(a)*r,cfg.lH+cfg.bH-0.28+Math.cos(a)*r*0.6,0.1);g.add(b);}
g.traverse(m=>{if(m.isMesh){m.castShadow=true;m.receiveShadow=true;}});
g._walkT=0;g._stage=stage;g.scale.setScalar(cfg.s);
return g;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OUR LADY OF LOURDES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function createOurLady(){
const g=new THREE.Group();
const M=(c,em,ei,t,o)=>new THREE.MeshPhongMaterial({color:c,emissive:em||0,emissiveIntensity:ei||0,transparent:!!t,opacity:o||1});
g.add(pm(new THREE.Mesh(new THREE.CylinderGeometry(0.06,0.58,1.85,16),M(0xffffff,0x8888ff,0.42,true,0.96)),0,1.12,0));
const sash=new THREE.Mesh(new THREE.TorusGeometry(0.29,0.048,8,26),M(0x4488dd,0x2244aa,0.55));sash.position.y=1.38;sash.rotation.x=Math.PI/2;g.add(sash);
g.add(pm(new THREE.Mesh(new THREE.CylinderGeometry(0.22,0.26,0.76,12),M(0xffffff,0x9999ff,0.52)),0,1.72,0));
const head=new THREE.Mesh(new THREE.SphereGeometry(0.30,16,14),M(0xfff5f0,0xaaaaff,0.42));head.scale.y=1.12;head.position.y=2.22;g.add(head);
const veil=new THREE.Mesh(new THREE.ConeGeometry(0.40,0.26,16,1,true),M(0xffffff,0x9999ff,0.42,true,0.92));veil.position.y=2.48;g.add(veil);
const veilB=new THREE.Mesh(new THREE.PlaneGeometry(0.72,1.05,3,8),M(0xffffff,0x8888ff,0.32,true,0.90));veilB.position.set(0,2.02,0.28);veilB.rotation.x=-0.18;g.add(veilB);
[{x:-0.08},{x:0.08}].forEach(({x})=>{const h=new THREE.Mesh(new THREE.SphereGeometry(0.09,8,8),M(0xfff5f0,0xaaaaff,0.32));h.position.set(x,1.87,0.30);g.add(h);});
const rosM=new THREE.MeshPhongMaterial({color:0xf0d060,emissive:0xffaa00,emissiveIntensity:0.65});
for(let i=0;i<13;i++){const a=i/13*Math.PI*1.3-0.65,r=0.23;const b=new THREE.Mesh(new THREE.SphereGeometry(0.027,6,6),rosM);b.position.set(Math.sin(a)*r+0.08,1.66+Math.cos(a)*r*0.52,0.27);g.add(b);}
const roseM=new THREE.MeshPhongMaterial({color:0xffdd00,emissive:0xffaa00,emissiveIntensity:0.85});
[-0.19,0.19].forEach(x=>{for(let i=0;i<5;i++){const a=i/5*Math.PI*2;const p=new THREE.Mesh(new THREE.SphereGeometry(0.045,6,6),roseM);p.position.set(x+Math.cos(a)*0.06,0.08,0.12+Math.sin(a)*0.04);g.add(p);}});
const eM=new THREE.MeshBasicMaterial({color:0x1a1040});[-0.10,0.10].forEach(x=>{const e=new THREE.Mesh(new THREE.SphereGeometry(0.034,8,8),eM);e.position.set(x,2.24,0.28);g.add(e);});
const il=new THREE.PointLight(0xaabbff,3,9);il.position.set(0,2,0);g.add(il);g._iL=il;
const ol=new THREE.PointLight(0xffffff,2,16);ol.position.set(0,1.5,0);g.add(ol);g._oL=ol;
const halo=new THREE.Mesh(new THREE.TorusGeometry(0.52,0.024,8,42),new THREE.MeshBasicMaterial({color:0xffffaa}));halo.position.y=2.64;halo.rotation.x=Math.PI/2;g.add(halo);g._halo=halo;
const pN=320,pGeo=new THREE.BufferGeometry(),pPos=new Float32Array(pN*3),pCol=new Float32Array(pN*3);
for(let i=0;i<pN;i++){const a=Math.random()*Math.PI*2,r=0.5+Math.random()*2.6,h=Math.random()*3.2;
pPos[i*3]=Math.cos(a)*r;pPos[i*3+1]=h;pPos[i*3+2]=Math.sin(a)*r;
pCol[i*3]=0.9+Math.random()*0.1;pCol[i*3+1]=0.88+Math.random()*0.12;pCol[i*3+2]=0.65+Math.random()*0.35;}
pGeo.setAttribute(‚Äòposition‚Äô,new THREE.BufferAttribute(pPos,3));pGeo.setAttribute(‚Äòcolor‚Äô,new THREE.BufferAttribute(pCol,3));
const pts=new THREE.Points(pGeo,new THREE.PointsMaterial({size:0.042,vertexColors:true,transparent:true,opacity:0.92,sizeAttenuation:true}));
g.add(pts);g._pts=pts;g._pPos=pPos;g._pN=pN;
g.traverse(m=>{if(m.isMesh)m.castShadow=true;});
return g;
}
function animOurLady(l,t){if(!l)return;
l.position.y=Math.sin(t*0.78)*0.13+0.15;
if(l._halo)l._halo.rotation.z=t*0.48;
if(l._iL)l._iL.intensity=2.2+Math.sin(t*1.9)*1.1;if(l._oL)l._oL.intensity=1.4+Math.sin(t*1.3)*0.85;
if(l._pPos){const pos=l._pts.geometry.attributes.position.array;for(let i=0;i<l._pN;i++){const a=Math.atan2(pos[i*3+2],pos[i*3])+0.008,r=Math.sqrt(pos[i*3]*pos[i*3]+pos[i*3+2]*pos[i*3+2]);pos[i*3]=Math.cos(a)*r;pos[i*3+2]=Math.sin(a)*r;pos[i*3+1]+=(Math.random()-0.5)*0.012;if(pos[i*3+1]>3.2)pos[i*3+1]=0;if(pos[i*3+1]<0)pos[i*3+1]=2.5;}l._pts.geometry.attributes.position.needsUpdate=true;}}

// Walk animation ‚Äî expressive character movement
function animWalk(c,dt,walking){
if(!c||!c._armL)return;
c._walkT=(c._walkT||0)+(walking?dt*3.2:0);
const sw=Math.sin(c._walkT),cw=Math.cos(c._walkT);
// Arms swing opposite to legs
c._armL.rotation.x=walking?sw*0.45:c._armL.rotation.x*0.85;
c._armR.rotation.x=walking?-sw*0.45:c._armR.rotation.x*0.85;
// Slight body lean forward when walking
if(c._armL)c._armL.rotation.z=walking?0.32+Math.abs(sw)*0.05:0.32;
if(c._armR)c._armR.rotation.z=walking?-0.32-Math.abs(sw)*0.05:-0.32;
// Head bob gently while walking ‚Äî subtle, devout
if(c._head){
c._head.rotation.x=walking?Math.abs(cw)*0.04:c._head.rotation.x*0.9;
c._head.rotation.z=walking?sw*0.015:c._head.rotation.z*0.9;
}
// Slight vertical bounce stored separately ‚Äî avoids fighting terrain snap
if(walking){c._bounceY=(c._bounceY||0);c._bounceY=Math.abs(sw)*0.015;}
}

// Generic NPC builder
function mkChar(skin,cloth,hair,opts){
const g=new THREE.Group(),M=c=>new THREE.MeshPhongMaterial({color:c});
const lh=opts.lh||0.62,bh=opts.bh||0.78,hr=opts.hr||0.30;
[-0.13,0.13].forEach(x=>{const leg=new THREE.Mesh(new THREE.CylinderGeometry(0.1,0.1,lh,8),M(cloth));leg.position.set(x,lh/2,0);leg.castShadow=true;g.add(leg);const foot=new THREE.Mesh(new THREE.BoxGeometry(0.13,0.09,0.19),M(0x3d2b1f));foot.position.set(x,0.045,0.055);g.add(foot);});
const body=new THREE.Mesh(new THREE.CylinderGeometry(0.23,0.26,bh,10),M(cloth));body.position.y=lh+bh/2;body.castShadow=true;g.add(body);
if(opts.apron){const ap=new THREE.Mesh(new THREE.BoxGeometry(0.33,bh*0.6,0.05),M(opts.apronC||0xe8d5b0));ap.position.set(0,lh+bh*0.44,0.27);g.add(ap);}
if(opts.cassock){const ca=new THREE.Mesh(new THREE.CylinderGeometry(0.30,0.42,lh+bh+0.06,12),M(0x080812));ca.position.y=(lh+bh)/2;g.add(ca);}
[[-1,0.30],[1,-0.30]].forEach(([s,rz])=>{const arm=new THREE.Mesh(new THREE.CylinderGeometry(0.09,0.075,0.60,8),M(cloth));arm.position.set(s*0.35,lh+bh-0.10,0);arm.rotation.z=rz;arm.castShadow=true;g.add(arm);if(s===-1)g._armL=arm;else g._armR=arm;const h=new THREE.Mesh(new THREE.SphereGeometry(0.10,8,8),M(skin));h.position.set(s*0.48,lh+bh-0.42,0.10);g.add(h);});
const neck=new THREE.Mesh(new THREE.CylinderGeometry(0.11,0.12,0.16,8),M(skin));neck.position.y=lh+bh+0.07;g.add(neck);
const head=new THREE.Mesh(new THREE.SphereGeometry(hr,14,12),M(skin));head.scale.y=1.1;head.position.y=lh+bh+0.18+hr;head.castShadow=true;g.add(head);g._head=head;
const hm=new THREE.Mesh(new THREE.SphereGeometry(hr+0.03,12,10,0,Math.PI*2,0,Math.PI*0.62),new THREE.MeshPhongMaterial({color:hair,side:THREE.BackSide}));hm.position.y=lh+bh+0.18+hr;g.add(hm);
const eM=new THREE.MeshBasicMaterial({color:0x2a1a0a});[-0.09,0.09].forEach(x=>{const e=new THREE.Mesh(new THREE.SphereGeometry(0.04,6,6),eM);e.position.set(x,lh+bh+0.24+hr,hr*0.93);g.add(e);});
if(opts.veil){const v=new THREE.Mesh(new THREE.ConeGeometry(hr+0.07,0.17,12,1,true),new THREE.MeshPhongMaterial({color:opts.veilC||0xd4c090,side:THREE.DoubleSide}));v.position.y=lh+bh+0.20+hr*2;g.add(v);}
g.traverse(m=>{if(m.isMesh){m.castShadow=true;m.receiveShadow=true;}});g._walkT=0;return g;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCENE BUILDERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TERRAIN HEIGHT SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Pure math height function ‚Äî identical to geometry generation.
// Chapters can override G.groundFn for flat/indoor scenes.
function rawTerrain(x,z){
// Pyrenean valley: flat central path, river valley at x‚âà9
const pathFactor=Math.max(0,1-Math.abs(x)*0.16);      // pilgrim road, center flat
const riverFactor=Math.max(0,1-Math.abs(x-9)*0.18);   // Gave de Pau river channel
let h=Math.sin(x*0.072)*2.2+Math.cos(z*0.058)*1.8
+Math.sin(x*0.14+z*0.11)*1.1+Math.cos(x*0.21-z*0.19)*0.55
+Math.sin(z*0.08)*0.9+Math.cos(x*0.09)*0.7;
h*=(1-pathFactor*0.90);        // flatten pilgrim corridor
h-=riverFactor*3.8;            // carve river valley ‚Äî terrain drops toward river
h=Math.max(h,-0.5);            // floor at -0.5 (river bed)
return h;
}
function sampleGround(x,z){
if(G.groundFn)return G.groundFn(x,z);
return 0; // default flat
}

// Stars ‚Äî Milky Way style with colour variation
function mkStars(){
const g=new THREE.BufferGeometry(),n=3200,p=new Float32Array(n*3),c=new Float32Array(n*3);
for(let i=0;i<n;i++){
const phi=Math.acos(2*Math.random()-1),theta=Math.random()*Math.PI*2,r=80+Math.random()*220;
p[i*3]=r*Math.sin(phi)*Math.cos(theta);p[i*3+1]=Math.abs(r*Math.cos(phi))+30;p[i*3+2]=r*Math.sin(phi)*Math.sin(theta);
// Star colours: white, blue-white, warm yellow
const t=Math.random();
c[i*3]=t<0.3?0.78:t<0.6?1:1;c[i*3+1]=t<0.3?0.84:t<0.6?0.97:0.92;c[i*3+2]=t<0.3?1:t<0.6?0.88:0.72;
}
g.setAttribute(‚Äòposition‚Äô,new THREE.BufferAttribute(p,3));g.setAttribute(‚Äòcolor‚Äô,new THREE.BufferAttribute(c,3));
return new THREE.Points(g,new THREE.PointsMaterial({size:0.28,vertexColors:true,transparent:true,opacity:0.88,sizeAttenuation:true}));
}

// Beautiful terrain with vertex colours (grass/path/rock) and walkable hills
function mkTerrain(opts){
opts=opts||{};
const res=opts.res||80;
const geo=new THREE.PlaneGeometry(220,220,res,res);
geo.rotateX(-Math.PI/2);
const pos=geo.attributes.position;
const col=new Float32Array(pos.count*3);

// Season colours: spring=green, winter=muted
const season=opts.season||‚Äòspring‚Äô;
const grassC=season===‚Äòwinter‚Äô?[0.42,0.46,0.35]:[0.26,0.50,0.18];
const pathC=[0.56,0.48,0.36];
const rockC=[0.48,0.44,0.40];
const mudC=[0.40,0.30,0.22];

for(let i=0;i<pos.count;i++){
const x=pos.getX(i),z=pos.getZ(i);
const h=rawTerrain(x,z);
pos.setY(i,h);
// Path corridor down center (historical Chemin de Massabielle)
const pathW=Math.max(0,1-Math.abs(x)*0.13);
// Riverside path (x around 6-10)
const riverPath=Math.max(0,1-Math.abs(x-8)*0.18);
const onPath=Math.max(pathW,riverPath);
// Steepness ‚Üí rock colour
const steep=Math.abs(h)>2.5?1:0;
let r,g2,b;
if(onPath>0.5){r=pathC[0]+(mudC[0]-pathC[0])*(1-onPath);g2=pathC[1];b=pathC[2];}
else if(steep){r=rockC[0];g2=rockC[1];b=rockC[2];}
else{const t=Math.min(1,h*0.25+0.5);r=grassC[0]*t;g2=grassC[1]*t;b=grassC[2]*t;}
col[i*3]=r;col[i*3+1]=g2;col[i*3+2]=b;
}
geo.setAttribute(‚Äòcolor‚Äô,new THREE.BufferAttribute(col,3));
geo.computeVertexNormals();
const mat=new THREE.MeshPhongMaterial({vertexColors:true,shininess:3,specular:0x223311});
const m=new THREE.Mesh(geo,mat);m.receiveShadow=true;
return m;
}

// Pyrenean mountain range ‚Äî historically accurate for Lourdes geography
function mkMountains(){
const g=new THREE.Group();
// Pic du Jer, Pic de Pibeste and surrounding Pyrenean peaks visible from Lourdes
const peaks=[
{x:-55,z:-90,h:68,r:26,name:‚ÄòPic du Jer‚Äô},{x:-28,z:-96,h:52,r:19},{x:18,z:-88,h:74,r:30},
{x:55,z:-80,h:44,r:17},{x:38,z:-108,h:82,r:32},{x:-48,z:-112,h:72,r:27},
{x:72,z:-102,h:36,r:14},{x:-72,z:-78,h:58,r:21},{x:8,z:-118,h:60,r:22},
{x:-15,z:-78,h:38,r:15},{x:90,z:-110,h:50,r:20},{x:-88,z:-96,h:55,r:22},
];
peaks.forEach(p=>{
// Base rock body ‚Äî layered with two overlapping cones for organic look
const rockC=new THREE.Color(0.52+Math.random()*0.06,0.49+Math.random()*0.05,0.44+Math.random()*0.04);
const base=new THREE.Mesh(new THREE.ConeGeometry(p.r,p.h,12),new THREE.MeshPhongMaterial({color:rockC}));
base.position.set(p.x,p.h/2-4,p.z);base.castShadow=true;g.add(base);
// Mid slope darker
const mid=new THREE.Mesh(new THREE.ConeGeometry(p.r*0.65,p.h*0.55,10),new THREE.MeshPhongMaterial({color:new THREE.Color(0.38,0.36,0.32)}));
mid.position.set(p.x,p.h*0.55,p.z);g.add(mid);
// Snow cap ‚Äî Pyrenean peaks are snow-capped in winter/spring
const snow=new THREE.Mesh(new THREE.ConeGeometry(p.r*0.24,p.h*0.20,9),new THREE.MeshPhongMaterial({color:0xf8f8ff,shininess:40}));
snow.position.set(p.x,p.h*0.90,p.z);g.add(snow);
// Snow line fringe
const fringe=new THREE.Mesh(new THREE.ConeGeometry(p.r*0.38,p.h*0.08,9,1,true),new THREE.MeshPhongMaterial({color:0xeeeeee,side:THREE.DoubleSide,transparent:true,opacity:0.8}));
fringe.position.set(p.x,p.h*0.75,p.z);g.add(fringe);
});
// Rolling foothills
for(let i=0;i<18;i++){
const hx=rand(-100,100),hz=rand(-60,-40),hr=rand(6,18),hh=rand(4,12);
const hill=new THREE.Mesh(new THREE.SphereGeometry(hr,10,8),new THREE.MeshPhongMaterial({color:new THREE.Color(0.28+Math.random()*0.08,0.38+Math.random()*0.1,0.18+Math.random()*0.06)}));
hill.scale.y=hh/hr*0.6;hill.position.set(hx,hh*0.3,hz);hill.receiveShadow=true;g.add(hill);
}
return g;
}

// Water with realistic vertex wave simulation
function mkWater(w,d,col,opts){
col=col||0x2255aa;opts=opts||{};
// Higher resolution for waves
const segments=Math.max(20,Math.ceil((w+d)*3));
const geo=new THREE.PlaneGeometry(w,d,segments,segments);geo.rotateX(-Math.PI/2);
// Store base positions for wave animation
const basePos=new Float32Array(geo.attributes.position.array);
const mat=new THREE.MeshPhongMaterial({
color:col,transparent:true,opacity:opts.opacity||0.80,
shininess:240,specular:0xaaddff,
emissive:new THREE.Color(col).multiplyScalar(0.06),
emissiveIntensity:0.4,
});
const m=new THREE.Mesh(geo,mat);
m._wT=0;m._wBase=basePos;m._wPhase=Math.random()*Math.PI*2;
m._isWater=true;m.receiveShadow=false;return m;
}
function animWater(w,dt){
if(!w)return;w._wT=(w._wT||0)+dt;
const p=w.geometry.attributes.position;
const ph=w._wPhase||0;
const t=w._wT;
const isSpring=w._isSpring; // smaller waves for the spring
const amp=isSpring?0.022:0.055;
for(let i=0;i<p.count;i++){
const x=p.getX(i),z=p.getZ(i);
// Three overlapping wave frequencies for natural look
const y=Math.sin(x*1.1+t*1.7+ph)*amp
+Math.sin(z*0.85+t*1.35+ph*0.6)*amp*0.7
+Math.sin((x-z)*0.55+t*2.3+ph*1.3)*amp*0.4;
p.setY(i,y);
}
p.needsUpdate=true;w.geometry.computeVertexNormals();
// Subtle colour oscillation ‚Äî light/dark ripples
if(w.material&&w._col){
const pulse=0.92+Math.sin(t*2.1+ph)*0.08;
w.material.opacity=Math.min(0.95,(w.material.opacity||0.8)*0.96+0.04)*pulse;
}
}

// Trees that follow terrain height, with path avoidance
function mkTrees(count,xRange,zRange,pathFn){
for(let i=0;i<count;i++){
let x,z,tries=0;
do{x=rand(-xRange,xRange);z=rand(-zRange.max,-(zRange.min||0));tries++;}
while(tries<12&&pathFn&&pathFn(x,z));
const gy=G.groundFn?G.groundFn(x,z):0;
const h=rand(3.0,6.5),species=Math.random();
if(species<0.55){
// Oak/chestnut ‚Äî common in Pyrenean foothills
const trunkH=h*0.55,trunkR=rand(0.13,0.20);
const tr=new THREE.Mesh(new THREE.CylinderGeometry(trunkR*0.7,trunkR,trunkH,8),new THREE.MeshPhongMaterial({color:new THREE.Color(0.28+Math.random()*0.06,0.20+Math.random()*0.04,0.12)}));
tr.position.set(x,gy+trunkH/2,z);tr.castShadow=true;addC(tr);
// Layered canopy
for(let c=0;c<3;c++){
const cy=gy+trunkH+c*rand(0.6,1.0),cr=rand(1.2,2.2)-c*0.35;
const fo=new THREE.Mesh(new THREE.SphereGeometry(cr,8,7),new THREE.MeshPhongMaterial({color:new THREE.Color(0.10+Math.random()*0.10,0.34+Math.random()*0.18,0.06+Math.random()*0.04)}));
fo.position.set(x+rand(-0.3,0.3),cy,z+rand(-0.3,0.3));fo.castShadow=true;addC(fo);
}
}else if(species<0.80){
// Pine ‚Äî Pyrenean conifer
const tr=new THREE.Mesh(new THREE.CylinderGeometry(0.10,0.16,h*0.6,7),new THREE.MeshPhongMaterial({color:0x4a2e1a}));
tr.position.set(x,gy+h*0.3,z);tr.castShadow=true;addC(tr);
for(let t=0;t<3;t++){const ty=gy+h*0.3+t*h*0.24,tr2=rand(0.9,1.9)-t*0.4;
const fo=new THREE.Mesh(new THREE.ConeGeometry(tr2,h*0.38-t*0.1,8),new THREE.MeshPhongMaterial({color:new THREE.Color(0.06,0.28+Math.random()*0.08,0.08)}));fo.position.set(x,ty,z);fo.castShadow=true;addC(fo);}
}else{
// Willow/ash near water ‚Äî slender
const tr=new THREE.Mesh(new THREE.CylinderGeometry(0.08,0.12,h*0.70,7),new THREE.MeshPhongMaterial({color:0x5a3e28}));
tr.position.set(x,gy+h*0.35,z);addC(tr);
const fo=new THREE.Mesh(new THREE.SphereGeometry(rand(1.0,1.6),8,6),new THREE.MeshPhongMaterial({color:new THREE.Color(0.18+Math.random()*0.08,0.42+Math.random()*0.14,0.10)}));
fo.scale.y=1.4;fo.position.set(x,gy+h*0.75,z);addC(fo);
}
}
}

// Scatter rocks naturally on terrain
function mkRocks(count,xRange,zRange,pathFn){
for(let i=0;i<count;i++){
let x,z,tries=0;
do{x=rand(-xRange,xRange);z=rand(-zRange.max,-(zRange.min||0));tries++;}
while(tries<8&&pathFn&&pathFn(x,z));
const gy=G.groundFn?G.groundFn(x,z):0;
const s=rand(0.2,0.8);
const r=new THREE.Mesh(new THREE.SphereGeometry(s,7,6),new THREE.MeshPhongMaterial({color:new THREE.Color(0.44+rand(0,0.08),0.40+rand(0,0.06),0.36+rand(0,0.05))}));
r.scale.set(1+rand(-0.3,0.3),0.55+rand(0,0.3),1+rand(-0.3,0.3));
r.position.set(x,gy+s*0.2,z);r.castShadow=true;r.receiveShadow=true;addC(r);
}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MASSABIELLE GROTTO ‚Äî historically accurate
// The actual Grotte de Massabielle: a cave hollowed by the Gave de Pau river,
// 18m high cliff, niche 5m above ground, wild rosebush, canal spring.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildGrotto(opts){
opts=opts||{};
G.groundFn=null; // grotto is flat
const sky=opts.sky||0x0a0f1e;
const isDay=opts.day||false;
const dayCol=isDay?0x2a3a5a:sky;
scene.background=new THREE.Color(dayCol);
scene.fog=new THREE.Fog(dayCol,22,110);

// Lighting ‚Äî atmospheric, historically respectful
if(isDay){
addC(new THREE.AmbientLight(0x7a92b8,0.65));
const sun=new THREE.DirectionalLight(0xfff5d8,1.2);sun.position.set(22,48,18);
sun.castShadow=true;sun.shadow.mapSize.width=1024;sun.shadow.mapSize.height=1024;
sun.shadow.camera.near=0.5;sun.shadow.camera.far=120;sun.shadow.camera.left=-30;sun.shadow.camera.right=30;sun.shadow.camera.top=30;sun.shadow.camera.bottom=-30;
addC(sun);
}else{
addC(new THREE.AmbientLight(0x182030,0.48));
const moon=new THREE.DirectionalLight(0x7888aa,0.38);moon.position.set(-18,32,12);addC(moon);
addC(mkStars());
}

// ‚îÄ‚îÄ GROUND ‚îÄ‚îÄ Gave riverbank: flat sandy limestone floor, historically the
// bank of the Gave de Pau before the shrine was built
const gndM=new THREE.MeshPhongMaterial({color:0x7a6a50,shininess:3});
const gnd=new THREE.Mesh(new THREE.PlaneGeometry(44,44,1,1),gndM);
gnd.rotation.x=-Math.PI/2;gnd.receiveShadow=true;addC(gnd);

// ‚îÄ‚îÄ CLIFF FACE ‚Äî Massabielle: pale grey-beige limestone, overhanging
function rock(sx,sy,sz,x,y,z,c){
const col=c||new THREE.Color(0.44+rand(0,0.07),0.40+rand(0,0.05),0.34+rand(0,0.04));
const m=new THREE.Mesh(new THREE.SphereGeometry(1,10,8),new THREE.MeshPhongMaterial({color:col,shininess:6}));
m.scale.set(sx,sy,sz);m.position.set(x,y,z);m.castShadow=true;m.receiveShadow=true;addC(m);
}
// The enormous main cliff ‚Äî runs from left to right, 18m high at center
rock(18,12,7,0,7,-15.5);        // central cliff mass
rock(12,10,6,-10,5,-13.5);      // left wing
rock(10,9,5.5,10,4.5,-13);      // right wing
rock(20,4.5,7.5,0,0.5,-16.5);   // base shelf
rock(7,14,4.5,-14,7,-12);       // far left pillar
rock(6,12,4,13,5.5,-11.5);      // far right pillar
// Overhang ‚Äî the cave ceiling sweeping forward
rock(16,3.5,9,0,11.5,-12);      // overhang ceiling
rock(10,2.8,6,-8,10,-11);
rock(8,2.5,5,9,9,-10.5);
// Cave interior depth ‚Äî darker rocks receding
rock(8,6,3.5,0,4,-18,new THREE.Color(0.22,0.20,0.18));
rock(5,5,3,-5,3,-17.5,new THREE.Color(0.22,0.20,0.18));
rock(5,5,3,5,3,-17.5,new THREE.Color(0.22,0.20,0.18));
// Additional surface texture rocks
for(let i=0;i<18;i++){
const rx=rand(-15,15),rz=rand(-16,-10),rsx=rand(0.5,2.5),rsy=rand(0.4,1.8),rsz=rand(0.4,1.5);
rock(rsx,rsy,rsz,rx,rand(-0.5,2),rz);
}

// ‚îÄ‚îÄ NICHE OF THE APPARITION ‚îÄ‚îÄ 5m above ground, elliptical hollow
// Historically: a natural hollow in the rock, 2.5m wide, 1.5m deep
const nicheGeo=new THREE.SphereGeometry(2.6,16,12);
const niche=new THREE.Mesh(nicheGeo,new THREE.MeshPhongMaterial({color:0x18160e,side:THREE.BackSide}));
niche.scale.set(1.1,1.6,0.68);niche.position.set(0,5.2,-13.2);addC(niche);
// Niche rim ‚Äî lighter limestone edge catching light
const nicheRim=new THREE.Mesh(new THREE.TorusGeometry(2.2,0.28,8,22),new THREE.MeshPhongMaterial({color:0x8a7a60}));
nicheRim.position.set(0,5.2,-12.2);nicheRim.scale.set(1,1.5,0.2);nicheRim.rotation.z=0.04;addC(nicheRim);

// ‚îÄ‚îÄ WILD ROSEBUSH (Eglantier) ‚Äî Rosa canina, growing from crack in rock
// This exact rosebush exists today ‚Äî pilgrims touch it
function addRoseBush(cx,cz,baseY){
for(let i=0;i<22;i++){
const a=rand(0,Math.PI*2),r=rand(0.25,1.6),y=baseY+rand(0,0.9);
const stem=new THREE.Mesh(new THREE.CylinderGeometry(0.016,0.022,rand(0.4,1.1),4),new THREE.MeshPhongMaterial({color:0x2a4a1a}));
stem.position.set(cx+Math.cos(a)*r,y,-12.0+Math.sin(a)*0.35);stem.rotation.z=rand(-0.5,0.5);addC(stem);
// Leaves ‚Äî small olive-green clusters
for(let j=0;j<3;j++){
const lf=new THREE.Mesh(new THREE.SphereGeometry(0.10+rand(0,0.06),5,5),new THREE.MeshPhongMaterial({color:new THREE.Color(0.15+rand(0,0.08),0.38+rand(0,0.12),0.10)}));
lf.position.set(cx+Math.cos(a)*r+rand(-0.15,0.15),y+rand(0.1,0.4),-12.0+Math.sin(a)*0.35);lf.scale.set(1.4,0.7,1);addC(lf);
}
// Pink roses ‚Äî Rosa canina has pale pink blossoms in summer, hips in autumn
if(Math.random()<0.3){
const rose=new THREE.Mesh(new THREE.SphereGeometry(0.12,6,6),new THREE.MeshPhongMaterial({color:0xffb8c0}));
rose.position.set(cx+Math.cos(a)*r,y+0.5,-12.0+Math.sin(a)*0.35);addC(rose);
}
}
}
addRoseBush(-0.5,0,3.3); // primary bush ‚Äî right edge of niche
addRoseBush(0.8,0,3.6);  // secondary

// ‚îÄ‚îÄ GAVE CANAL (Gave de Pau) ‚Äî ran at foot of grotto, diverted after 1862
const canal=mkWater(5,28,0x1a3a6a);canal.position.set(-1,0.06,-1.5);addC(canal);G.springWater=canal;
// Canal banks ‚Äî smooth river pebbles
for(let i=0;i<40;i++){
const px=rand(-10,10),pz=rand(0.5,8),ps=rand(0.08,0.25);
const peb=new THREE.Mesh(new THREE.SphereGeometry(ps,6,5),new THREE.MeshPhongMaterial({color:new THREE.Color(0.52+rand(0,0.1),0.48+rand(0,0.08),0.42+rand(0,0.07))}));
peb.scale.y=0.45;peb.position.set(px,ps*0.2,pz);addC(peb);
}

// ‚îÄ‚îÄ TORCHES AND CANDLES ‚Äî crowd candles at grotto (from 2nd apparition onward)
if(opts.candles){
for(let i=0;i<30;i++){
const cx=rand(-8,8),cz=rand(-2,5);
const cnd=new THREE.Mesh(new THREE.CylinderGeometry(0.04,0.04,0.3,6),new THREE.MeshPhongMaterial({color:0xf0e8d0}));
cnd.position.set(cx,0.15,cz);addC(cnd);
const fl=new THREE.PointLight(0xffaa44,rand(0.6,1.4),rand(2,4));fl.position.set(cx,0.52,cz);addC(fl);
}
}

// ‚îÄ‚îÄ PILGRIM LANTERNS ‚Äî historically pilgrims brought torches
if(opts.pilgrims){
for(let i=0;i<5;i++){
const lx=rand(-6,6),lz=rand(1,7);
const ln=new THREE.PointLight(0xff8833,rand(0.8,1.6),rand(3,6));ln.position.set(lx,1.5,lz);addC(ln);
}
}

// ‚îÄ‚îÄ FLANKING POPLARS ‚Äî the great poplars lining the Gave
[[-8.5,-4],[8.5,-4],[-11,-8],[11,-7],[-14,-12],[13,-11]].forEach(([px,pz])=>{
const h=rand(7,12);
const tr=new THREE.Mesh(new THREE.CylinderGeometry(0.16,0.20,h,7),new THREE.MeshPhongMaterial({color:0x3a2418}));
tr.position.set(px,h/2,pz);tr.castShadow=true;addC(tr);
// Poplar canopy ‚Äî narrow and tall (distinctive shape)
const cr=new THREE.Mesh(new THREE.CylinderGeometry(0.5,1.2,h*0.65,8),new THREE.MeshPhongMaterial({color:new THREE.Color(0.10,0.30+rand(0,0.10),0.08)}));
cr.position.set(px,h*0.72,pz);cr.castShadow=true;addC(cr);
});

// ‚îÄ‚îÄ NICHE LIGHT ‚îÄ‚îÄ
if(opts.nicheLight){
const nl=new THREE.PointLight(0xeeeeff,0,14);nl.position.set(0,5.5,-12);addC(nl);G._nicheLight=nl;
}

// ‚îÄ‚îÄ MIST ‚Äî Pyrenean morning mist rises from the Gave
if(opts.mist){
for(let i=0;i<8;i++){
const mp=new THREE.Mesh(new THREE.SphereGeometry(rand(2,4),6,5),new THREE.MeshBasicMaterial({color:0xaabbcc,transparent:true,opacity:0.06+rand(0,0.05)}));
mp.position.set(rand(-8,8),rand(0.3,1.5),rand(-4,4));addC(mp);
}
}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TERRAIN PLACEMENT HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Snap any mesh/group‚Äôs Y to terrain + optional height offset
function snapY(mesh, offsetY){
if(!mesh)return;
const p=mesh.position;
p.y=sampleGround(p.x,p.z)+(offsetY||0);
}
// Snap multiple meshes ‚Äî call after placing all objects in a chapter
function snapAll(meshes, offsetY){meshes.forEach(m=>snapY(m,offsetY));}
// Snap NPC to terrain, optionally tilt on slope
function snapNPC(npc){
if(!npc||!npc.position)return;
const gx=sampleGround(npc.position.x,npc.position.z);
npc.position.y=gx;
// Gentle slope tilt
if(G.groundFn){
const sx=sampleGround(npc.position.x+0.4,npc.position.z)-sampleGround(npc.position.x-0.4,npc.position.z);
const sz=sampleGround(npc.position.x,npc.position.z+0.4)-sampleGround(npc.position.x,npc.position.z-0.4);
npc.rotation.x=sz*(-0.12);npc.rotation.z=sx*0.10;
}
}
// After every chapter init that uses terrain, call this to snap all registered NPCs
function snapAllNPCs(){G.npcs.forEach(snapNPC);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ Ambient birds for outdoor scenes (simple arcing particles) ‚îÄ‚îÄ
function addBirds(scene_or_group){
const g=scene_or_group||scene;
const bGeo=new THREE.BufferGeometry();
const n=12;const pos=new Float32Array(n*3);const vel=[];
for(let i=0;i<n;i++){
pos[i*3]=rand(-40,40);pos[i*3+1]=rand(18,35);pos[i*3+2]=rand(-50,-5);
vel.push({x:rand(0.4,1.2)*(Math.random()<0.5?1:-1),y:rand(-0.2,0.2),z:rand(-0.2,0.2)});
}
bGeo.setAttribute(‚Äòposition‚Äô,new THREE.BufferAttribute(pos,3));
const bPts=new THREE.Points(bGeo,new THREE.PointsMaterial({color:0x1a1a18,size:0.25}));
bPts._vel=vel;bPts._pos=pos;bPts._n=n;bPts._isBirds=true;
addC(bPts);return bPts;
}
function animBirds(b,dt){
if(!b||!b._isBirds)return;
const pos=b._pos;
for(let i=0;i<b._n;i++){
const v=b._vel[i];
pos[i*3]+=v.x*dt*6;
pos[i*3+1]+=Math.sin(G.time*2.1+i*0.8)*0.04;
if(pos[i*3]>50)pos[i*3]=-50;
if(pos[i*3]<-50)pos[i*3]=50;
}
b.geometry.attributes.position.array.set(pos);
b.geometry.attributes.position.needsUpdate=true;
}

// Add atmospheric fireflies/sprite particles to grotto scenes
function addFireflies(count,area){
const n=count||20,geo=new THREE.BufferGeometry(),pos=new Float32Array(n*3);
for(let i=0;i<n;i++){pos[i*3]=rand(-area,area);pos[i*3+1]=rand(0.5,4);pos[i*3+2]=rand(-area,area);}
geo.setAttribute(‚Äòposition‚Äô,new THREE.BufferAttribute(pos,3));
const mat=new THREE.PointsMaterial({color:0xaaffaa,size:0.12,transparent:true,opacity:0.7,sizeAttenuation:true});
const pts=new THREE.Points(geo,mat);addC(pts);G._fireflies=pts;
}

function buildCachot(){
scene.background=new THREE.Color(0x08060f);scene.fog=new THREE.Fog(0x08060f,12,55);
const M=c=>new THREE.MeshPhongMaterial({color:c});
G.groundFn=null; // cachot is flat
// Cobblestone floor ‚Äî the actual Cachot had rough stone floor
const gnd=new THREE.Mesh(new THREE.PlaneGeometry(12,14),new THREE.MeshPhongMaterial({color:0x504030,shininess:2}));
gnd.rotation.x=-Math.PI/2;gnd.receiveShadow=true;addC(gnd);
// Stone floor texture via small raised squares
for(let bx=-5;bx<5;bx+=0.8){for(let bz=-6;bz<7;bz+=0.8){
const s=new THREE.Mesh(new THREE.BoxGeometry(0.72,0.04,0.72),M(0x4a3a28+Math.floor(rand(0,0x101010))));
s.position.set(bx+rand(-0.05,0.05),0.02,bz+rand(-0.05,0.05));s.receiveShadow=true;addC(s);
}}
function wall(w,h,d,x,y,z){const m=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),M(0x7a6a5a));m.position.set(x,y,z);m.receiveShadow=true;addC(m);}
wall(12,4.5,0.3,0,2.25,-7);wall(0.3,4.5,14,-6,2.25,0);wall(0.3,4.5,14,6,2.25,0);wall(12,0.3,14,0,4.5,0);
for(let i=-4;i<=4;i+=4){const b=new THREE.Mesh(new THREE.BoxGeometry(12,0.22,0.26),M(0x4a3828));b.position.set(0,4.3,i);addC(b);}
// Fireplace
addC(pm(new THREE.Mesh(new THREE.BoxGeometry(2.2,2.1,0.5),M(0x6a5545)),-3.5,1,-6.75));
addC(pm(new THREE.Mesh(new THREE.BoxGeometry(1.3,0.9,0.3),M(0x111111)),-3.5,0.65,-6.7));
const fl=new THREE.PointLight(0xff6600,3,9);fl.position.set(-3.5,1.3,-6.1);addC(fl);G._fireLight=fl;
for(let i=0;i<6;i++){const e=new THREE.Mesh(new THREE.SphereGeometry(0.04,4,4),new THREE.MeshBasicMaterial({color:0xff4400}));e.position.set(-3.5+rand(-0.4,0.35),0.55+rand(0,0.14),-6.6);addC(e);}
const pot=new THREE.Mesh(new THREE.CylinderGeometry(0.30,0.24,0.42,10),M(0x333333));pot.position.set(-3.5,1.25,-6.6);addC(pot);
// Table
const tb=new THREE.Mesh(new THREE.BoxGeometry(1.7,0.10,0.95),M(0x5a3e2a));tb.position.set(2.2,0.72,0);addC(tb);
const tleg=new THREE.Mesh(new THREE.BoxGeometry(0.10,0.72,0.10),M(0x5a3e2a));[[2.8,0.6],[2.8,-0.4],[1.6,0.6],[1.6,-0.4]].forEach(([x,z])=>{const l=tleg.clone();l.position.set(x,0.36,z);addC(l);});
// Candle
const cv=new THREE.Mesh(new THREE.CylinderGeometry(0.048,0.048,0.28,8),M(0xf0e8d0));cv.position.set(2.2,0.88,0.32);addC(cv);
const cl=new THREE.PointLight(0xffaa44,1.6,5.5);cl.position.set(2.2,1.08,0.32);addC(cl);G._candleLight=cl;
// Straw bed
addC(pm(new THREE.Mesh(new THREE.BoxGeometry(2.6,0.22,1.3),M(0xa08040)),3.5,0.11,-5));
// Crucifix
addC(pm(new THREE.Mesh(new THREE.BoxGeometry(0.12,1,0.08),M(0x3a2010)),0,3,-6.85));
addC(pm(new THREE.Mesh(new THREE.BoxGeometry(0.55,0.12,0.08),M(0x3a2010)),0,3.3,-6.85));
// Small window
addC(pm(new THREE.Mesh(new THREE.BoxGeometry(1.2,0.9,0.35),M(0xd0c8a0)),5.85,2.8,-3));
addC(new THREE.AmbientLight(0x2a1a10,0.72));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME MECHANICS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MYSTERIES=[
{name:‚ÄòThe Annunciation‚Äô,text:‚Äô‚ÄúHail, full of grace! The Lord is with thee. Blessed art thou among women.‚Äù ‚Äî Luke 1:28‚Äô},
{name:‚ÄòThe Visitation‚Äô,text:‚Äô‚ÄúBlessed art thou among women, and blessed is the fruit of thy womb!‚Äù ‚Äî Luke 1:42‚Äô},
{name:‚ÄòThe Nativity‚Äô,text:‚Äô‚ÄúShe brought forth her firstborn son and wrapped him in swaddling clothes.‚Äù ‚Äî Luke 2:7‚Äô},
{name:‚ÄòThe Presentation‚Äô,text:‚Äô‚ÄúMine eyes have seen thy salvation, which thou hast prepared before all peoples.‚Äù ‚Äî Luke 2:30-31‚Äô},
{name:‚ÄòFinding in the Temple‚Äô,text:‚Äô‚ÄúDid you not know that I must be about my Father's business?‚Äù ‚Äî Luke 2:49‚Äô},
];
function showRosary(onDone){
const ui=document.getElementById(‚ÄòrosaryUI‚Äô),beads=document.getElementById(‚ÄòrosaryBeads‚Äô);
const myst=document.getElementById(‚ÄòrosaryMystery‚Äô),prog=document.getElementById(‚ÄòrosaryProgress‚Äô);
let prayed=0;beads.innerHTML=‚Äô‚Äô;
MYSTERIES.forEach((m,i)=>{const b=document.createElement(‚Äòdiv‚Äô);b.className=‚Äòrbead‚Äô;b.textContent=‚Äò‚úù‚Äô;beads.appendChild(b);
b.onclick=()=>{if(b.classList.contains(‚Äòprayed‚Äô))return;b.classList.add(‚Äòprayed‚Äô);prayed++;
myst.textContent=‚Äô‚Äù‚Äô+m.name+‚Äô‚Äù ‚Äî ‚Äò+m.text;prog.textContent=prayed+‚Äô / 5 Mysteries prayed‚Äô;
if(prayed>=5){setTimeout(()=>{ui.classList.remove(‚Äòshow‚Äô);ui.style.display=‚Äònone‚Äô;G.dialogueActive=false;G.player.canMove=true;if(onDone)onDone();},1800);}};});
myst.textContent=‚ÄòClick each golden bead to pray a Mystery of the Holy Rosary.‚Äô;prog.textContent=‚Äò0 / 5 Mysteries prayed‚Äô;
ui.style.display=‚Äòflex‚Äô;ui.classList.add(‚Äòshow‚Äô);G.dialogueActive=true;G.player.canMove=false;}

const CATECHISM=[
{q:‚ÄòWho made you?‚Äô,a:‚ÄòGod made me.‚Äô,w:[‚ÄòThe priest made me.‚Äô,‚ÄòMy parents made me.‚Äô,‚ÄòNo one made me.‚Äô]},
{q:‚ÄòWhy did God make you?‚Äô,a:‚ÄòTo know, love and serve God in this world, and to be happy with Him in the next.‚Äô,w:[‚ÄòTo work hard and obey the law.‚Äô,‚ÄòTo be a good and kind person.‚Äô,‚ÄòTo go to church on Sundays.‚Äô]},
{q:‚ÄòWhat is the Blessed Trinity?‚Äô,a:‚ÄòOne God in three Divine Persons ‚Äî Father, Son, and Holy Spirit.‚Äô,w:[‚ÄòThree separate gods.‚Äô,‚ÄòGod and two great angels.‚Äô,‚ÄòThe Pope and two cardinals.‚Äô]},
{q:‚ÄòWhat is the Immaculate Conception?‚Äô,a:‚ÄòThe doctrine that Our Lady was conceived without original sin.‚Äô,w:[‚ÄòThe Virgin Birth of Jesus.‚Äô,‚ÄòMary was born in a miraculous way.‚Äô,‚ÄòThat Jesus had no earthly father.‚Äô]},
{q:‚ÄòWhat did the angel Gabriel say at the Annunciation?‚Äô,a:‚Äô‚ÄúHail, full of grace! The Lord is with thee. Blessed art thou among women.‚Äù‚Äô,w:[‚Äô‚ÄúFear not, for thou shalt conceive a son.‚Äù‚Äô,‚Äô‚ÄúBlessed art thou and blessed is thy child.‚Äù‚Äô,‚Äô‚ÄúThe Lord God hath chosen thee above all women.‚Äù‚Äô]},
];
function showCatechism(onDone){
const ui=document.getElementById(‚ÄòquizUI‚Äô),qEl=document.getElementById(‚ÄòquizQ‚Äô);
const ans=document.getElementById(‚ÄòquizAnswers‚Äô),prog=document.getElementById(‚ÄòquizProgress‚Äô);
let idx=0;
function next(){if(idx>=CATECHISM.length){ui.classList.remove(‚Äòshow‚Äô);ui.style.display=‚Äònone‚Äô;G.dialogueActive=false;G.player.canMove=true;if(onDone)onDone();return;}
const item=CATECHISM[idx];qEl.textContent=item.q;ans.innerHTML=‚Äô‚Äô;prog.textContent=‚ÄôQuestion ‚Äò+(idx+1)+‚Äô of ‚Äô+CATECHISM.length;
[item.a,‚Ä¶item.w].sort(()=>Math.random()-0.5).forEach(o=>{const b=document.createElement(‚Äòdiv‚Äô);b.className=‚ÄòqAnswer‚Äô;b.textContent=o;ans.appendChild(b);
b.onclick=()=>{if(o===item.a){b.classList.add(‚Äòcorrect‚Äô);notify(‚Äò‚úì Correct!‚Äô);setTimeout(()=>{idx++;next();},900);}
else{b.classList.add(‚Äòwrong‚Äô);notify(‚Äò‚úó Remember your catechism!‚Äô);setTimeout(()=>b.classList.remove(‚Äòwrong‚Äô),700);}};});}
document.getElementById(‚ÄòquizTitle‚Äô).textContent=‚Äò‚úù Sister Marie-Therese Teaches You ‚úù‚Äô;
ui.style.display=‚Äòflex‚Äô;ui.classList.add(‚Äòshow‚Äô);G.dialogueActive=true;G.player.canMove=false;next();}

const INTERR=[
{q:‚ÄòCommissioner Jacomet leans forward, his eyes like flint:‚Äô,
txt:‚Äô‚ÄúTell me honestly, girl ‚Äî did you not invent this whole story? Perhaps to get attention for your family? To profit from people's credulity?‚Äù‚Äô,
good:‚Äô‚ÄúNo, Monsieur. I am not a liar. I saw what I saw. I cannot say otherwise.‚Äù‚Äô,
bad:‚Äô‚ÄúI‚Ä¶ I am not sure. Perhaps I imagined part of it‚Äî‚Äù‚Äô,
gr:‚ÄòJacomet's eyes narrow. He writes something down. You held firm.‚Äô,
br:‚ÄòJacomet smiles. You catch yourself: ‚ÄúNo ‚Äî forgive me ‚Äî I did see her. I am certain.‚Äù‚Äô},
{q:‚ÄòHe presses harder, his voice rising:‚Äô,
txt:‚Äô‚ÄúDescribe this Lady again ‚Äî exactly as before. I will catch any contradiction. Well? Speak!‚Äù‚Äô,
good:‚Äô‚ÄúWhite robe. Blue sash. White veil. Golden roses on her feet. A rosary with golden chain. She smiled at me. That is all.‚Äù‚Äô,
bad:‚Äô‚ÄúShe wore blue‚Ä¶ I think. Or was it white? And her veil‚Äî‚Äù‚Äô,
gr:‚ÄòYour answer is word-for-word the same as before. Jacomet slaps his desk in frustration.‚Äô,
br:‚ÄòHe pounces on the inconsistency. You breathe deep and repeat what you truly saw.‚Äô},
{q:‚ÄòHe tries a final approach, his voice softening:‚Äô,
txt:‚Äô‚ÄúBe sensible, child. Retract this story now, and nothing more will be said. Your parents will not be troubled. This can all simply go away.‚Äù‚Äô,
good:‚Äô‚ÄúWith respect, Monsieur, I cannot deny what is true. I am not afraid.‚Äù‚Äô,
bad:‚Äô‚ÄúIf it would spare my family trouble‚Ä¶‚Äù‚Äô,
gr:‚ÄòHe stares at you for a long moment, then stands and dismisses you. You have not wavered by one word.‚Äô,
br:‚ÄòSomething recoils in you. ‚ÄúNo,‚Äù you say quietly. ‚ÄúNo. She appeared to me. It is true.‚Äù‚Äô},
];
function showInterrogation(onDone){
const ui=document.getElementById(‚ÄòinterrUI‚Äô),txt=document.getElementById(‚ÄòinterrText‚Äô),ch=document.getElementById(‚ÄòinterrChoices‚Äô),qEl=document.getElementById(‚ÄòinterrLabel‚Äô);
let idx=0;
function next(){if(idx>=INTERR.length){ui.classList.remove(‚Äòshow‚Äô);ui.style.display=‚Äònone‚Äô;G.dialogueActive=false;G.player.canMove=true;if(onDone)onDone();return;}
const item=INTERR[idx];qEl.textContent=item.q;txt.textContent=item.txt;ch.innerHTML=‚Äô‚Äô;
[[item.good,item.gr,true],[item.bad,item.br,false]].sort(()=>Math.random()-0.5).forEach(([opt,result,good])=>{
const b=document.createElement(‚Äòdiv‚Äô);b.className=‚ÄòiChoice‚Äô;b.textContent=opt;ch.appendChild(b);
b.onclick=()=>{ch.innerHTML=‚Äô<div style="font-family:IM Fell English,serif;font-style:italic;font-size:clamp(13px,2vw,17px);color:'+(good?'#90e090':'#e09090')+';text-align:center;line-height:1.65;padding:8px;">‚Äô+result+‚Äô</div>‚Äô;setTimeout(()=>{idx++;next();},2300);};});}
ui.style.display=‚Äòflex‚Äô;ui.classList.add(‚Äòshow‚Äô);G.dialogueActive=true;G.player.canMove=false;next();}

function showCandleTest(onDone){
const ui=document.getElementById(‚ÄòcandleUI‚Äô),fill=document.getElementById(‚ÄòcandleFill‚Äô),btn=document.getElementById(‚ÄòcandleBtn‚Äô);
let progress=0,done=false;ui.style.display=‚Äòflex‚Äô;ui.classList.add(‚Äòshow‚Äô);G.dialogueActive=true;G.player.canMove=false;
let iv=null;
function startHold(){if(done)return;btn.classList.add(‚Äòheld‚Äô);btn.textContent=‚ÄòPraying in ecstasy‚Ä¶‚Äô;iv=setInterval(()=>{if(done)return;progress=Math.min(100,progress+0.85);fill.style.width=progress+‚Äô%‚Äô;if(progress>=100&&!done){done=true;btn.textContent=‚Äò‚úì Ecstasy complete ‚Äî Bernadette feels nothing‚Äô;setTimeout(()=>{ui.classList.remove(‚Äòshow‚Äô);ui.style.display=‚Äònone‚Äô;G.dialogueActive=false;G.player.canMove=true;if(onDone)onDone();},1900);}},30);}
function stopHold(){if(iv){clearInterval(iv);iv=null;}if(!done){btn.classList.remove(‚Äòheld‚Äô);btn.textContent=‚ÄòHold to Pray in Ecstasy‚Äô;}}
btn.addEventListener(‚Äòmousedown‚Äô,startHold);btn.addEventListener(‚Äòtouchstart‚Äô,e=>{e.preventDefault();startHold();},{passive:false});
window.addEventListener(‚Äòmouseup‚Äô,stopHold);window.addEventListener(‚Äòtouchend‚Äô,stopHold);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CHAPTERS ARRAY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CHAPTERS = [

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CH 0: CHILDHOOD IN BARTRES (Age 9) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{title:‚ÄòChapter I ‚Äî The Child of the Cachot‚Äô,date:‚ÄòBartr√®s, France ¬∑ 1853‚Äì1858‚Äô,init:function(){
G.bernadetteStage=0;
scene.background=new THREE.Color(0x87ceeb);scene.fog=new THREE.Fog(0xc8e8f8,30,120);
addC(new THREE.AmbientLight(0xffeedd,0.8));
const sun=new THREE.DirectionalLight(0xfff0c0,1.1);sun.position.set(20,40,10);sun.castShadow=true;addC(sun);
G.groundFn=rawTerrain;
addC(mkTerrain({season:‚Äòspring‚Äô,res:70}));addC(mkMountains());
// Village ‚Äî all buildings snap to terrain
// Buildings snap to terrain height at their XZ position
function bldT(w,h,d,x,z,wc,rc){
const gy=rawTerrain(x,z);
const b=new THREE.Mesh(new THREE.BoxGeometry(w,h,d),new THREE.MeshPhongMaterial({color:wc||0xd0c8a8}));
b.position.set(x,gy+h/2,z);b.castShadow=true;b.receiveShadow=true;addC(b);
const r=new THREE.Mesh(new THREE.ConeGeometry(Math.max(w,d)*0.75,h*0.5,4),new THREE.MeshPhongMaterial({color:rc||0xa07050}));
r.position.set(x,gy+h+h*0.25,z);r.rotation.y=Math.PI/4;r.castShadow=true;addC(r);
}
bldT(4,3,4,-12,-15);bldT(3,2.5,3,6,-20);bldT(5,3.5,5,-5,-30,0xc8c0a8,0x807060);bldT(2.5,2,2.5,12,-14);
// Church with steeple ‚Äî on terrain
const chGY=rawTerrain(0,-28);
const ch=new THREE.Mesh(new THREE.BoxGeometry(5,5,8),new THREE.MeshPhongMaterial({color:0xe8e0d0}));ch.position.set(0,chGY+2.5,-28);addC(ch);
const ct=new THREE.Mesh(new THREE.BoxGeometry(2,7,2),new THREE.MeshPhongMaterial({color:0xe8e0d0}));ct.position.set(0,chGY+3.5,-28);addC(ct);
const csp=new THREE.Mesh(new THREE.ConeGeometry(1.4,4,8),new THREE.MeshPhongMaterial({color:0x888a88}));csp.position.set(0,chGY+9.5,-28);addC(csp);
const crx=new THREE.Mesh(new THREE.BoxGeometry(0.15,1.8,0.15),new THREE.MeshBasicMaterial({color:0xf0d060}));crx.position.set(0,chGY+12.5,-28);addC(crx);
const crxh=new THREE.Mesh(new THREE.BoxGeometry(0.9,0.15,0.15),new THREE.MeshBasicMaterial({color:0xf0d060}));crxh.position.set(0,chGY+12.1,-28);addC(crxh);
// Well on terrain
const wellGY=rawTerrain(5,-10);
const well=new THREE.Mesh(new THREE.CylinderGeometry(0.6,0.6,1,12),new THREE.MeshPhongMaterial({color:0x8a7a6a}));well.position.set(5,wellGY+0.5,-10);addC(well);
// Road follows terrain (rendered as flat strip at ground+0.02)
const roadGY=rawTerrain(0,-15);
const road=new THREE.Mesh(new THREE.PlaneGeometry(2.5,65),new THREE.MeshPhongMaterial({color:0x9a8870}));road.rotation.x=-Math.PI/2;road.position.set(0,roadGY+0.02,-15);addC(road);
const ch0PathFn=(x,z)=>(Math.abs(x)<4&&z>-20&&z<20);
mkTrees(20,18,{max:50,min:5},ch0PathFn);
mkRocks(8,18,{max:50,min:10},ch0PathFn);
G._birds=addBirds(); // Pyrenean birds over the village
// Spring wildflowers in the Bartres meadow
for(let fi=0;fi<60;fi++){
const fx=rand(-16,16),fz=rand(-45,8);
if(ch0PathFn(fx,fz))continue;
const fgy=rawTerrain(fx,fz);
const fc=[0xffddee,0xffee88,0xddeeff,0xeeffdd][Math.floor(Math.random()*4)];
const fl=new THREE.Mesh(new THREE.SphereGeometry(rand(0.07,0.13),4,3),new THREE.MeshPhongMaterial({color:fc}));
fl.position.set(fx,fgy+0.10,fz);fl.scale.y=0.5;addC(fl);
}
// NPCs snap to terrain
const mama=mkChar(0xd4a870,0x4a3828,0x2a1a0a,{veil:true,veilC:0x8a7a6a,apron:true,apronC:0xccc0a0});
mama.position.set(-3,rawTerrain(-3,2),2);addC(mama);G.npcs.push(mama);
const priest=mkChar(0xc8a060,0x0a0a15,0x1a1010,{cassock:true});priest.position.set(-8,rawTerrain(-8,-18),-18);addC(priest);G.npcs.push(priest);
G.player.mesh=createBernadette(0);
const ch1StartY=rawTerrain(0,4);G.player.mesh.position.set(0,ch1StartY,4);addC(G.player.mesh);
// Pastoral wide ‚Äî shows village, rolling hills, Pyrenees in distance
setCam({mode:‚Äòfollow‚Äô,offset:new THREE.Vector3(0,10,16),fov:62});
camera.position.set(0,ch1StartY+10,20);
showAge(‚ÄòBernadette Soubirous ¬∑ Age 9‚Äì13 ¬∑ Bartr√®s & Lourdes, France‚Äô);
G.player.canMove=true;
initTasks([{id:‚Äòmama‚Äô,label:‚ÄòHelp Maman at the well‚Äô},{id:‚Äòpray‚Äô,label:‚ÄòPray at the church‚Äô},{id:‚Äòpriest‚Äô,label:‚ÄòSpeak with the Abb√© about Catechism‚Äô}]);
createInteractable(well,‚ÄòFetch water with Maman‚Äô,()=>{if(G.completedTasks[‚Äòmama‚Äô])return;speak([{speaker:‚ÄòYoung Bernadette‚Äô,text:‚Äô(heaving the bucket up, arms trembling) It is so heavy today‚Ä¶ but Maman needs the water. I can do this.‚Äô},
{speaker:‚ÄòLouise Soubirous ‚Äî Maman‚Äô,text:‚ÄòYou are stronger than you look, my Bernarde. Now come ‚Äî there is bread if we are quick.‚Äô}],()=>completeTask(‚Äòmama‚Äô));});
const churchMk=new THREE.Mesh(new THREE.BoxGeometry(0.1,0.1,0.1),new THREE.MeshBasicMaterial({visible:false}));churchMk.position.set(0,0,-22);addC(churchMk);
createInteractable(churchMk,‚ÄòEnter the church to pray‚Äô,()=>{if(G.completedTasks[‚Äòpray‚Äô])return;speak([
{speaker:‚ÄòYoung Bernadette‚Äô,text:‚Äô(kneeling, hands clasped, voice barely a breath) Dear God‚Ä¶ I do not understand all the catechism. But I love You. And I love Your Mother. Please ‚Äî let me make my First Communion one day.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòShe stays for a long time, perfectly still. This is the Bernadette few people see ‚Äî the child who prays in secret, whose heart is always turned toward heaven.‚Äô}],()=>completeTask(‚Äòpray‚Äô));});
createInteractable(priest,‚ÄòSpeak with the Abb√©‚Äô,()=>{if(G.completedTasks[‚Äòpriest‚Äô])return;speak([
{speaker:‚ÄòThe Abb√© Ader‚Äô,text:‚ÄòAh, Bernadette. You have still not made your First Communion. You must learn the catechism ‚Äî every word. Do you know the first question: Who made you?‚Äô},
{speaker:‚ÄòYoung Bernadette‚Äô,text:‚Äô(quietly) God made me, Father.‚Äô},
{speaker:‚ÄòThe Abb√© Ader‚Äô,text:‚ÄòGood. And why? Why did God make you?‚Äô},
{speaker:‚ÄòYoung Bernadette‚Äô,text:‚Äô(long pause ‚Äî her brow furrowed in concentration) To‚Ä¶ to know Him, Father. And to love Him. And to serve Him. And to be happy with Him in Heaven.‚Äô},
{speaker:‚ÄòThe Abb√© Ader‚Äô,text:‚Äô(softening, surprised) Yes. Exactly right. Word for word. You understand more than you think, child.‚Äô}],()=>completeTask(‚Äòpriest‚Äô));});
onAllTasksDone=()=>{hideTasks();speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòYears pass. The Soubirous family falls deeper into poverty. Fran√ßois loses the mill. They are forced into the cachot ‚Äî a disused single-room prison cell, damp walls, a midden heap outside the window. Six people in one room.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòIt is February 1858. Bernadette is fourteen. She is small for her age, asthmatic since childhood, behind in her catechism. She has not yet made her First Communion. But her eyes ‚Äî dark, clear, steady ‚Äî hold something that cannot be explained.‚Äô}],()=>transitionTo(1));};
setTimeout(()=>speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòBartr√®s and Lourdes, France. The 1850s. Bernadette Soubirous is the eldest child of a struggling miller's family. Poverty, illness, and humble faith are the walls of her world. She has spent time as a servant and shepherdess at Bartr√®s farm, lonely but always praying.‚Äô},
{speaker:‚ÄòYoung Bernadette‚Äô,text:‚Äô(watching the mountain) I wonder what is behind those great rocks at Massabielle by the river. One day I shall see.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòHelp with the morning duties before leaving for the day.‚Äô}],null),1000);}},

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CH 1: THE CACHOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{title:‚ÄòChapter II ‚Äî The Cachot‚Äô,date:‚Äò73 Rue des Petites Fosses, Lourdes ¬∑ February 11, 1858‚Äô,init:function(){
G.bernadetteStage=0;buildCachot();
G.player.mesh=createBernadette(0);G.player.mesh.position.set(0,0,3);addC(G.player.mesh);
// Intimate indoor close ‚Äî sees all 4 family members clearly
setCam({mode:‚Äòfollow‚Äô,offset:new THREE.Vector3(0,5.5,10),fov:50});
camera.position.set(0,5.5,13);
showAge(‚ÄòBernadette Soubirous ¬∑ Age 14 ¬∑ The Cachot, Lourdes ¬∑ February 11, 1858‚Äô);AUDIO.setWind(0.15);
const mama=mkChar(0xd4a870,0x4a3828,0x2a1a0a,{veil:true,veilC:0x8a7a6a});mama.position.set(-1.5,0,-4.5);addC(mama);G.npcs.push(mama);
const toinette=mkChar(0xf0c89a,0x7a5a40,0x3d2b1f,{apron:true,apronC:0xd8c8a0});toinette.position.set(2.5,0,-1);addC(toinette);G.npcs.push(toinette);
const papa=mkChar(0xc49060,0x3a2820,0x2a1a0a,{});papa.position.set(3,0,-5);addC(papa);G.npcs.push(papa);
const pot=new THREE.Mesh(new THREE.CylinderGeometry(0.30,0.24,0.42,10),new THREE.MeshPhongMaterial({color:0x333333}));pot.position.set(-3.5,1.25,-6.6);addC(pot);
const bucket=new THREE.Mesh(new THREE.CylinderGeometry(0.22,0.18,0.35,10),new THREE.MeshPhongMaterial({color:0x4a3020}));bucket.position.set(5.2,0.18,5);addC(bucket);
initTasks([{id:‚Äòhair‚Äô,label:‚ÄúComb Toinette‚Äôs hair‚Äù},{id:‚Äòfood‚Äô,label:‚ÄòStir the morning porridge‚Äô},{id:‚Äòwater‚Äô,label:‚ÄòCarry the water bucket‚Äô},{id:‚Äòpapa‚Äô,label:‚ÄòSay good morning to Papa‚Äô}]);
createInteractable(toinette,‚ÄúComb Toinette‚Äôs hair‚Äù,()=>{if(G.completedTasks[‚Äòhair‚Äô])return;speak([
{speaker:‚ÄòBernadette‚Äô,text:‚ÄòToinette! Hold still ‚Äî your hair is like a bird's nest in a windstorm.‚Äô},
{speaker:‚ÄòToinette Soubirous‚Äô,text:‚ÄòOw! You pull like a cart horse, Bernarde!‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(laughing quietly) There ‚Äî see? Now you look almost like a lady. Almost.‚Äô}],()=>completeTask(‚Äòhair‚Äô));});
createInteractable(pot,‚ÄòStir the porridge‚Äô,()=>{if(G.completedTasks[‚Äòfood‚Äô])return;speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòThe pot holds only cornmeal and water ‚Äî the usual breakfast. Bernadette stirs carefully so it will not scorch.‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(barely above a whisper) Lord, bless this little food. Let it be enough for all of them. I do not mind going without.‚Äô}],()=>completeTask(‚Äòfood‚Äô));});
createInteractable(bucket,‚ÄòCarry the water bucket‚Äô,()=>{if(G.completedTasks[‚Äòwater‚Äô])return;speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòThe bucket is heavy for her slight frame. She lifts it with both arms and walks slowly, not spilling a drop.‚Äô},
{speaker:‚ÄòLouise Soubirous ‚Äî Maman‚Äô,text:‚ÄòYou are a treasure, my Bernarde.‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(setting it down, rubbing her arms) It is nothing, Maman.‚Äô}],()=>completeTask(‚Äòwater‚Äô));});
createInteractable(papa,‚ÄòGreet Papa‚Äô,()=>{if(G.completedTasks[‚Äòpapa‚Äô])return;speak([
{speaker:‚ÄòFran√ßois Soubirous ‚Äî Papa‚Äô,text:‚Äô(quietly, his pride wounded) Another day without work, Bernarde. I am sorry for all this ‚Äî (his hand sweeping the damp stone walls).‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(firmly, taking his rough hand in both of hers) Papa. You are a good father. God knows your heart. He will not forget us.‚Äô},
{speaker:‚ÄòFran√ßois Soubirous ‚Äî Papa‚Äô,text:‚Äô(blinking) Go on with you. You have your mother's faith.‚Äô}],()=>completeTask(‚Äòpapa‚Äô));});
onAllTasksDone=()=>{hideTasks();speak([
{speaker:‚ÄòLouise Soubirous ‚Äî Maman‚Äô,text:‚ÄòToinette and Jeanne Abadie are going to collect firewood along the Gave, toward Massabielle. You may go with them, Bernarde ‚Äî but wrap your capulet. If your chest‚Äî‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(already tying on the woollen hood) I will be careful, Maman. I promise.‚Äô},
{speaker:‚ÄòLouise Soubirous ‚Äî Maman‚Äô,text:‚ÄòSay your Hail Mary on the way. And be home before dark.‚Äô}],()=>transitionTo(2));};
setTimeout(()=>speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòThe cachot. A former prison cell so damp the stone walls weep. Six people in one room. A midden heap outside the window. This is where the miracle begins ‚Äî in the poorest house in Lourdes.‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(rising, wrapping herself against the cold) Good morning, Maman. Good morning, Papa. Let me help.‚Äô}],null),900);}},

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CH 2: PATH TO MASSABIELLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{title:‚ÄòChapter III ‚Äî The Path to Massabielle‚Äô,date:‚ÄòFebruary 11, 1858 ¬∑ Late Morning‚Äô,init:function(){
G.bernadetteStage=0;
scene.background=new THREE.Color(0x8ab8d8);scene.fog=new THREE.Fog(0xaacce0,28,110);
addC(new THREE.AmbientLight(0x9ab5cc,0.6));
const sun=new THREE.DirectionalLight(0xfff0d0,1.1);sun.position.set(28,50,18);sun.castShadow=true;addC(sun);
G.groundFn=rawTerrain;
addC(mkTerrain({season:‚Äòspring‚Äô,res:80}));addC(mkMountains());
const riverBedY=rawTerrain(9,0)+0.08; // sits right at valley floor
const river=mkWater(5.5,90,0x2a6090);river.position.set(9,riverBedY,0);addC(river);G.springWater=river;
// River bank stones ‚Äî alluvial gravel of the Gave de Pau
for(let i=0;i<50;i++){
const bx=rand(5.5,13),bz=rand(-45,12),bs=rand(0.15,0.5);
const peb=new THREE.Mesh(new THREE.SphereGeometry(bs,6,5),new THREE.MeshPhongMaterial({color:new THREE.Color(0.52+rand(0,0.1),0.48+rand(0,0.08),0.42+rand(0,0.07))}));
peb.scale.set(1+rand(0,0.6),0.4+rand(0,0.25),1+rand(0,0.5));
const bgy=rawTerrain(bx,bz);if(bgy>riverBedY+2)continue; // only near river
peb.position.set(bx,bgy+bs*0.15,bz);addC(peb);
}
// Spring wildflowers along the path ‚Äî anemones, primroses, violets (Pyrenean Feb-Mar)
for(let i=0;i<80;i++){
const fx=rand(-9,9),fz=rand(-50,10);
if(Math.abs(fx)<3)continue; // not on path center
const fgy=rawTerrain(fx,fz);
const fc=Math.random()<0.5?0xffeeee:Math.random()<0.5?0xffdd88:0xccaaff;
const fl=new THREE.Mesh(new THREE.SphereGeometry(rand(0.08,0.15),5,4),new THREE.MeshPhongMaterial({color:fc}));
fl.position.set(fx,fgy+0.12,fz);fl.scale.y=0.5;addC(fl);
}
// Riverbank rocks
for(let z=-35;z<30;z+=2.5+Math.random()*2){const r=new THREE.Mesh(new THREE.SphereGeometry(0.2+Math.random()*0.35,6,5),new THREE.MeshPhongMaterial({color:0x6a7a7a}));r.position.set(8+rand(-2,2),0.1,z);r.scale.y=0.5;addC(r);}
// Trees avoid the central walking path and riverside path
const ch2PathFn=(x,z)=>(Math.abs(x)<3.5||(x>5&&x<12&&z>-30&&z<10));
mkTrees(35,18,{max:55,min:5},ch2PathFn);
mkRocks(12,18,{max:55,min:8},ch2PathFn);
G._birds=addBirds(); // Birds over Pyrenean path to Massabielle
const path=new THREE.Mesh(new THREE.PlaneGeometry(2.5,90),new THREE.MeshPhongMaterial({color:0x9a8a70}));path.rotation.x=-Math.PI/2;path.position.y=0.02;addC(path);
// Distant grotto rocks
const gr1=new THREE.Mesh(new THREE.SphereGeometry(12,10,8),new THREE.MeshPhongMaterial({color:0x787878}));gr1.scale.y=0.68;gr1.position.set(-4,5,-42);addC(gr1);
const gr2=new THREE.Mesh(new THREE.SphereGeometry(8,10,8),new THREE.MeshPhongMaterial({color:0x686868}));gr2.scale.y=0.58;gr2.position.set(6,3,-40);addC(gr2);
const t2=mkChar(0xf0c89a,0x7a5a40,0x3d2b1f,{apron:true,apronC:0xd8c8a0});t2.position.set(-1.8,rawTerrain(-1.8,3.5),3.5);addC(t2);G.npcs.push(t2);
const j2=mkChar(0xe8b870,0x5a6840,0x4a2a10,{apron:true,apronC:0xd0c0a0});j2.position.set(1.8,0,3.5);addC(j2);G.npcs.push(j2);
G.player.mesh=createBernadette(0);G.player.mesh.position.set(0,rawTerrain(0,8),8);addC(G.player.mesh);G.player.canMove=true;
// Traveling shot ‚Äî sees rolling Pyrenean hills, carved river valley, Pyrenees ahead
setCam({mode:‚Äòfollow‚Äô,offset:new THREE.Vector3(2,7,13),fov:60});
camera.position.set(2,rawTerrain(0,8)+7,21);
G._awaitingWalk=true;G._walkTarget=new THREE.Vector3(0,0,-18);G._walkRadius=3;
G._onWalkArrived=()=>{G._awaitingWalk=false;hideEl(‚ÄòwalkPrompt‚Äô);transitionTo(3);};
showAge(‚ÄòFebruary 11, 1858 ‚Äî Late Morning‚Äô);AUDIO.setWind(0.85);AUDIO.setWater(0.35);
speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòThe three girls set out along the bank of the Gave, heading for the rock of Massabielle where driftwood collects. The February air is bitter cold. Bernadette has her woollen capulet pulled tight.‚Äô},
{speaker:‚ÄòToinette Soubirous‚Äô,text:‚ÄòCome on! We need to cross the mill stream. The firewood is on the other side!‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(hesitating at the water's edge) It is so cold‚Ä¶ my chest‚Äî I am afraid the water will bring on my asthma.‚Äô},
{speaker:‚ÄòJeanne Abadie‚Äô,text:‚ÄòOh Bernarde, you are always afraid! Watch ‚Äî I will throw stones for stepping. Race you to the other side!‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòWalk south along the path toward the great rock of Massabielle.‚Äô}],null);
showEl(‚ÄòwalkPrompt‚Äô);}},

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CH 3: FIRST APPARITION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{title:‚ÄòChapter IV ‚Äî The First Apparition‚Äô,date:‚ÄòFebruary 11, 1858 ¬∑ Midday‚Äô,init:function(){
G.bernadetteStage=0;buildGrotto({sky:0x0d1520,nicheLight:true});
addFireflies(18,9); // Gave grotto ‚Äî fireflies in the dusk air
G.player.mesh=createBernadette(0);G.player.mesh.position.set(0,rawTerrain(0,4),4);G.player.mesh.rotation.y=Math.PI;addC(G.player.mesh);
// Tight low angle ‚Äî Bernadette small, grotto cliff towering above
setCam({mode:‚Äòfollow‚Äô,offset:new THREE.Vector3(0,4.5,11),fov:52});
camera.position.set(0,4.5,13);
showAge(‚ÄòFebruary 11, 1858 ‚Äî First Apparition ¬∑ Massabielle Grotto‚Äô);AUDIO.setChurch(0.8);AUDIO.setWind(0.15);
speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòBernadette stops at the bank of the canal to remove her stockings. Toinette and Jeanne have already splashed through, laughing. A sound ‚Äî like a rushing wind, violent and enormous. But the trees do not move. The poplars are perfectly still.‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(spinning around, frightened) What was that?‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòShe looks toward the hollow in the cliff. The niche above the wild rosebush ‚Äî it fills with a golden light.‚Äô}],()=>{
let t=0;const grow=setInterval(()=>{t++;if(G._nicheLight)G._nicheLight.intensity=Math.min(t*0.065,5.5);if(t>=90){clearInterval(grow);showLady();}},20);});
function showLady(){
G.ourLady=createOurLady();G.ourLady.position.set(0,3.1,-12);G.ourLady.scale.setScalar(0.8);addC(G.ourLady);
showEl(‚ÄòholyGlow‚Äô);G.camera.shake=0.35;setTimeout(()=>G.camera.shake=0,2200);
// Fog retreats slightly to reveal the apparition ‚Äî supernatural light pushes it back
scene.fog=new THREE.Fog(0xc8e8d8,22,75);
// Slowly push in toward the apparition ‚Äî most dramatic moment in the story
setCam({fov:42,offset:new THREE.Vector3(0,3.5,8.5),focusMesh:G.ourLady,focusWeight:0.50});
speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòIn the niche ‚Äî a Lady. Dressed in white with a blue sash. A white veil falls to her feet. On each foot, a golden rose the same colour as the chain of her rosary. She smiles ‚Äî with a sweetness and love unlike anything Bernadette has ever seen or imagined.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòBernadette reaches for her rosary. She tries to make the Sign of the Cross ‚Äî but her arm will not rise. The Lady makes it first. Then Bernadette's arm can move.‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(tears spilling, voice barely a breath) I must pray. Please ‚Äî pray with me.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚Äò‚ú¶ Pray the Holy Rosary with Bernadette ‚Äî click each golden bead. ‚ú¶‚Äô}],()=>{
showRosary(()=>{speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòThe Lady passes her own beads through her fingers in silence. She does not speak the prayers ‚Äî but at each Gloria she bows her head. When the last decade ends, she smiles once more ‚Äî and withdraws into the light.‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(reaching toward the empty niche, her face wet with tears) No‚Ä¶ do not go‚Ä¶ please‚Äî‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòShe kneels motionless for several minutes. When Toinette shakes her, Bernadette is heavy and radiant, her eyes far away.‚Äô},
{speaker:‚ÄòToinette Soubirous‚Äô,text:‚ÄòBernarde! You went white as death ‚Äî I was terrified! What happened to you?‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(slowly, coming back) You truly saw nothing? Nothing at all ‚Äî there in the grotto?‚Äô},
{speaker:‚ÄòToinette Soubirous‚Äô,text:‚ÄòNothing. Not a thing. Only the rock and the rosebush. Come home ‚Äî it is growing dark!‚Äô}],()=>transitionTo(4));});});}
}},

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CH 4: PARENTS REACT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{title:‚ÄòChapter V ‚Äî What Maman Said‚Äô,date:‚ÄòFebruary 11, 1858 ‚Äî Evening‚Äô,init:function(){
G.bernadetteStage=0;buildCachot();
G.player.mesh=createBernadette(0);G.player.mesh.position.set(0,0,3);addC(G.player.mesh);
const mama=mkChar(0xd4a870,0x4a3828,0x2a1a0a,{veil:true});mama.position.set(-2,0,-3);addC(mama);
const papa=mkChar(0xc49060,0x3a2820,0x2a1a0a,{});papa.position.set(2,0,-3.5);addC(papa);
// Over-the-shoulder: sees both Bernadette and parents
setCam({mode:‚Äòfollow‚Äô,offset:new THREE.Vector3(-1,4.5,9),fov:48,
focusMesh:mama,focusWeight:0.3});
camera.position.set(-1,4.5,11);
showAge(‚ÄòFebruary 11, 1858 ‚Äî Evening‚Äô);
G.player.canMove=true;
initTasks([{id:‚Äòmama5‚Äô,label:‚ÄòSpeak privately with Maman‚Äô},{id:‚Äòpapa5‚Äô,label:‚ÄòSpeak privately with Papa‚Äô},{id:‚Äòpray5‚Äô,label:‚ÄòPray before sleeping‚Äô}]);
const ch5Pot=new THREE.Mesh(new THREE.BoxGeometry(0.1,0.1,0.1),new THREE.MeshBasicMaterial({visible:false}));ch5Pot.position.set(3.5,0.5,-6.5);addC(ch5Pot);
createInteractable(mama,‚ÄòSpeak with Maman‚Äô,()=>{if(G.completedTasks[‚Äòmama5‚Äô])return;
camFocus(mama,0.5,44);
speak([{speaker:‚ÄòBernadette‚Äô,text:‚ÄòMaman ‚Äî please believe me. I was not frightened of her. She looked at me as you look at me.‚Äô},
{speaker:‚ÄòLouise Soubirous ‚Äî Maman‚Äô,text:‚Äô(gripping her daughter's hands, voice breaking) I do not doubt that you believe it, Bernarde. I am afraid for you. That is all. My fear is not your fault.‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(softly) Then pray for me tonight, Maman. Just that.‚Äô}],()=>{completeTask(‚Äòmama5‚Äô);setCam({focusMesh:null,focusWeight:0});});});
createInteractable(papa,‚ÄòSpeak with Papa‚Äô,()=>{if(G.completedTasks[‚Äòpapa5‚Äô])return;
camFocus(papa,0.5,44);
speak([{speaker:‚ÄòBernadette‚Äô,text:‚Äô(taking his hand) Papa. What if it was real?‚Äô},
{speaker:‚ÄòFran√ßois Soubirous ‚Äî Papa‚Äô,text:‚Äô(long silence, eyes bright with something he cannot name) Then God has chosen the strangest house in Lourdes. (a rough laugh, then quiet) Go to sleep, my child. We will see what tomorrow brings.‚Äô}],
()=>{completeTask(‚Äòpapa5‚Äô);setCam({focusMesh:null,focusWeight:0});});});
createInteractable(ch5Pot,‚ÄòKneel and pray before sleeping‚Äô,()=>{if(G.completedTasks[‚Äòpray5‚Äô])return;
speak([{speaker:‚ÄòBernadette‚Äô,text:‚Äô(kneeling alone in the dark, rosary in hands) Holy Mary, Mother of God‚Ä¶ was it truly You today? I do not dare to think it. But if it was ‚Äî I am not afraid. Only tell me what You want, and I will do it.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòShe falls asleep still kneeling. Her mother finds her there in the early hours and carries her to her pallet.‚Äô}],()=>completeTask(‚Äòpray5‚Äô));});
onAllTasksDone=()=>{hideTasks();speak([{speaker:‚ÄòNarrator‚Äô,text:‚ÄòThat night Bernadette did not sleep long. She lay in the dark seeing again that face, that smile. She could no more forget it than forget her own name.‚Äô}],()=>transitionTo(5));};}},

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CH 5: SECOND APPARITION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{title:‚ÄòChapter VI ‚Äî The Lady Speaks‚Äô,date:‚ÄòFebruary 14, 1858 ‚Äî Second Apparition‚Äô,init:function(){
G.bernadetteStage=1;
buildGrotto({sky:0x1a2535,pilgrims:true});
addC(new THREE.AmbientLight(0x304050,0.55));addC(new THREE.DirectionalLight(0x809090,0.45)).position.set(10,22,6);
for(let i=0;i<7;i++){const c=mkChar(0xf0c89a,new THREE.Color(rand(0.3,0.6),rand(0.1,0.4),0.06).getHex(),0x2a1a0a,{apron:true,apronC:0xd0c0a0});c.position.set(rand(-5,5),0,rand(2,7));addC(c);G.npcs.push(c);}
addFireflies(18,9); // Gave grotto ‚Äî fireflies in the dusk air
G.player.mesh=createBernadette(1);G.player.mesh.position.set(0,rawTerrain(0,4),4);G.player.mesh.rotation.y=Math.PI;addC(G.player.mesh);
// Side angle ‚Äî grotto wall left, niche visible, crowd right
setCam({mode:‚Äòfollow‚Äô,offset:new THREE.Vector3(-3,5,10),fov:50});
camera.position.set(-3,5,13);
showAge(‚ÄòFebruary 14, 1858 ‚Äî Second Apparition ¬∑ Stage: Teen‚Äô);AUDIO.setChurch(0.72);
speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòThree days later. Her mother's prohibition wrestles with an irresistible longing. Bernadette returns to the grotto with several schoolgirls and a bottle of holy water from the church.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòThe light reappears. Only Bernadette sees it. The schoolgirls, frightened, hurl the holy water toward the niche, shouting‚Äî‚Äô},
{speaker:‚ÄòThe Schoolgirls‚Äô,text:‚Äô‚ÄúIf you come from God, stay! If not ‚Äî go away at once!‚Äù‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòThe Lady smiles and moves closer, untroubled. Bernadette falls into ecstasy.‚Äô}],()=>{
G.ourLady=createOurLady();G.ourLady.position.set(0,3.1,-12);G.ourLady.scale.setScalar(0.8);addC(G.ourLady);
showEl(‚ÄòholyGlow‚Äô);const nl=new THREE.PointLight(0xaabbff,5,14);nl.position.set(0,5,-12);addC(nl);G._nicheLight=nl;
// Camera pushes in toward Our Lady as she speaks
setCam({fov:44,offset:new THREE.Vector3(-2,3.5,8),focusMesh:G.ourLady,focusWeight:0.48});
speak([
{speaker:‚ÄòThe Lady ‚Äî Our Lady‚Äô,text:‚Äô‚ÄúWould you do me the favour of coming here for fifteen days?‚Äù‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(barely breathing) Yes‚Ä¶ yes, my Lady. I will come every day.‚Äô},
{speaker:‚ÄòThe Lady ‚Äî Our Lady‚Äô,text:‚Äô‚ÄúI do not promise to make you happy in this world ‚Äî but in the next.‚Äù‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(her eyes closing, tears silent on her cheeks) I accept that. I accept it with all my heart.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòThe Lady withdraws. Bernadette comes back to herself slowly, her face shining. Bernadette's mother is told. Lourdes has begun to talk.‚Äô}],()=>transitionTo(6));});}},

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CH 6: JACOMET INTERROGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{title:‚ÄòChapter VII ‚Äî Before the Commissioner‚Äô,date:‚ÄòFebruary 18, 1858 ¬∑ Office of Commissioner Jacomet‚Äô,init:function(){
G.bernadetteStage=1;
scene.background=new THREE.Color(0x1a1208);scene.fog=new THREE.Fog(0x1a1208,15,60);
addC(new THREE.AmbientLight(0x201508,0.85));
const fl=new THREE.PointLight(0xff8800,2,12);fl.position.set(0,3,0);addC(fl);G._fireLight=fl;
const gnd=new THREE.Mesh(new THREE.PlaneGeometry(14,14),new THREE.MeshPhongMaterial({color:0x5a4028}));gnd.rotation.x=-Math.PI/2;gnd.receiveShadow=true;addC(gnd);
function wall(w,h,d,x,y,z){addC(pm(new THREE.Mesh(new THREE.BoxGeometry(w,h,d),new THREE.MeshPhongMaterial({color:0x7a6850})),x,y,z));}
wall(14,4.5,0.3,0,2.25,-7);wall(0.3,4.5,14,-7,2.25,0);wall(0.3,4.5,14,7,2.25,0);
const desk=new THREE.Mesh(new THREE.BoxGeometry(2.8,0.12,1.4),new THREE.MeshPhongMaterial({color:0x4a3020}));desk.position.set(0,0.92,0);addC(desk);
[[0.7,0.5],[0.7,-0.5],[-0.7,0.5],[-0.7,-0.5]].forEach(([x,z])=>{const l=new THREE.Mesh(new THREE.BoxGeometry(0.1,0.92,0.1),new THREE.MeshPhongMaterial({color:0x4a3020}));l.position.set(x,0.46,z);addC(l);});
const paper=new THREE.Mesh(new THREE.BoxGeometry(0.6,0.02,0.4),new THREE.MeshPhongMaterial({color:0xf0ead8}));paper.position.set(0.4,0.98,0.1);addC(paper);
const jac=mkChar(0xc09060,0x222840,0x1a1010,{});jac.position.set(-0.5,0,-3);jac.scale.setScalar(1.1);addC(jac);G.npcs.push(jac);
G.player.mesh=createBernadette(1);G.player.mesh.position.set(0,0,3);addC(G.player.mesh);
// Low interrogation angle ‚Äî desk in frame, Jacomet looms
setCam({mode:‚Äòfollow‚Äô,offset:new THREE.Vector3(1,3.8,8),fov:46});
camera.position.set(1,3.8,10);
G.camera.focusMesh=jac;G.camera.focusWeight=0.35; // set after jac declared
showAge(‚ÄòFebruary 18, 1858 ¬∑ Commissioner's Office ¬∑ Lourdes‚Äô);AUDIO.setWind(0.1);
speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòCommissioner Dominique Jacomet, chief of police for Lourdes, has summoned Bernadette to his office. He is an intelligent, experienced interrogator. He intends to frighten her into retracting her story ‚Äî or catch her in a contradiction.‚Äô},
{speaker:‚ÄòCommissioner Jacomet‚Äô,text:‚Äô(pleasantly dangerous) Sit down, child. I merely want to understand what has been happening at my grotto.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòHe will try three times to break her testimony. Stay truthful and consistent. Stay calm.‚Äô}],()=>{
showInterrogation(()=>{speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòAfter an hour and a half, Jacomet has not found one contradiction. Every detail Bernadette gives is identical to what she said the first time, and the time before. He dismisses her with a warning.‚Äô},
{speaker:‚ÄòCommissioner Jacomet‚Äô,text:‚Äô(calling after her) I warn you, girl ‚Äî if this continues, there will be serious consequences for your family.‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(turning at the door, without reproach) I am sorry, Monsieur. I cannot change what is true.‚Äô}],()=>transitionTo(7));});});
}},

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CH 7: THE CANDLE ECSTASY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{title:‚ÄòChapter VIII ‚Äî The Candle Test‚Äô,date:‚ÄòFebruary‚ÄìMarch 1858 ¬∑ Multiple Apparitions‚Äô,init:function(){
G.bernadetteStage=1;
buildGrotto({sky:0x0d1520,nicheLight:true});
addFireflies(18,9); // Gave grotto ‚Äî fireflies in the dusk air
G.player.mesh=createBernadette(1);G.player.mesh.position.set(0,rawTerrain(0,4),4);G.player.mesh.rotation.y=Math.PI;addC(G.player.mesh);
// Elevated crowd shot ‚Äî sees Bernadette small among hundreds, grotto cliff above
setCam({mode:‚Äòfollow‚Äô,offset:new THREE.Vector3(4,8,13),fov:58});
camera.position.set(4,8,14);
for(let i=0;i<22;i++){const c=mkChar(0xd4a870,new THREE.Color(rand(0.2,0.5),rand(0.1,0.3),0.05).getHex(),0x2a1a0a,{veil:(i%2===0),veilC:0xb0a080});c.position.set(rand(-9,9),0,rand(2,10));addC(c);G.npcs.push(c);}
showAge(‚ÄòFebruary‚ÄìMarch 1858 ‚Äî Multiple Apparitions ¬∑ The Crowds Gather‚Äô);AUDIO.setChurch(0.9);AUDIO.setWind(0.1);
speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòThe apparitions have continued. Today Doctor Pierre-Romain Dozous stands among the hundreds of witnesses. He is a trained physician and confirmed sceptic, candle in hand, his medical eye fixed on Bernadette.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòThe Lady appears. Bernadette falls into ecstasy. Doctor Dozous steps forward and carefully moves the burning candle flame against Bernadette's clasped hands.‚Äô},
{speaker:‚ÄòDr. Pierre Dozous‚Äô,text:‚Äô(whispering, stunned) Her hands are in the flame. She holds it bare-handed ‚Äî for fifteen minutes ‚Äî and does not move, does not react, does not burn.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚Äò‚ú¶ Hold the button to pray through the ecstasy with Bernadette. Feel what she felt ‚Äî or rather, nothing at all. ‚ú¶‚Äô}],()=>{
G.ourLady=createOurLady();G.ourLady.position.set(0,3.1,-12);G.ourLady.scale.setScalar(0.8);addC(G.ourLady);
showEl(‚ÄòholyGlow‚Äô);if(G._nicheLight)G._nicheLight.intensity=5.5;
showCandleTest(()=>{speak([
{speaker:‚ÄòDr. Pierre Dozous‚Äô,text:‚Äô(afterwards, his hands shaking as he examines her) Not a mark. Not a blister. Not a trace of heat on the skin. After fifteen minutes of direct flame contact. I am a physician. I have no explanation. None.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòDoctor Dozous becomes one of the most powerful witnesses for Lourdes. His medical testimony ‚Äî detailed, precise, professional ‚Äî will help convince the Bishop's commission years later.‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(coming out of ecstasy, blinking) Why is everyone staring at me so?‚Äô}],()=>transitionTo(8));});});}},

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CH 8: FATHER PEYRAMALE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{title:‚ÄòChapter IX ‚Äî The Priest and the Rosebush‚Äô,date:‚ÄòFebruary‚ÄìMarch 1858 ¬∑ The Presbytery of Lourdes‚Äô,init:function(){
G.bernadetteStage=1;
scene.background=new THREE.Color(0x1a1008);scene.fog=new THREE.Fog(0x1a1008,18,70);
addC(new THREE.AmbientLight(0x201510,0.9));
const cl=new THREE.PointLight(0xffaa44,2.8,14);cl.position.set(0,4,0);addC(cl);G._candleLight=cl;
const gnd=new THREE.Mesh(new THREE.PlaneGeometry(16,16),new THREE.MeshPhongMaterial({color:0x5a4030}));gnd.rotation.x=-Math.PI/2;gnd.receiveShadow=true;addC(gnd);
function wall(w,h,d,x,y,z){addC(pm(new THREE.Mesh(new THREE.BoxGeometry(w,h,d),new THREE.MeshPhongMaterial({color:0x8a7860})),x,y,z));}
wall(16,5,0.3,0,2.5,-8);wall(0.3,5,16,-8,2.5,0);wall(0.3,5,16,8,2.5,0);
const crx=new THREE.Mesh(new THREE.BoxGeometry(0.15,1.3,0.1),new THREE.MeshPhongMaterial({color:0x3a2010}));crx.position.set(0,3,-7.85);addC(crx);
const crxh=new THREE.Mesh(new THREE.BoxGeometry(0.7,0.15,0.1),new THREE.MeshPhongMaterial({color:0x3a2010}));crxh.position.set(0,3.3,-7.85);addC(crxh);
const bs=new THREE.Mesh(new THREE.BoxGeometry(2.2,3.2,0.55),new THREE.MeshPhongMaterial({color:0x4a3020}));bs.position.set(-6.5,1.6,-7.6);addC(bs);
for(let i=0;i<8;i++){const bk=new THREE.Mesh(new THREE.BoxGeometry(rand(0.15,0.28),rand(0.7,1.1),0.45),new THREE.MeshPhongMaterial({color:new THREE.Color(rand(0.3,0.6),rand(0.1,0.3),rand(0,0.1))}));bk.position.set(-6.5+rand(-0.9,0.9),0.8+rand(0,2.2),-7.4);addC(bk);}
const desk=new THREE.Mesh(new THREE.BoxGeometry(2.8,0.12,1.4),new THREE.MeshPhongMaterial({color:0x4a3020}));desk.position.set(3,0.92,0);addC(desk);
[[3.7,0.5],[3.7,-0.5],[2.3,0.5],[2.3,-0.5]].forEach(([x,z])=>{const l=new THREE.Mesh(new THREE.BoxGeometry(0.1,0.92,0.1),new THREE.MeshPhongMaterial({color:0x4a3020}));l.position.set(x,0.46,z);addC(l);});
const pey=mkChar(0xd0a870,0x0a0a15,0x1a1010,{cassock:true});pey.scale.setScalar(1.12);pey.position.set(-1,0,-4);addC(pey);G.npcs.push(pey);
G.player.mesh=createBernadette(1);G.player.mesh.position.set(0,0,3);addC(G.player.mesh);
// Looking up slightly at the large priest ‚Äî Bernadette is small here
setCam({mode:‚Äòfollow‚Äô,offset:new THREE.Vector3(-2,3.5,8),fov:46});
camera.position.set(-2,3.5,10);
G.camera.focusMesh=pey;G.camera.focusWeight=0.4; // set after pey declared
showAge(‚ÄòFebruary‚ÄìMarch 1858 ¬∑ Presbytery of P√®re Peyramale‚Äô);
G.player.canMove=true;
// Petition scroll Bernadette must hand to Peyramale
const scrollMk=new THREE.Mesh(new THREE.CylinderGeometry(0.06,0.06,0.35,8),new THREE.MeshPhongMaterial({color:0xf0ead0}));
scrollMk.rotation.z=Math.PI/2;scrollMk.position.set(2.5,1.05,-0.2);addC(scrollMk);
createInteractable(scrollMk,‚ÄòGive the Lady's requests to P√®re Peyramale‚Äô,()=>{
if(G.completedTasks&&G.completedTasks[‚Äòpey‚Äô])return;
camFocus(pey,0.55,44);
speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòBernadette steps forward. The priest towers over her.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòDominique Peyramale ‚Äî cur√© of Lourdes. A large, blunt, formidable man with a lion's voice and (as it will prove) a lion's heart. Bernadette has been instructed to bring the Lady's request directly to the priest.‚Äô},
{speaker:‚ÄòFr. Dominique Peyramale‚Äô,text:‚Äô(turning sharply) So. You are the girl causing all this uproar. What do you want?‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚ÄòFather ‚Äî the Lady asks that a chapel be built at Massabielle, and that people come there in procession.‚Äô},
{speaker:‚ÄòFr. Dominique Peyramale‚Äô,text:‚Äô(slamming his hand on the desk) A CHAPEL! Does she indeed! And what is this Lady's name?‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚ÄòShe has not told me her name, Father.‚Äô},
{speaker:‚ÄòFr. Dominique Peyramale‚Äô,text:‚ÄòShe has NOT TOLD YOU! You come demanding a chapel and procession ‚Äî in the name of a Lady with no name!‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(calmly) Yes, Father. That is correct.‚Äô},
{speaker:‚ÄòFr. Dominique Peyramale‚Äô,text:‚ÄòThen go back and ask this Lady her name. And tell her: if she wants a chapel, let her make the wild rosebush bloom ‚Äî HERE, in FEBRUARY!‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(rising without reproach) I will tell her, Father.‚Äô},
{speaker:‚ÄòFr. Dominique Peyramale‚Äô,text:‚Äô(watching her leave, to himself) There is something about this child. She did not flinch. She seeks nothing for herself. Nothing at all.‚Äô}],
()=>{completeTask(‚Äòpey‚Äô);hideTasks();setCam({focusMesh:null,focusWeight:0});
setTimeout(()=>transitionTo(9),1200);});});}},

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CH 9: THE MIRACULOUS SPRING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{title:‚ÄòChapter X ‚Äî Go and Drink at the Spring‚Äô,date:‚ÄòFebruary 25, 1858 ‚Äî Ninth Apparition‚Äô,init:function(){
G.bernadetteStage=1;
buildGrotto({sky:0x0a1420,nicheLight:false,candles:true,pilgrims:true});
addC(new THREE.AmbientLight(0x102030,0.62));addC(new THREE.DirectionalLight(0x7090b0,0.4)).position.set(-10,20,5);
for(let i=0;i<14;i++){const c=mkChar(0xd4a870,new THREE.Color(rand(0.2,0.5),rand(0.1,0.3),0.05).getHex(),0x2a1a0a,{});c.position.set(rand(-9,9),0,rand(3,10));addC(c);G.npcs.push(c);}
const springHole=new THREE.Mesh(new THREE.CircleGeometry(0.45,14),new THREE.MeshPhongMaterial({color:0x1a2a50}));springHole.rotation.x=-Math.PI/2;springHole.position.set(-2,0.02,-6);addC(springHole);
addFireflies(18,9); // Gave grotto ‚Äî fireflies in the dusk air
G.player.mesh=createBernadette(1);G.player.mesh.position.set(0,rawTerrain(0,4),4);G.player.mesh.rotation.y=Math.PI;addC(G.player.mesh);
// Low handheld feel ‚Äî follows her toward the cliff, crowd watching
setCam({mode:‚Äòfollow‚Äô,offset:new THREE.Vector3(3,4,10),fov:50});
camera.position.set(3,4,13);
showAge(‚ÄòFebruary 25, 1858 ‚Äî Ninth Apparition ¬∑ The Spring‚Äô);AUDIO.setChurch(0.85);AUDIO.setWind(0.12);
speak([{speaker:‚ÄòNarrator‚Äô,text:‚ÄòFebruary 25th. The ninth apparition. Three hundred people press around the grotto. Only Bernadette sees the Lady. Today the Lady will say something that bewilders and horrifies everyone watching.‚Äô}],()=>{
G.ourLady=createOurLady();G.ourLady.position.set(0,3.1,-12);G.ourLady.scale.setScalar(0.8);addC(G.ourLady);showEl(‚ÄòholyGlow‚Äô);
const nl=new THREE.PointLight(0xaabbff,4.5,13);nl.position.set(0,5,-12);addC(nl);G._nicheLight=nl;
speak([
{speaker:‚ÄòThe Lady ‚Äî Our Lady‚Äô,text:‚Äô‚ÄúGo and drink at the spring and wash yourself there.‚Äù‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(confused, looking around) A spring? My Lady ‚Äî I see no spring. There is only mud at the base of the rock‚Äî‚Äô},
{speaker:‚ÄòThe Lady ‚Äî Our Lady‚Äô,text:‚Äô‚ÄúGo and drink there. Go and wash yourself.‚Äù‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚Äò‚ú¶ Walk to the muddy spot at the base of the cliff ‚Äî where the Lady is pointing. ‚ú¶‚Äô}],()=>{
G._awaitingSpring=true;G._springTarget=new THREE.Vector3(-2,0,-6);G.player.canMove=true;showEl(‚ÄòspringPrompt‚Äô);
// Nudge camera lower as she approaches the muddy ground
setCam({mode:‚Äòfollow‚Äô,offset:new THREE.Vector3(0,3,7),fov:42});
G._onSpringArrived=()=>{
hideEl(‚ÄòspringPrompt‚Äô);G._awaitingSpring=false;G.player.canMove=false;
speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòBernadette crawls to the spot and begins to scratch at the wet earth with her bare hands. The crowd watches in horror. Some jeer. She scoops muddy water to her lips ‚Äî once, twice, three times ‚Äî spilling most of it before it reaches her mouth.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòShe washes her face with the mud. Some in the crowd turn away in disgust. ‚ÄúThe girl has gone mad,‚Äù they say. ‚ÄúThis proves it all a deception.‚Äù Then the water clears. And clears again ‚Äî until it runs cold and pure and crystalline from the living rock.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòA spring. Where no spring has ever been. Flowing at what hydrologists will later measure as 32,000 gallons per day.‚Äô}],()=>{
showEl(‚ÄòspringGlow‚Äô);AUDIO.setWater(1);AUDIO.setChurch(0.35);
const sw=mkWater(1.6,1.6,0x44aaff);sw.position.set(-2,0.05,-6);addC(sw);
sw._isSpring=true; G.springWater=sw; // gentle spring waves
const sL=new THREE.PointLight(0x44aaff,3.2,9);sL.position.set(-2,0.6,-6);addC(sL);
// Pull back to show crowd witnessing the miracle
setTimeout(()=>setCam({mode:‚Äòfollow‚Äô,offset:new THREE.Vector3(-4,6,11),fov:56}),2000);
// Spring particles
const spN=72,spGeo=new THREE.BufferGeometry(),spPos=new Float32Array(spN*3);
spGeo.setAttribute(‚Äòposition‚Äô,new THREE.BufferAttribute(spPos,3));
const spPts=new THREE.Points(spGeo,new THREE.PointsMaterial({color:0x88ccff,size:0.065,transparent:true,opacity:0.9}));
addC(spPts);G._springPts=spPts;G._springPtsPos=spPos;
// Louis Bouriette witness NPC
const louis=mkChar(0xc49060,0x4a3020,0x2a1a0a,{});louis.position.set(2,0,-5);addC(louis);G.npcs.push(louis);
createInteractable(louis,‚ÄòSpeak with Louis Bouriette‚Äô,()=>{speak([
{speaker:‚ÄòLouis Bouriette ‚Äî Stone Quarryman‚Äô,text:‚ÄòTwenty years ‚Äî twenty years blind in this eye from a stone blast. The doctors said: nothing to be done, ever. This morning I bathed my eye in the water of this spring. I opened it. I can see you. I can see the mountain. I can see!‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(pressing his hands gently) Do not thank me, Monsieur. I am nothing. Give thanks to God and to the Lady. She made the spring ‚Äî I only dug in the mud.‚Äô}],()=>{G.player.canMove=true;});});
const contSign=new THREE.Mesh(new THREE.BoxGeometry(0.15,1.2,0.1),new THREE.MeshPhongMaterial({color:0x3a2010}));contSign.position.set(-5.5,0.6,-4);addC(contSign);
createInteractable(contSign,‚ÄòContinue the Journey ‚Üí‚Äô,()=>transitionTo(10));
speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòThe spring will flow from this hour forward, unceasingly, for more than 165 years. Louis Bouriette, blind for twenty years, sees. Catherine Latapie, her hand paralysed since a fall, plunges it in and moves her fingers.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòSpeak with Louis Bouriette, then continue when you are ready.‚Äô}],()=>{G.player.canMove=true;});});};});});
}},

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CH 10: PENANCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{title:‚ÄòChapter XI ‚Äî Penance! Penance! Penance!‚Äô,date:‚ÄòMarch 1858 ‚Äî The Call to Repentance‚Äô,init:function(){
G.bernadetteStage=1;
buildGrotto({sky:0x0a1420,nicheLight:false,pilgrims:true,mist:true});
addC(new THREE.AmbientLight(0x102030,0.55));addC(new THREE.DirectionalLight(0x8090a0,0.42)).position.set(-10,20,5);
for(let i=0;i<20;i++){const c=mkChar(0xd4a870,new THREE.Color(rand(0.2,0.5),rand(0.1,0.3),0.05).getHex(),0x2a1a0a,{veil:(i%2===0),veilC:0xb0a080});c.position.set(rand(-10,10),0,rand(3,11));addC(c);G.npcs.push(c);}
addFireflies(18,9); // Gave grotto ‚Äî fireflies in the dusk air
G.player.mesh=createBernadette(1);G.player.mesh.position.set(0,rawTerrain(0,4),4);G.player.mesh.rotation.y=Math.PI;addC(G.player.mesh);
// Wide reverent angle ‚Äî crowd fills frame, cliff looms, Bernadette tiny
setCam({mode:‚Äòfollow‚Äô,offset:new THREE.Vector3(-5,7,14),fov:58});
camera.position.set(-5,7,15);
showAge(‚ÄòMarch 1858 ‚Äî Penance and the Chapel Request‚Äô);AUDIO.setChurch(0.92);AUDIO.setWind(0.15);
speak([{speaker:‚ÄòNarrator‚Äô,text:‚ÄòDuring the apparitions the Lady's face on certain days becomes suffused with grief ‚Äî profound, maternal sorrow. On these days she speaks of sinners and the world's need for repentance.‚Äô}],()=>{
G.ourLady=createOurLady();G.ourLady.position.set(0,3.1,-12);G.ourLady.scale.setScalar(0.8);addC(G.ourLady);showEl(‚ÄòholyGlow‚Äô);
const nl=new THREE.PointLight(0xaabbff,4.5,13);nl.position.set(0,5,-12);addC(nl);G._nicheLight=nl;
speak([
{speaker:‚ÄòThe Lady ‚Äî Our Lady‚Äô,text:‚Äô‚ÄúPenance! Penance! Penance! Pray to God for sinners. Kiss the earth as a penance for sinners.‚Äù‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòBernadette prostrates herself on the cold stone. She crawls on her knees. She eats the bitter wild herbs at the grotto mouth. The crowd watches ‚Äî faces shifting from confusion to awe.‚Äô},
{speaker:‚ÄòThe Lady ‚Äî Our Lady‚Äô,text:‚Äô‚ÄúGo and tell the priests that people should come here in procession and that a chapel should be built on this spot.‚Äù‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(still kneeling, quietly) Yes, my Lady. I will go.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚Äò‚ú¶ As penance for sinners ‚Äî kneel at each of the three sacred stones before returning to Father Peyramale. ‚ú¶‚Äô}],()=>{
G.player.canMove=true;
initTasks([{id:‚Äòp0‚Äô,label:‚ÄòStone of Repentance ‚Äî kneel‚Äô},{id:‚Äòp1‚Äô,label:‚ÄòStone of Prayer ‚Äî kneel‚Äô},{id:‚Äòp2‚Äô,label:‚ÄòStone of Charity ‚Äî kneel‚Äô}]);
let visited=0;
[{pos:new THREE.Vector3(-3,0,-2),name:‚ÄòStone of Repentance‚Äô,id:‚Äòp0‚Äô},
{pos:new THREE.Vector3(0,0,-4.5),name:‚ÄòStone of Prayer‚Äô,id:‚Äòp1‚Äô},
{pos:new THREE.Vector3(3,0,-2),name:‚ÄòStone of Charity‚Äô,id:‚Äòp2‚Äô}].forEach(s=>{
const stone=new THREE.Mesh(new THREE.SphereGeometry(0.28,8,7),new THREE.MeshPhongMaterial({color:0x888070,emissive:0x443322,emissiveIntensity:0.35}));
stone.position.copy(s.pos);stone.scale.y=0.38;addC(stone);
const cx=new THREE.Mesh(new THREE.BoxGeometry(0.05,0.35,0.05),new THREE.MeshBasicMaterial({color:0xf0d060}));cx.position.set(s.pos.x,0.45,s.pos.z);addC(cx);
const cxh=new THREE.Mesh(new THREE.BoxGeometry(0.18,0.05,0.05),new THREE.MeshBasicMaterial({color:0xf0d060}));cxh.position.set(s.pos.x,0.38,s.pos.z);addC(cxh);
createInteractable(stone,s.name,()=>{if(!G.completedTasks[s.id]){completeTask(s.id);visited++;
if(visited>=3){setTimeout(()=>{hideTasks();speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòBernadette returns to Father Peyramale once more ‚Äî the same quiet composure, the same unblinking testimony. Something shifts in his face.‚Äô},
{speaker:‚ÄòFr. Dominique Peyramale‚Äô,text:‚Äô(alone in his study after she leaves) She has come to me five times. Five times the same story, not one word changed. She is either the truth itself, or the most perfect liar in the history of the Church ‚Äî and this child is no liar.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòHe writes, secretly, to the Bishop of Tarbes.‚Äô}],()=>transitionTo(11));},800);}}});
});});});}},

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CH 11: I AM THE IMMACULATE CONCEPTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{title:‚ÄòChapter XII ‚Äî ‚ÄúI Am the Immaculate Conception‚Äù‚Äô,date:‚ÄòMarch 25, 1858 ‚Äî Feast of the Annunciation‚Äô,init:function(){
G.bernadetteStage=2;
buildGrotto({sky:0x050210,nicheLight:true,pilgrims:true,candles:true});
addC(new THREE.AmbientLight(0x0a0820,0.42));addC(mkStars());
// White rose petals fall ‚Äî the ‚Äúheavenly snow‚Äù witnessed on this night
(function(){
const n=100,geo=new THREE.BufferGeometry(),pos=new Float32Array(n*3),col=new Float32Array(n*3),vel=[];
for(let i=0;i<n;i++){pos[i*3]=rand(-11,11);pos[i*3+1]=rand(3,15);pos[i*3+2]=rand(-14,7);
col[i*3]=1;col[i*3+1]=0.95+Math.random()*0.05;col[i*3+2]=0.90+Math.random()*0.10;
vel.push({vx:rand(-0.015,0.015),vz:rand(-0.010,0.010),vy:rand(-0.035,-0.015),phase:Math.random()*6.28});}
geo.setAttribute(‚Äòposition‚Äô,new THREE.BufferAttribute(pos,3));
geo.setAttribute(‚Äòcolor‚Äô,new THREE.BufferAttribute(col,3));
const pts=new THREE.Points(geo,new THREE.PointsMaterial({size:0.20,vertexColors:true,transparent:true,opacity:0.9,sizeAttenuation:true}));
addC(pts);
const chapterAtStart=G.chapter;
function animP(){if(G.chapter!==chapterAtStart)return;requestAnimationFrame(animP);
const p=pts.geometry.attributes.position.array;
for(let i=0;i<n;i++){p[i*3]+=vel[i].vx+Math.sin(G.time*0.9+vel[i].phase)*0.007;
p[i*3+1]+=vel[i].vy;p[i*3+2]+=vel[i].vz;
if(p[i*3+1]<-1){p[i*3+1]=14+rand(0,5);p[i*3]=rand(-11,11);p[i*3+2]=rand(-14,7);}}
pts.geometry.attributes.position.needsUpdate=true;}
animP();
})();
addFireflies(18,9); // Gave grotto ‚Äî fireflies in the dusk air
G.player.mesh=createBernadette(2);G.player.mesh.position.set(0,rawTerrain(0,4),4);G.player.mesh.rotation.y=Math.PI;addC(G.player.mesh);
// Begin wide, will zoom in during the sacred declaration
setCam({mode:‚Äòfollow‚Äô,offset:new THREE.Vector3(0,4.5,9),fov:54});
camera.position.set(0,4.5,11);
showAge(‚ÄòBernadette Soubirous ¬∑ Age 14 ¬∑ March 25, 1858 ‚Äî Feast of the Annunciation‚Äô);AUDIO.setChurch(1);AUDIO.setWind(0);
speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòMarch 25th. The Feast of the Annunciation. Bernadette has asked the Lady her name three times over the preceding weeks. Each time the Lady smiled with great tenderness ‚Äî and said nothing.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòToday the light in the niche is brighter than it has ever been. The Lady appears ‚Äî radiant, joyful, lit from within.‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(her voice small against the silence) My Lady‚Ä¶ I beg of you‚Ä¶ will you not tell me who you are? The priest requires it of me. Who are you, my Lady?‚Äô}],()=>{
G.ourLady=createOurLady();G.ourLady.position.set(0,3.1,-12);G.ourLady.scale.setScalar(0.8);addC(G.ourLady);showEl(‚ÄòholyGlow‚Äô);
// Scene brightens as the declaration approaches
scene.fog=new THREE.Fog(0xeef8f0,20,80);
const sacredLight=new THREE.PointLight(0xffffff,4.5,25);sacredLight.position.set(0,4,-12);addC(sacredLight);
// Maximum intimacy ‚Äî push in as the name is finally revealed
setCam({fov:38,offset:new THREE.Vector3(0,3.2,7),focusMesh:G.ourLady,focusWeight:0.55});
const l1=new THREE.PointLight(0xffffff,7,18);l1.position.set(0,5.5,-12);addC(l1);G._nicheLight=l1;
const l2=new THREE.PointLight(0xaabbff,4.5,22);l2.position.set(0,3,0);addC(l2);
speak([{speaker:‚ÄòNarrator‚Äô,text:‚ÄòThe Lady's face takes on a look of great solemnity and tenderness together. She joins her hands and raises her eyes to heaven. Then her arms fall open ‚Äî the gesture of the Miraculous Medal, rays of golden light streaming from her palms. She smiles. And she speaks.‚Äô}],()=>{
setTimeout(()=>{G.camera.shake=1.2;AUDIO.setChurch(1);
const fl=addC(new THREE.PointLight(0xffffff,22,55));fl.position.set(0,5,-5);setTimeout(()=>{G.camera.shake=0;},900);
speak([
{speaker:‚Äò‚ú¶ The Most Holy Virgin Mary ‚Äî Our Lady of Lourdes ‚ú¶‚Äô,text:‚Äô‚ÄúQue soy era Immaculata Conceptiou.‚Äù‚Äô},
{speaker:‚ÄòEnglish ‚Äî from the Gascon dialect of Lourdes‚Äô,text:‚Äô‚ÄúI am the Immaculate Conception.‚Äù‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòThese words are spoken in Bernadette's own village dialect ‚Äî the language of the poor, the uneducated, the forgotten. Bernadette has never heard the phrase ‚ÄúImmaculate Conception.‚Äù She does not know what it means.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòShe begins to run ‚Äî through the streets of Lourdes, repeating the words under her breath over and over, terrified she will forget them before reaching the priest.‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(breathless, bursting through Peyramale's door) Father! She told me! She said ‚Äî Que soy era Immaculata Conceptiou ‚Äî ‚ÄúI am the Immaculate Conception!‚Äù‚Äô},
{speaker:‚ÄòFr. Dominique Peyramale‚Äô,text:‚Äô(frozen in his chair, voice dropping to a whisper) What did you say?‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô‚ÄúI am the Immaculate Conception,‚Äù Father. She said it three times so I would not forget.‚Äô},
{speaker:‚ÄòFr. Dominique Peyramale‚Äô,text:‚Äô(standing, hand pressed to his face) Do you know what those words mean, child?‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚ÄòNo, Father. I do not. But I did not forget them.‚Äô},
{speaker:‚ÄòFr. Dominique Peyramale‚Äô,text:‚Äô(alone, hours later, pacing) Pope Pius IX defined the Immaculate Conception only four years ago ‚Äî 1854. This girl cannot read. She has never heard this theology. She CANNOT have invented these words. She has given Her name. The Virgin Mary has named Herself.‚Äô}],()=>transitionTo(12));},1200);});
})
}},

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CH 12: FIRST COMMUNION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{title:‚ÄòChapter XIII ‚Äî First Communion‚Äô,date:‚ÄòJune 3, 1858 ‚Äî The Feast of Corpus Christi‚Äô,init:function(){
G.bernadetteStage=2;
scene.background=new THREE.Color(0x1a1008);scene.fog=new THREE.Fog(0x1a1008,20,80);
addC(new THREE.AmbientLight(0x302418,0.85));
// Church interior
const gnd=new THREE.Mesh(new THREE.PlaneGeometry(20,24),new THREE.MeshPhongMaterial({color:0x5a4a38}));gnd.rotation.x=-Math.PI/2;gnd.receiveShadow=true;addC(gnd);
function wall(w,h,d,x,y,z){addC(pm(new THREE.Mesh(new THREE.BoxGeometry(w,h,d),new THREE.MeshPhongMaterial({color:0xe0d8c8})),x,y,z));}
wall(20,8,0.3,0,4,-12);wall(0.3,8,24,-10,4,0);wall(0.3,8,24,10,4,0);wall(20,0.3,24,0,8,0);
// Pews
for(let row=0;row<5;row++){[-4,4].forEach(sx=>{const pew=new THREE.Mesh(new THREE.BoxGeometry(3.5,0.6,0.85),new THREE.MeshPhongMaterial({color:0x5a3820}));pew.position.set(sx,0.4,-row*2.2+4);addC(pew);const back=new THREE.Mesh(new THREE.BoxGeometry(3.5,1.1,0.15),new THREE.MeshPhongMaterial({color:0x5a3820}));back.position.set(sx,0.95,-row*2.2+4.5);addC(back);});}
// Altar
const altar=new THREE.Mesh(new THREE.BoxGeometry(6,1,2),new THREE.MeshPhongMaterial({color:0xf0ece0}));altar.position.set(0,0.5,-11);addC(altar);
const alC=new THREE.PointLight(0xffee88,3.5,16);alC.position.set(0,3,-10);addC(alC);G._candleLight=alC;
// Altar cross
addC(pm(new THREE.Mesh(new THREE.BoxGeometry(0.2,2,0.15),new THREE.MeshBasicMaterial({color:0xf0d060})),0,2.5,-11.4));
addC(pm(new THREE.Mesh(new THREE.BoxGeometry(1.1,0.2,0.15),new THREE.MeshBasicMaterial({color:0xf0d060})),0,2.8,-11.4));
// Candles on altar
[-2.5,2.5,-1.5,1.5,-0.8,0.8].forEach(x=>{const cv=new THREE.Mesh(new THREE.CylinderGeometry(0.05,0.05,0.55,8),new THREE.MeshPhongMaterial({color:0xf0e8d0}));cv.position.set(x,1.28,-11);addC(cv);const fl=new THREE.PointLight(0xffaa44,0.6,3);fl.position.set(x,1.7,-11);addC(fl);});
// Stained glass suggestion (coloured panels)
[[0xdd4444,-9.85,5,-6],[0x4488cc,-9.85,5,-3],[0xddaa22,-9.85,5,0],[0x44cc44,-9.85,5,3],[0xcc44aa,9.85,5,-6],[0x44ccdd,9.85,5,-3],[0xddcc44,9.85,5,0],[0x8844cc,9.85,5,3]].forEach(([c,x,y,z])=>{
const sg=new THREE.Mesh(new THREE.BoxGeometry(0.12,2.5,1.8),new THREE.MeshPhongMaterial({color:c,emissive:c,emissiveIntensity:0.35,transparent:true,opacity:0.72}));sg.position.set(x,y,z);addC(sg);});
// Priest at altar
const pey=mkChar(0xd0a870,0x0a0a15,0x1a1010,{cassock:true});pey.position.set(0,0,-10.5);addC(pey);G.npcs.push(pey);
// Children for communion
for(let i=0;i<8;i++){const child=mkChar(0xf0c89a,0xf5f2ec,0x2a1a0a,{veil:true,veilC:0xffffff});child.scale.setScalar(0.72);child.position.set(rand(-4,4),0,-8+Math.floor(i/4)*2);addC(child);}
// Communion altar mark for player to walk to
const commMk=new THREE.Mesh(new THREE.BoxGeometry(0.1,0.1,0.1),new THREE.MeshBasicMaterial({visible:false}));commMk.position.set(0,0,-9.5);addC(commMk);
G.player.mesh=createBernadette(2);G.player.mesh.position.set(2,0,4);addC(G.player.mesh);G.player.canMove=false;
// Looking down nave toward the altar, pews framing, sacred gold light
setCam({mode:‚Äòfollow‚Äô,offset:new THREE.Vector3(0,4,10),fov:48});
camera.position.set(0,4,14);
showAge(‚ÄòBernadette Soubirous ¬∑ Age 14 ¬∑ First Holy Communion ¬∑ June 3, 1858‚Äô);AUDIO.setChurch(1);AUDIO.setWind(0);
speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòJune 3, 1858. The Feast of Corpus Christi. The day that Bernadette has longed for since childhood ‚Äî the day she makes her First Holy Communion. She is fourteen years old, two years later than most children her age.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòShe will later say: ‚ÄúI have always thought that the greatest sorrow of my life was not seeing the apparitions again ‚Äî only the happiness of my First Communion could be compared to the ecstasy of seeing the Lady.‚Äù‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(whispering to herself, her hands clasped, eyes shining) She promised me happiness not in this world but the next. And today ‚Äî today I touch the next world for a moment.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚Äò‚ú¶ Walk forward to receive Holy Communion at the altar. ‚ú¶‚Äô}],()=>{
G.player.canMove=true;showEl(‚ÄòcommunionPrompt‚Äô);
G._awaitingWalk=true;G._walkTarget=commMk.position.clone();G._walkRadius=2;
G._onWalkArrived=()=>{
G._awaitingWalk=false;hideEl(‚ÄòcommunionPrompt‚Äô);G.player.canMove=false;
G.camera.shake=0.18;
speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòShe receives the Host. In the years and decades to come she will describe it like this: ‚ÄúAll I can say is that in the moment of receiving Him ‚Äî for one instant ‚Äî I had what I saw in the grotto, and infinitely more.‚Äù‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòThe apparitions are now complete. Eighteen apparitions in all, from February 11 to July 16, 1858. The commission of the Bishop of Tarbes begins its investigation. Bernadette will be questioned hundreds of times.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòShe never falters. Not once, not by one word, in the next twenty years.‚Äô}],()=>transitionTo(13));};});}},

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CH 13: CATECHISM & FIRST COMMUNION STUDIES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{title:‚ÄòChapter XIV ‚Äî To Learn and to Pray‚Äô,date:‚Äò1858‚Äì1860 ¬∑ The Hospice School, Lourdes‚Äô,init:function(){
G.bernadetteStage=2;
scene.background=new THREE.Color(0x2a1e10);scene.fog=new THREE.Fog(0x2a1e10,18,75);
addC(new THREE.AmbientLight(0x302418,0.9));
const cl=new THREE.PointLight(0xffaa44,2.2,13);cl.position.set(0,3.5,0);addC(cl);G._candleLight=cl;
const gnd=new THREE.Mesh(new THREE.PlaneGeometry(16,16),new THREE.MeshPhongMaterial({color:0x5a4030}));gnd.rotation.x=-Math.PI/2;gnd.receiveShadow=true;addC(gnd);
function wall(w,h,d,x,y,z){addC(pm(new THREE.Mesh(new THREE.BoxGeometry(w,h,d),new THREE.MeshPhongMaterial({color:0xc8bca8})),x,y,z));}
wall(16,5,0.3,0,2.5,-8);wall(0.3,5,16,-8,2.5,0);wall(0.3,5,16,8,2.5,0);
// Blackboard
const bb=new THREE.Mesh(new THREE.BoxGeometry(4,2.8,0.15),new THREE.MeshPhongMaterial({color:0x1a2018}));bb.position.set(0,2.5,-7.85);addC(bb);
// Desks
for(let row=0;row<3;row++){for(let col=-2;col<=2;col+=2){const d=new THREE.Mesh(new THREE.BoxGeometry(1.4,0.1,0.9),new THREE.MeshPhongMaterial({color:0x5a3820}));d.position.set(col,0.7,-row*2.5+3.5);addC(d);}}
// Sister teacher NPC
const sister=mkChar(0xd0a870,0x0a0a18,0x1a1010,{cassock:true});sister.position.set(0,0,-6.5);addC(sister);G.npcs.push(sister);
// Students
for(let i=0;i<6;i++){const s=mkChar(0xf0c89a,0x7a6040,0x2a1a0a,{apron:true});s.scale.setScalar(0.72);s.position.set((i%3-1)*2.2,0,-Math.floor(i/3)*2.5+4);addC(s);}
G.player.mesh=createBernadette(2);G.player.mesh.position.set(0,0,4);addC(G.player.mesh);
// Classroom angle ‚Äî sees blackboard, Sister teacher, Bernadette at desk
setCam({mode:‚Äòfollow‚Äô,offset:new THREE.Vector3(-1,3.5,9),fov:46});
camera.position.set(-1,3.5,12);
G.camera.focusMesh=sister;G.camera.focusWeight=0.3; // set after sister declared showAge(‚ÄòBernadette Soubirous ¬∑ Age 14‚Äì16 ¬∑ Hospice School, Lourdes‚Äô);AUDIO.setChurch(0.5);AUDIO.setWind(0);
speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòThe Sisters of Nevers who run the Hospice school take Bernadette in as a charity pupil. She is older than the other children, slower to read ‚Äî but her memory for prayers is extraordinary. She can repeat perfectly what she hears once.‚Äô},
{speaker:‚ÄòSister Marie-Therese‚Äô,text:‚ÄòBernadette. Today we revise the catechism before your examination. Come ‚Äî you must know every answer without hesitation. The Bishop's commission will want to see that your faith has solid roots.‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(sitting down, folding her hands on the desk) Yes, Sister. I am ready.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚Äò‚ú¶ Answer the catechism questions correctly to continue. ‚ú¶‚Äô}],()=>{
G.player.canMove=true;createInteractable(sister,‚ÄòBegin catechism lesson with Sister Marie-Therese‚Äô,()=>{
showCatechism(()=>{speak([
{speaker:‚ÄòSister Marie-Therese‚Äô,text:‚Äô(quietly amazed) Bernadette. Every answer ‚Äî perfect. You may not be able to read, but you understand your faith better than girls twice your age.‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(simply) The Lady taught me, Sister. When I was with her ‚Äî I understood everything, even what I cannot explain in words. All I can do is try to remember.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòThe Bishop's commission completes its four-year investigation. On January 18, 1862 ‚Äî three and a half years after the apparitions ‚Äî Bishop Bertrand-S√©v√®re Laurence issues his decree.‚Äô}],()=>transitionTo(14));});});
})
}},

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CH 14: BISHOP‚ÄôS DECLARATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{title:‚ÄúChapter XV ‚Äî The Bishop‚Äôs Decree‚Äù,date:‚ÄòJanuary 18, 1862 ‚Äî The Church Speaks‚Äô,init:function(){
G.bernadetteStage=2;
buildGrotto({sky:0x0a1525,nicheLight:true,pilgrims:true,candles:true});
addC(new THREE.AmbientLight(0x203040,0.62));
const sun=new THREE.DirectionalLight(0x9ab5cc,0.55);sun.position.set(14,28,8);addC(sun);
for(let i=0;i<35;i++){const c=mkChar(0xd4a870,new THREE.Color(rand(0.2,0.5),rand(0.1,0.3),0.05).getHex(),0x2a1a0a,{veil:(i%3!==0)});c.position.set(rand(-12,12),0,rand(2,12));addC(c);}
// Early construction of basilica visible in distance
const bwl=new THREE.Mesh(new THREE.BoxGeometry(8,5,6),new THREE.MeshPhongMaterial({color:0xe8e0d0}));bwl.position.set(0,2.5,-35);addC(bwl);
const bsp=new THREE.Mesh(new THREE.ConeGeometry(2.5,6,8),new THREE.MeshPhongMaterial({color:0x8a9898}));bsp.position.set(0,8,-35);addC(bsp);
if(G._nicheLight)G._nicheLight.intensity=3.5;
G.player.mesh=createBernadette(2);G.player.mesh.position.set(0,0,4);G.player.mesh.rotation.y=Math.PI;addC(G.player.mesh);
setCam({mode:‚Äúfollow‚Äù,offset:new THREE.Vector3(0,7,12),fov:54});
camera.position.set(0,rawTerrain(0,13)+7,13);G.player.canMove=false;
showAge(‚ÄòBernadette Soubirous ¬∑ Age 17-18 ¬∑ 1862‚Äô);AUDIO.setChurch(0.95);AUDIO.setWind(0.2);
speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòJanuary 18, 1862. After more than three years and hundreds of witness interviews, medical examinations, and theological consultations, the Bishop of Tarbes issues his pastoral letter.‚Äô},
{speaker:‚ÄòBishop Bertrand-S√©v√®re Laurence‚Äô,text:‚Äô(reading publicly) ‚ÄúWe declare that the Immaculate Mary, Mother of God, truly appeared to Bernadette Soubirous on the eleventh of February, 1858, and on subsequent days ‚Äî in all, eighteen times ‚Äî in the grotto of Massabielle.‚Äù‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòThe crowds gathered at the grotto fall to their knees. The sound of weeping mingles with the sound of the spring.‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(standing very still, her eyes looking toward the niche) Thank you, my Lady. Thank you for choosing someone so small.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòWork has already begun on the construction of a chapel ‚Äî then a basilica ‚Äî above the grotto. Father Peyramale, who challenged the Lady to make the rosebush bloom, becomes one of the most tireless advocates for the shrine.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòBut the Bishop's words about Bernadette are telling: ‚ÄúWe have carefully examined this child. We find her to be sincere, modest, pious, and exact in all her statements. She shows no pride, no desire for celebrity, no eagerness for any reward whatsoever.‚Äù‚Äô},
{speaker:‚ÄòBernadette‚Äô,text:‚Äô(turning away from the crowd, to herself) I am the instrument ‚Äî nothing more. The spring is for others. The shrine is for others. My work here is done.‚Äô}],()=>transitionTo(15));}},

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CH 15: ENTERING THE CONVENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{title:‚ÄòChapter XV ‚Äî Sister Marie-Bernard‚Äô,date:‚ÄòJuly 7, 1866 ‚Äî The Convent of Saint-Gildard, Nevers‚Äô,init:function(){
G.bernadetteStage=3;
scene.background=new THREE.Color(0x1a1a2a);scene.fog=new THREE.Fog(0x1a1a2a,20,85);
addC(new THREE.AmbientLight(0x202030,0.82));
const cl=new THREE.PointLight(0xeeddbb,2.5,18);cl.position.set(0,4,0);addC(cl);G._candleLight=cl;
// Convent courtyard / chapel approach
const gnd=new THREE.Mesh(new THREE.PlaneGeometry(22,22),new THREE.MeshPhongMaterial({color:0x6a6055}));gnd.rotation.x=-Math.PI/2;gnd.receiveShadow=true;addC(gnd);
function wall(w,h,d,x,y,z){addC(pm(new THREE.Mesh(new THREE.BoxGeometry(w,h,d),new THREE.MeshPhongMaterial({color:0xd8d0c0})),x,y,z));}
wall(22,7,0.3,0,3.5,-11);wall(0.3,7,22,-11,3.5,0);wall(0.3,7,22,11,3.5,0);
// Chapel arch
const arch=new THREE.Mesh(new THREE.BoxGeometry(4,6,0.5),new THREE.MeshPhongMaterial({color:0xd0c8b8}));arch.position.set(0,3,-10.6);addC(arch);
const archHole=new THREE.Mesh(new THREE.CylinderGeometry(1.4,1.4,0.6,12),new THREE.MeshPhongMaterial({color:0x0a0812}));archHole.rotation.x=Math.PI/2;archHole.position.set(0,3.5,-10.5);addC(archHole);
const capCross=new THREE.Mesh(new THREE.BoxGeometry(0.18,1.8,0.18),new THREE.MeshBasicMaterial({color:0xf0d060}));capCross.position.set(0,7.2,-10.5);addC(capCross);
const capCrossH=new THREE.Mesh(new THREE.BoxGeometry(0.88,0.18,0.18),new THREE.MeshBasicMaterial({color:0xf0d060}));capCrossH.position.set(0,6.8,-10.5);addC(capCrossH);
// Fountain in courtyard
const fount=new THREE.Mesh(new THREE.CylinderGeometry(1.2,1.4,0.55,16),new THREE.MeshPhongMaterial({color:0x9a9090}));fount.position.set(0,0.28,0);addC(fount);
const fw=mkWater(1.5,1.5,0x4488aa);fw.position.set(0,0.56,0);addC(fw);G.springWater=fw;
// Superior and sisters
const sup=mkChar(0xe0d0b8,0x0a0a18,0x1a1010,{cassock:true});sup.position.set(-1.5,0,-6);addC(sup);G.npcs.push(sup);
for(let i=0;i<5;i++){const s=mkChar(0xe0cca0,0x0a0a18,0x1a1010,{cassock:true});s.position.set(-5+i*2.5,0,-4+rand(-1,1));addC(s);G.npcs.push(s);}
// Lourdes visitor ‚Äî mama
const mama=mkChar(0xd4a870,0x4a3828,0x2a1a0a,{veil:true});mama.position.set(4,0,3);addC(mama);G.npcs.push(mama);
G.player.mesh=createBernadette(3);G.player.mesh.position.set(0,0,5);addC(G.player.mesh);
// Courtyard angle: fountain foreground, arch behind, sisters arrayed
setCam({mode:‚Äòfollow‚Äô,offset:new THREE.Vector3(0,6,12),fov:54});
camera.position.set(0,6,15);
showAge(‚ÄòSister Marie-Bernard Soubirous ¬∑ Age 22 ¬∑ Convent of Saint-Gildard, Nevers ¬∑ July 7, 1866‚Äô);AUDIO.setChurch(0.85);AUDIO.setWind(0.05);
initTasks([{id:‚Äòsup‚Äô,label:‚ÄòSpeak with Mother Superior‚Äô},{id:‚Äòmama‚Äô,label:‚ÄòSay farewell to Maman‚Äô},{id:‚Äòvow‚Äô,label:‚ÄòWalk to the chapel to take your vows‚Äô}]);
createInteractable(sup,‚ÄòSpeak with Mother Superior Josephine Imbert‚Äô,()=>{if(G.completedTasks[‚Äòsup‚Äô])return;speak([
{speaker:‚ÄòMother Superior Imbert‚Äô,text:‚ÄòSister Marie-Bernard. That is your name now ‚Äî not Bernadette, not the seer, not the child of Lourdes. Here you are a novice like any other. No special privileges, no exhibitions for curious visitors.‚Äô},
{speaker:‚ÄòSister Bernadette / Marie-Bernard‚Äô,text:‚ÄòI am glad of that, Reverend Mother. Truly. I have been put on display long enough. I want to be ordinary.‚Äô},
{speaker:‚ÄòMother Superior Imbert‚Äô,text:‚Äô(studying her) And what is your gift ‚Äî what can you offer this community?‚Äô},
{speaker:‚ÄòSister Bernadette / Marie-Bernard‚Äô,text:‚Äô(a slight smile) I know how to be ill, Reverend Mother. That I can do very well.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòBernadette has suffered from severe asthma and tuberculosis of the bone since childhood. She will spend much of her life at Nevers in the infirmary ‚Äî offering her suffering as prayer.‚Äô}],()=>completeTask(‚Äòsup‚Äô));});
createInteractable(mama,‚ÄòSay farewell to Maman‚Äô,()=>{if(G.completedTasks[‚Äòmama‚Äô])return;speak([
{speaker:‚ÄòLouise Soubirous ‚Äî Maman‚Äô,text:‚Äô(embracing her) My Bernarde. My little one. You go so far away. I shall not see you again.‚Äô},
{speaker:‚ÄòSister Bernadette / Marie-Bernard‚Äô,text:‚Äô(holding her close, her voice steady though her eyes shine) Maman. You gave me my rosary, and my faith, and the courage to tell the truth no matter who asked. That is everything. I carry you in every prayer.‚Äô},
{speaker:‚ÄòLouise Soubirous ‚Äî Maman‚Äô,text:‚Äô(breaking) You were always God's child more than mine. I knew it even before Massabielle.‚Äô},
{speaker:‚ÄòSister Bernadette / Marie-Bernard‚Äô,text:‚ÄòWe will meet again, Maman. I promise. Beyond all this.‚Äô}],()=>completeTask(‚Äòmama‚Äô));});
const chapMk=new THREE.Mesh(new THREE.BoxGeometry(0.1,0.1,0.1),new THREE.MeshBasicMaterial({visible:false}));chapMk.position.set(0,0,-9);addC(chapMk);
createInteractable(chapMk,‚ÄòEnter the chapel to profess your vows‚Äô,()=>{if(G.tasks[‚Äòvow‚Äô]&&!G.completedTasks[‚Äòvow‚Äô]){if(!G.completedTasks[‚Äòsup‚Äô]||!G.completedTasks[‚Äòmama‚Äô]){notify(‚ÄòSpeak with Mother Superior and say farewell to Maman first.‚Äô);return;}completeTask(‚Äòvow‚Äô);}});
onAllTasksDone=()=>{hideTasks();speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòSister Marie-Bernard Soubirous professes her final vows on September 22, 1878. For twelve years at Nevers she works in the infirmary, caring for the sick. She is never permitted to visit Lourdes again.‚Äô},
{speaker:‚ÄòSister Bernadette / Marie-Bernard‚Äô,text:‚Äô(in the chapel, alone) My Lady said not in this world. I understand now. The suffering IS the gift. Every day that I offer it up ‚Äî that is my pilgrimage to Massabielle.‚Äô}],()=>transitionTo(16));}
}},

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CH 16: SUFFERING AT NEVERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{title:‚ÄòChapter XVI ‚Äî The Long Martyrdom‚Äô,date:‚Äò1867‚Äì1879 ¬∑ The Infirmary, Saint-Gildard‚Äô,init:function(){
G.bernadetteStage=3;
scene.background=new THREE.Color(0x0d0c18);scene.fog=new THREE.Fog(0x0d0c18,14,60);
addC(new THREE.AmbientLight(0x202028,0.78));
const cl=new THREE.PointLight(0xffdd99,2,11);cl.position.set(0,3.5,-3);addC(cl);G._candleLight=cl;
// Infirmary room
const gnd=new THREE.Mesh(new THREE.PlaneGeometry(14,16),new THREE.MeshPhongMaterial({color:0x6a5848}));gnd.rotation.x=-Math.PI/2;gnd.receiveShadow=true;addC(gnd);
function wall(w,h,d,x,y,z){addC(pm(new THREE.Mesh(new THREE.BoxGeometry(w,h,d),new THREE.MeshPhongMaterial({color:0xd4cfc4})),x,y,z));}
wall(14,5,0.3,0,2.5,-8);wall(0.3,5,16,-7,2.5,0);wall(0.3,5,16,7,2.5,0);wall(14,0.3,16,0,5,0);
// Bed
const bed=new THREE.Mesh(new THREE.BoxGeometry(2.4,0.55,5),new THREE.MeshPhongMaterial({color:0xf0ece4}));bed.position.set(3,0.28,-5);addC(bed);
const pillow=new THREE.Mesh(new THREE.BoxGeometry(2,0.3,1),new THREE.MeshPhongMaterial({color:0xffffff}));pillow.position.set(3,0.58,-7);addC(pillow);
// Crucifix on wall
addC(pm(new THREE.Mesh(new THREE.BoxGeometry(0.12,1.1,0.08),new THREE.MeshPhongMaterial({color:0x3a2010})),3,3.8,-7.85));
addC(pm(new THREE.Mesh(new THREE.BoxGeometry(0.6,0.12,0.08),new THREE.MeshPhongMaterial({color:0x3a2010})),3,4.08,-7.85));
// Statue of Our Lady on shelf
const statBase=new THREE.Mesh(new THREE.CylinderGeometry(0.28,0.30,0.88,10),new THREE.MeshPhongMaterial({color:0xffffff,emissive:0x8888ff,emissiveIntensity:0.3}));statBase.position.set(-4.5,1.18,-6);addC(statBase);
const statHead=new THREE.Mesh(new THREE.SphereGeometry(0.18,10,8),new THREE.MeshPhongMaterial({color:0xfff5f0,emissive:0xaaaaff,emissiveIntensity:0.28}));statHead.position.set(-4.5,1.9,-6);addC(statHead);
const sL=new THREE.PointLight(0xaabbff,1.8,4);sL.position.set(-4.5,2.5,-5.5);addC(sL);
// Visiting sisters
const s1=mkChar(0xe0d0b8,0x0a0a18,0x1a1010,{cassock:true});s1.position.set(-2,0,-4);addC(s1);G.npcs.push(s1);
const s2=mkChar(0xd8c8a0,0x0a0a18,0x1a1010,{cassock:true});s2.position.set(-3.5,0,-2);addC(s2);G.npcs.push(s2);
G.player.mesh=createBernadette(3);G.player.mesh.position.set(0,0,4);addC(G.player.mesh);
// Low bedside angle ‚Äî the bed dominates, Our Lady statue glows in corner
setCam({mode:‚Äòfollow‚Äô,offset:new THREE.Vector3(-2,3.2,8),fov:44});
camera.position.set(-2,3.2,10);
showAge(‚ÄòSister Marie-Bernard ¬∑ Age 23‚Äì35 ¬∑ The Infirmary at Nevers ¬∑ 1867‚Äì1879‚Äô);AUDIO.setChurch(0.45);
initTasks([{id:‚Äòstatue‚Äô,label:‚ÄòPray before the statue of Our Lady‚Äô},{id:‚Äòsister‚Äô,label:‚ÄòSpeak with Sister Marie-Bernard de Chamberland‚Äô},{id:‚Äòletter‚Äô,label:‚ÄòVisit the writing desk ‚Äî write to Lourdes‚Äô}]);
createInteractable(statBase,‚ÄòPray before the statue of Our Lady‚Äô,()=>{if(G.completedTasks[‚Äòstatue‚Äô])return;speak([
{speaker:‚ÄòSister Bernadette / Marie-Bernard‚Äô,text:‚Äô(kneeling painfully, her knee bones eaten by tuberculosis) My Lady. You promised me this. Not happiness in this world, but in the next. I trust you. I trust you completely.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòShe kneels for an hour, motionless, before rising with great effort. A visiting sister tries to help her. She refuses gently.‚Äô},
{speaker:‚ÄòSister Bernadette / Marie-Bernard‚Äô,text:‚ÄòLeave me to my white chapel. (She calls her infirmary bed ‚Äúmy white chapel.‚Äù) This is my Massabielle now.‚Äô}],()=>completeTask(‚Äòstatue‚Äô));});
createInteractable(s1,‚ÄòSpeak with Sister Marie-Bernard de Chamberland‚Äô,()=>{if(G.completedTasks[‚Äòsister‚Äô])return;speak([
{speaker:‚ÄòSister de Chamberland‚Äô,text:‚ÄòSister Marie-Bernard ‚Äî the pilgrims at Lourdes are asking for you constantly. They want to see you, to be blessed by you. Cannot you send them a word?‚Äô},
{speaker:‚ÄòSister Bernadette / Marie-Bernard‚Äô,text:‚Äô(with gentle firmness) Sister, I am not a saint. I am not a miracle. I am a poor, ill woman who was given the privilege of delivering a message. The message has been delivered. It is the spring they should seek ‚Äî not me.‚Äô},
{speaker:‚ÄòSister de Chamberland‚Äô,text:‚ÄòBut you are famous throughout all of France. Throughout Europe. The Emperor himself‚Äî‚Äô},
{speaker:‚ÄòSister Bernadette / Marie-Bernard‚Äô,text:‚ÄòThe Emperor may do as he likes. I have my white chapel. I have my rosary. I have everything I need.‚Äô}],()=>completeTask(‚Äòsister‚Äô));});
const desk=new THREE.Mesh(new THREE.BoxGeometry(1.5,0.1,0.8),new THREE.MeshPhongMaterial({color:0x5a3820}));desk.position.set(-2,0.72,2);addC(desk);
createInteractable(desk,‚ÄòWrite a letter to Lourdes‚Äô,()=>{if(G.completedTasks[‚Äòletter‚Äô])return;speak([
{speaker:‚ÄòSister Bernadette / Marie-Bernard‚Äô,text:‚Äô(writing slowly, her hand painful) ‚ÄúMy dear friends at Lourdes ‚Äî I pray for you every day. The Lady does not need my presence near her spring. She is there whether I am or not. She is everywhere God is loved. Go to her spring, drink, bathe, pray for sinners. I will join you from my white chapel.‚Äù‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòShe signs it not ‚ÄúBernadette, the seer of Lourdes‚Äù but simply: ‚ÄúSister Marie-Bernard, a poor sick creature who prays for you.‚Äù‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòOver her years at Nevers she writes hundreds of such letters. She never mentions her own sufferings.‚Äô}],()=>completeTask(‚Äòletter‚Äô));});
onAllTasksDone=()=>{hideTasks();speak([
{speaker:‚ÄòNarrator‚Äô,text:‚Äò1879. Bernadette is thirty-five years old. She has lived at Nevers for thirteen years. Her body is destroyed ‚Äî tuberculosis of the lungs, tuberculosis of the bone, an enormous tumour on her knee that has left her nearly immobile.‚Äô},
{speaker:‚ÄòSister Bernadette / Marie-Bernard‚Äô,text:‚Äô(to a sister at her bedside) I am ground like a grain of wheat. Our Lady told me this would come. I am glad of it. Pray for me.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòShe holds her crucifix. She holds her rosary. She looks up.‚Äô}],()=>transitionTo(17));}
}},

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CH 17: DEATH AND GLORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{title:‚ÄòChapter XVII ‚Äî The White Chapel‚Äô,date:‚ÄòApril 16, 1879 ‚Äî Easter Wednesday ¬∑ Nevers‚Äô,init:function(){
G.bernadetteStage=3;
scene.background=new THREE.Color(0x050510);scene.fog=new THREE.Fog(0x050510,10,55);
addC(new THREE.AmbientLight(0x151520,0.65));
const cl=new THREE.PointLight(0xffddaa,1.8,9);cl.position.set(0,3,-3);addC(cl);G._candleLight=cl;
const gnd=new THREE.Mesh(new THREE.PlaneGeometry(12,14),new THREE.MeshPhongMaterial({color:0x6a5848}));gnd.rotation.x=-Math.PI/2;gnd.receiveShadow=true;addC(gnd);
function wall(w,h,d,x,y,z){addC(pm(new THREE.Mesh(new THREE.BoxGeometry(w,h,d),new THREE.MeshPhongMaterial({color:0xd4cfc4})),x,y,z));}
wall(12,5,0.3,0,2.5,-7);wall(0.3,5,14,-6,2.5,0);wall(0.3,5,14,6,2.5,0);
// Deathbed
const bed=new THREE.Mesh(new THREE.BoxGeometry(2.4,0.55,5.5),new THREE.MeshPhongMaterial({color:0xffffff}));bed.position.set(0,0.28,-4);addC(bed);
const pillow=new THREE.Mesh(new THREE.BoxGeometry(2,0.3,1),new THREE.MeshPhongMaterial({color:0xffffff}));pillow.position.set(0,0.58,-6);addC(pillow);
// Candles around bed
[-2.2,2.2].forEach(x=>{const cv=new THREE.Mesh(new THREE.CylinderGeometry(0.05,0.05,0.65,8),new THREE.MeshPhongMaterial({color:0xf0e8d0}));cv.position.set(x,0.6,-3.5);addC(cv);const fl=new THREE.PointLight(0xffaa44,1.2,4);fl.position.set(x,1.1,-3.5);addC(fl);});
// Crucifix
addC(pm(new THREE.Mesh(new THREE.BoxGeometry(0.12,1.1,0.08),new THREE.MeshPhongMaterial({color:0x3a2010})),0,3.8,-6.85));
addC(pm(new THREE.Mesh(new THREE.BoxGeometry(0.6,0.12,0.08),new THREE.MeshPhongMaterial({color:0x3a2010})),0,4.08,-6.85));
// Gathering sisters (silhouettes)
for(let i=0;i<8;i++){const s=mkChar(0xe0d0b8,0x0a0a18,0x1a1010,{cassock:true});s.position.set(rand(-3.5,3.5),0,rand(0.5,3.5));addC(s);}
// Our Lady appears faintly in the corner
G.ourLady=createOurLady();G.ourLady.position.set(-4,1.5,-5);G.ourLady.scale.setScalar(0.55);
G.ourLady._iL.intensity=0.8;G.ourLady._oL.intensity=0.6;addC(G.ourLady);
G.player.mesh=createBernadette(3);G.player.mesh.position.set(0,0,3);addC(G.player.mesh);G.player.canMove=false;
// Deathbed close ‚Äî candlelight, Sisters, Our Lady faintly visible
setCam({mode:‚Äòfollow‚Äô,offset:new THREE.Vector3(2,3.5,8),fov:44,
focusMesh:G.ourLady,focusWeight:0.2});
camera.position.set(2,3.5,10);
showAge(‚ÄòSister Marie-Bernard Soubirous ¬∑ Age 35 ¬∑ April 16, 1879‚Äô);AUDIO.setChurch(0.8);AUDIO.setWind(0);
speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòApril 16, 1879. Easter Wednesday. Sister Marie-Bernard has been on her deathbed for weeks, her body devastated by tuberculosis of the lung, the knee, and by an enormous tumour. She has refused painkillers. She has asked only for her crucifix and her rosary.‚Äô},
{speaker:‚ÄòSister Bernadette / Marie-Bernard‚Äô,text:‚Äô(to the sisters gathered around her, in great pain but calm) My God, I love You. (long pause) Holy Mary, Mother of God, pray for me, a poor sinner.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòShe holds up her crucifix. She looks toward the corner of the room. Her face changes.‚Äô},
{speaker:‚ÄòSister de Chamberland‚Äô,text:‚Äô(whispering to another sister) She is looking at something. She is looking at something that we cannot see.‚Äô},
{speaker:‚ÄòSister Bernadette / Marie-Bernard‚Äô,text:‚Äô(her last words, barely audible, her face transformed) My Jesus ‚Äî Oh my Jesus‚Äî‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòShe dies at three-fifteen in the afternoon, the hour of Christ's death on Good Friday. She is thirty-five years old.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòWhen her body is exhumed thirty years later for the beatification process ‚Äî and again in 1925 ‚Äî it is found to be perfectly incorrupt. Her face, her hands, her body: unchanged. The doctor who examines her writes: ‚ÄúI cannot explain this.‚Äù‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòThe Church declares her Blessed on June 14, 1925. She is canonised ‚Äî raised to sainthood ‚Äî on December 8, 1933. The Feast of the Immaculate Conception.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòThe Lourdes spring still flows. It has never frozen, never gone dry. More than 200 million pilgrims have visited the shrine. Seventy miraculous healings have been medically verified. The water cures no one automatically ‚Äî it offers itself, freely, to all who come.‚Äô}],()=>transitionTo(18));}},

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ CH 18: EPILOGUE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
{title:‚ÄòEpilogue ‚Äî Our Lady of Lourdes‚Äô,date:‚ÄòLourdes, France ‚Äî Then and Now‚Äô,init:function(){
G.bernadetteStage=2;
scene.background=new THREE.Color(0x050210);scene.fog=new THREE.Fog(0x080418,25,120);
addC(new THREE.AmbientLight(0x101028,0.45));addC(mkStars());G.groundFn=rawTerrain;addC(mkTerrain({season:‚Äòspring‚Äô,res:60}));addC(mkMountains());
// Basilica
// Basilica snaps to hill top ‚Äî historically it‚Äôs built on the rock above grotto
const basilGY=rawTerrain(0,-50);
const bwl=new THREE.Mesh(new THREE.BoxGeometry(16,10,12),new THREE.MeshPhongMaterial({color:0xeae4d8,emissive:0x221810,emissiveIntensity:0.18}));bwl.position.set(0,basilGY+5,-50);addC(bwl);
const bsp=new THREE.Mesh(new THREE.ConeGeometry(4,12,8),new THREE.MeshPhongMaterial({color:0x8a9898}));bsp.position.set(0,basilGY+17,-50);addC(bsp);
const bcrx=new THREE.Mesh(new THREE.BoxGeometry(0.4,4,0.4),new THREE.MeshBasicMaterial({color:0xf0d060}));bcrx.position.set(0,basilGY+25,-50);addC(bcrx);
const bcrxh=new THREE.Mesh(new THREE.BoxGeometry(2.2,0.4,0.4),new THREE.MeshBasicMaterial({color:0xf0d060}));bcrxh.position.set(0,basilGY+24.2,-50);addC(bcrxh);
// Moonlight
const moon=new THREE.DirectionalLight(0x6070a0,0.42);moon.position.set(-20,30,10);addC(moon);
// River
const epiRiverY=rawTerrain(9,0)+0.06;
const river=mkWater(6,80,0x1a3a6a);river.position.set(9,epiRiverY,0);addC(river);G.springWater=river;
// Candlelight procession (scattered point lights)
for(let i=0;i<18;i++){const cl=new THREE.PointLight(0xffaa44,0.8+Math.random(),5+Math.random()*5);cl.position.set(rand(-14,14),0.5+Math.random(),rand(-35,-2));addC(cl);}
// Pilgrims (crowd of NPCs)
for(let i=0;i<28;i++){const c=mkChar(0xd4a870,new THREE.Color(rand(0.15,0.55),rand(0.08,0.4),rand(0,0.18)).getHex(),0x2a1a0a,{veil:(i%3!==0)});c.position.set(rand(-14,14),0,rand(-45,-5));addC(c);}
// Our Lady in the niche
// Our Lady hovers above the hilltop near the basilica
const ladyGY=rawTerrain(0,-15);
G.ourLady=createOurLady();G.ourLady.position.set(0,ladyGY+5,-15);G.ourLady.scale.setScalar(1.8);addC(G.ourLady);
const epiStartY=rawTerrain(0,6);
G.player.mesh=createBernadette(2);G.player.mesh.position.set(0,epiStartY,6);addC(G.player.mesh);
// Grand panoramic ‚Äî basilica behind, Gave valley, Pyrenees, Our Lady glowing
setCam({mode:‚Äòfollow‚Äô,offset:new THREE.Vector3(0,10,18),fov:65,
focusMesh:G.ourLady,focusWeight:0.28});
camera.position.set(0,epiStartY+10,22);
showAge(‚ÄòOur Lady of Lourdes ¬∑ The Shrine ¬∑ Then and Now‚Äô);AUDIO.setChurch(1);AUDIO.setWater(0.5);AUDIO.setWind(0.2);
showEl(‚ÄòholyGlow‚Äô);
setTimeout(()=>{speak([
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòThe Lourdes spring has flowed continuously since February 25, 1858. Today 18 thermal baths fed by the spring welcome more than 80,000 bathers each year. Over 200 million pilgrims have visited the shrine.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòThe Cures Bureau at Lourdes ‚Äî staffed by doctors, including sceptics and non-believers ‚Äî has examined thousands of reported miraculous cures. Seventy have been officially declared miraculous after decades of medical scrutiny.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòBernadette Soubirous was canonised on December 8, 1933 ‚Äî the Feast of the Immaculate Conception. The date She had named. Her incorrupt body lies in a glass reliquary at the Chapel of Saint-Gildard in Nevers. Her face is serene. She looks like she is sleeping.‚Äô},
{speaker:‚ÄòSaint Bernadette Soubirous‚Äô,text:‚Äô‚ÄúShe looked at me as a mother looks at a child. And that was all. That was everything.‚Äù‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòEvery night at Lourdes, thousands carry candles through the dark in the torch-lit procession ‚Äî the same procession Our Lady requested. The same mountain air. The same spring.‚Äô},
{speaker:‚ÄòNarrator‚Äô,text:‚ÄòShe is still there.‚Äô},
{speaker:‚ÄòOur Lady of Lourdes‚Äô,text:‚Äô‚ÄúI am the Immaculate Conception.‚Äù‚Äô},
],()=>{setCam({mode:‚Äòorbit‚Äô,orbitCenter:G.ourLady?G.ourLady.position.clone():new THREE.Vector3(-4,1.5,-5),orbitR:7,orbitY:4,orbitSpeed:0.15,fov:38});setTimeout(showFinal,800);});},1500);}},
]; // end CHAPTERS

function showFinal(){
fadeOut(()=>{scene.clear();clearChapter();const t=document.getElementById(‚ÄòtitleScreen‚Äô);
t.innerHTML=‚Äô<div class="cross" style="font-size:72px;color:#f0d080;text-shadow:0 0 40px #ffd700;">‚úù</div>‚Äô+
‚Äò<h1 style="font-size:clamp(18px,3.5vw,44px);">Saint Bernadette Soubirous</h1>‚Äô+
‚Äò<h2 style="letter-spacing:0.25em;">1844 ‚Äì 1879 ¬∑ Canonised 1933</h2>‚Äô+
‚Äò<div class="sub" style="margin-bottom:30px;font-size:clamp(11px,1.8vw,18px);max-width:600px;line-height:1.8;color:#c4a882;">‚ÄúShe did not come for the clever or the strong. She came for a poor asthmatic girl who could not read ‚Äî and gave the world a spring.‚Äù</div>‚Äô+
‚Äò<div class="sub" style="color:rgba(180,150,80,0.6);font-size:clamp(9px,1.3vw,13px);max-width:480px;line-height:1.7;">The Lourdes spring flows at 32,000 gallons per day ¬∑ Unceasingly since February 25, 1858<br>200 million+ pilgrims ¬∑ 70 verified miraculous cures ¬∑ The shrine never closes</div>‚Äô+
‚Äò<button id="startBtn" style="margin-top:38px;min-height:52px;padding:16px 48px;" onclick="transitionTo(0)">Begin Again ‚úù</button>‚Äô;
t.style.opacity=‚Äò0‚Äô;t.style.display=‚Äòflex‚Äô;setTimeout(()=>{t.style.opacity=‚Äò1‚Äô;},100);fadeIn();});}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PLAYER UPDATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PLAYER UPDATE ‚Äî terrain-snapping movement
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updatePlayer(delta){
if(!G.player.mesh)return;
let mx=0,mz=0;
if(G.player.canMove&&!G.dialogueActive){
if(G.keys[‚ÄòKeyW‚Äô]||G.keys[‚ÄòArrowUp‚Äô])mz=-1;
if(G.keys[‚ÄòKeyS‚Äô]||G.keys[‚ÄòArrowDown‚Äô])mz=1;
if(G.keys[‚ÄòKeyA‚Äô]||G.keys[‚ÄòArrowLeft‚Äô])mx=-1;
if(G.keys[‚ÄòKeyD‚Äô]||G.keys[‚ÄòArrowRight‚Äô])mx=1;
if(G.joy.x||G.joy.y){mx=G.joy.x;mz=G.joy.y;}
if(mx&&mz){const l=Math.sqrt(mx*mx+mz*mz);mx/=l;mz/=l;}
}
const moving=(mx!==0||mz!==0);
// Speed varies slightly uphill (feels more physical)
const speed=4.2;
if(moving){
const nx=G.player.mesh.position.x+mx*speed*delta;
const nz=G.player.mesh.position.z+mz*speed*delta;
G.player.mesh.position.x=nx;
G.player.mesh.position.z=nz;
G.player.mesh.rotation.y=Math.atan2(mx,mz);
G.player.facing={x:mx,z:mz};
}

// ‚îÄ‚îÄ TERRAIN HEIGHT SNAPPING ‚îÄ‚îÄ
// Bernadette walks over hills naturally ‚Äî Y snaps to terrain surface
const px=G.player.mesh.position.x,pz=G.player.mesh.position.z;
const groundY=sampleGround(px,pz);
// Smooth Y interpolation so she doesn‚Äôt pop ‚Äî lerp at rate 12/s
const targetY=groundY; // feet on ground
const bounce=G.player.mesh._bounceY||0;
G.player.mesh.position.y=(G.player.mesh.position.y-bounce)+(targetY-(G.player.mesh.position.y-bounce))*Math.min(1,delta*12)+bounce;

// Tilt player mesh slightly on slopes for realism
if(G.groundFn&&moving){
const slopeX=sampleGround(px+0.5,pz)-sampleGround(px-0.5,pz);
const slopeZ=sampleGround(px,pz+0.5)-sampleGround(px,pz-0.5);
G.player.mesh.rotation.x=(G.player.mesh.rotation.x+(-slopeZ*0.18-G.player.mesh.rotation.x)*delta*8);
G.player.mesh.rotation.z=(G.player.mesh.rotation.z+(slopeX*0.14-G.player.mesh.rotation.z)*delta*8);
}else{
G.player.mesh.rotation.x*=(1-delta*6);
G.player.mesh.rotation.z*=(1-delta*6);
}

// Subtle haptic pulse on mobile for footsteps (every ~0.5 steps)
if(moving&&navigator.vibrate&&G._stepT){
G._stepT+=delta;
if(G._stepT>0.45){G._stepT=0;try{navigator.vibrate(4);}catch(e){}}
}else if(moving&&!G._stepT)G._stepT=0;
else if(!moving)G._stepT=null;
animWalk(G.player.mesh,delta,moving);

// Walk trigger checks (use XZ distance for terrain scenes)
if(G._awaitingWalk&&G._walkTarget&&G.player.mesh&&G.player.canMove){
const dx=G.player.mesh.position.x-G._walkTarget.x,dz=G.player.mesh.position.z-G._walkTarget.z;
const d=Math.sqrt(dx*dx+dz*dz); // XZ only, ignore Y
if(d<(G._walkRadius||2)&&G._onWalkArrived){const cb=G._onWalkArrived;G._onWalkArrived=null;G._awaitingWalk=false;cb();}
}
if(G._awaitingSpring&&G._springTarget&&G.player.mesh){
const dx=G.player.mesh.position.x-G._springTarget.x,dz=G.player.mesh.position.z-G._springTarget.z;
const d=Math.sqrt(dx*dx+dz*dz);
if(d<2.2&&G._onSpringArrived){const cb=G._onSpringArrived;G._onSpringArrived=null;cb();}
}

// Interact
if(G.keys[‚ÄòKeyE‚Äô]&&!G._eHeld){G._eHeld=true;if(G.nearbyInteractable&&!G.dialogueActive)G.nearbyInteractable.onInteract();}
if(!G.keys[‚ÄòKeyE‚Äô])G._eHeld=false;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CAMERA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CAMERA HELPERS ‚Äî call from chapter inits
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setCam(opts){
// opts: {mode, offset, pos, look, fov, focusMesh, focusWeight, orbitCenter, orbitR, orbitY, orbitSpeed}
const c=G.camera;
if(opts.mode!==undefined)c.mode=opts.mode;
if(opts.offset)c.offset.copy(opts.offset);
if(opts.pos!==undefined)c.pos=opts.pos;   // THREE.Vector3 or null
if(opts.look!==undefined)c.look=opts.look; // THREE.Vector3 or null
if(opts.fov!==undefined)c.fov=opts.fov;
if(opts.focusMesh!==undefined)c.focusMesh=opts.focusMesh;
if(opts.focusWeight!==undefined)c.focusWeight=opts.focusWeight||0;
if(opts.orbitCenter!==undefined){c.orbitCenter=opts.orbitCenter;c.orbitR=opts.orbitR||8;c.orbitY=opts.orbitY||4;c.orbitSpeed=opts.orbitSpeed||0.3;}
}
// Instantly look at a mesh during dialogue ‚Äî smooth cinematic focus
function camFocus(mesh,weight,fov){
G.camera.focusMesh=mesh;G.camera.focusWeight=weight||0.4;
if(fov)G.camera.fov=fov;
}
// Snap camera to a fixed cinematic angle immediately
function camSnap(x,y,z,lx,ly,lz){
camera.position.set(x,y,z);
const lv=new THREE.Vector3(lx||0,ly||1.4,lz||0);
camera.lookAt(lv);
}

function updateCamera(delta){
// ‚îÄ‚îÄ FOV smooth interpolation ‚îÄ‚îÄ
const fovSpd=delta*3.5;
G.camera.fovCur+=(G.camera.fov-G.camera.fovCur)*fovSpd;
camera.fov=G.camera.fovCur;camera.updateProjectionMatrix();

const c=G.camera,pp=G.player.mesh?G.player.mesh.position:new THREE.Vector3();

// ‚îÄ‚îÄ Compute player look-point (what camera wants to aim at) ‚îÄ‚îÄ
let baseLook=pp.clone();baseLook.y+=1.2;
// Bias toward Our Lady during apparitions
if(G.ourLady)baseLook.lerp(G.ourLady.position.clone().add(new THREE.Vector3(0,1.5,0)),0.25);
// Extra cinematic focus on a specific NPC (set via camFocus)
if(c.focusMesh&&c.focusWeight>0){
const fp=c.focusMesh.position.clone();fp.y+=1.0;
baseLook.lerp(fp,c.focusWeight);
}

if(c.mode===‚Äòorbit‚Äô&&c.orbitCenter){
// Orbit around a fixed point (grotto, Our Lady)
c._orbitAngle=(c._orbitAngle||0)+c.orbitSpeed*delta;
const tx=c.orbitCenter.x+Math.sin(c._orbitAngle)*c.orbitR;
const tz=c.orbitCenter.z+Math.cos(c._orbitAngle)*c.orbitR;
const ty=c.orbitCenter.y+c.orbitY;
camera.position.lerp(new THREE.Vector3(tx,ty,tz),delta*1.5);
camera.lookAt(c.orbitCenter.clone().add(new THREE.Vector3(0,1.5,0)));

}else if(c.mode===‚Äòfixed‚Äô&&c.pos){
// Fixed cinematic position
camera.position.lerp(c.pos,delta*2.5);
const lookAt=c.look||baseLook;
camera.lookAt(lookAt);

}else{
// ‚îÄ‚îÄ FOLLOW mode ‚Äî terrain-aware third-person ‚îÄ‚îÄ
const offX=c.offset.x,offY=c.offset.y,offZ=c.offset.z;
// Camera position trails behind player
const camTargetX=pp.x+offX;
const camTargetZ=pp.z+offZ;
const groundAtCam=sampleGround(camTargetX,camTargetZ);
const minY=Math.max(pp.y+offY, groundAtCam+3.5);
const targetPos=new THREE.Vector3(camTargetX,minY,camTargetZ);
const lerpSpd=c.mode===‚Äòdialogue‚Äô?delta*2.2:delta*4.0;
camera.position.lerp(targetPos,lerpSpd);
camera.lookAt(baseLook);
}

// ‚îÄ‚îÄ Cinematic shake ‚îÄ‚îÄ
if(c.shake>0){
camera.position.x+=rand(-1,1)*c.shake;
camera.position.y+=rand(-0.5,0.5)*c.shake;
c.shake=Math.max(0,c.shake-delta*1.8);
}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INTERACTABLE DETECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateInteractables(){
G.nearbyInteractable=null;if(!G.player.mesh)return;
let closest=2.8,closestItem=null;
G.interactables.forEach(item=>{
const d=G.player.mesh.position.distanceTo(item.mesh.position);
if(d<closest){closest=d;closestItem=item;}
if(item.glowMesh){
const bob=Math.sin(G.time*2.2)*0.12;
const baseY=item.mesh.position.y+1.85;
item.glowMesh.position.y=baseY+bob;
item.glowMat.opacity=0.55+Math.sin(G.time*3.4)*0.32;
// Animate the cross marker
if(item._crx){item._crx.position.y=baseY+bob+0.22;item._crx.rotation.y=G.time*0.8;}
if(item._crxh){item._crxh.position.y=baseY+bob+0.27;item._crxh.rotation.y=G.time*0.8;}
}
});
G.nearbyInteractable=closestItem;
const prompt=document.getElementById(‚ÄòinteractPrompt‚Äô);
if(closestItem&&!G.dialogueActive){prompt.style.display=‚Äòblock‚Äô;const isMobile=‚Äòontouchstart‚Äô in window;
prompt.textContent=(isMobile?‚Äô‚úã  ‚Äò:‚Äô[ E ]  ‚Äô)+closestItem.label;}
else prompt.style.display=‚Äònone‚Äô;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LIGHTS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateLights(){
// Fireplace ‚Äî realistic flickering with multiple frequencies (Cachot scenes)
if(G._fireLight){
G._fireLight.intensity=2.2+Math.sin(G.time*9.1)*0.9+Math.sin(G.time*14.3)*0.5+Math.sin(G.time*5.7)*0.3;
G._fireLight.color.setHSL(0.07+Math.sin(G.time*3.2)*0.02, 0.95, 0.5);
}
// Candle ‚Äî gentle breathing flame
if(G._candleLight){
G._candleLight.intensity=1.3+Math.sin(G.time*6.8)*0.35+Math.sin(G.time*11.2)*0.12;
}
// Niche apparition light ‚Äî ‚Äúblinding white light‚Äù as witnesses described
// Pulses with slow spiritual rhythm, peaks in intensity
if(G._nicheLight){
const pulse=Math.sin(G.time*1.4)*0.6+Math.sin(G.time*2.9)*0.3+Math.sin(G.time*0.5)*0.15;
G._nicheLight.intensity=5.2+pulse;
// Shift slightly warm/cool ‚Äî ‚Äúlight that neither dazzled nor hurt the eyes‚Äù
G._nicheLight.color.setHSL(0.60+Math.sin(G.time*0.7)*0.04, 0.3, 0.95+Math.sin(G.time*1.1)*0.03);
}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SPRING PARTICLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateSpringParticles(){
if(!G._springPts)return;
const pos=G._springPtsPos;const n=pos.length/3;
for(let i=0;i<n;i++){pos[i*3]=-2+(Math.random()-0.5)*0.3;pos[i*3+1]+=0.04+Math.random()*0.06;pos[i*3+2]=-6+(Math.random()-0.5)*0.3;if(pos[i*3+1]>1.5)pos[i*3+1]=0.05;}
G._springPts.geometry.attributes.position.needsUpdate=true;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAIN LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function animate(){
requestAnimationFrame(animate);
const delta=Math.min(clock.getDelta(),0.05);
G.time+=delta;
updatePlayer(delta);updateCamera(delta);updateInteractables();updateLights();
if(G.ourLady)animOurLady(G.ourLady,G.time);
if(G.springWater)animWater(G.springWater,delta);
updateSpringParticles();
// NPC behavior ‚Äî look toward Bernadette when near, idle sway otherwise
G.npcs.forEach((npc,i)=>{
const idleSway=Math.sin(G.time*0.28+i*1.4)*0.04;
if(G.player.mesh){
const dx=G.player.mesh.position.x-npc.position.x;
const dz=G.player.mesh.position.z-npc.position.z;
const dist=Math.sqrt(dx*dx+dz*dz);
if(dist<4.5){
// Turn to face Bernadette
const targetY=Math.atan2(dx,dz);
const diff=((targetY-npc.rotation.y)+Math.PI*3)%(Math.PI*2)-Math.PI;
npc.rotation.y+=diff*0.04;
// Lean head toward her slightly
if(npc._head)npc._head.rotation.x=-0.06+Math.sin(G.time*0.8+i)*0.015;
}else{
npc.rotation.y+=idleSway*0.06;
if(npc._head)npc._head.rotation.x=Math.sin(G.time*0.8+i)*0.02;
}
}else{
npc.rotation.y+=idleSway*0.06;
}
// Idle breathing ‚Äî subtle body bob
if(npc._armL)npc._armL.rotation.x=Math.sin(G.time*0.5+i)*0.015;
if(npc._armR)npc._armR.rotation.x=-Math.sin(G.time*0.5+i)*0.015;
// Smooth Y snap to terrain (only in outdoor scenes)
if(G.groundFn){
const gy=sampleGround(npc.position.x,npc.position.z);
npc.position.y+=(gy-npc.position.y)*Math.min(1,0.08);
}
});
// Firefly particles in grotto scenes (atmospheric glow points)
if(G._fireflies){
const fp=G._fireflies.geometry.attributes.position.array;
const n=fp.length/3;
for(let i=0;i<n;i++){
fp[i*3]+=Math.sin(G.time*0.8+i*2.1)*0.008;
fp[i*3+1]+=Math.cos(G.time*1.1+i*1.7)*0.005;
fp[i*3+2]+=Math.sin(G.time*0.6+i*2.8)*0.007;
}
G._fireflies.geometry.attributes.position.needsUpdate=true;
G._fireflies.material.opacity=0.5+Math.sin(G.time*2.2)*0.3;
}
renderer.render(scene,camera);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  START
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startGame(){
// Auto-hide zoom hint
setTimeout(()=>{const h=document.getElementById(‚ÄòzoomHint‚Äô);if(h)h.style.opacity=‚Äò0‚Äô;},5000);
onResize();
const title=document.getElementById(‚ÄòtitleScreen‚Äô);title.style.opacity=‚Äò0‚Äô;
setTimeout(()=>title.style.display=‚Äònone‚Äô,1800);
setTimeout(()=>transitionTo(0),900);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TITLE SCENE ‚Äî Lourdes valley at twilight with Gave de Pau and Pyrenees
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(function(){
scene.background=new THREE.Color(0x040212);
scene.fog=new THREE.Fog(0x060318,25,180);
// Twilight sky gradient ‚Äî the purple-indigo sky above Lourdes
addC(new THREE.AmbientLight(0x18103a,0.55));
const moon=new THREE.DirectionalLight(0x5060a0,0.5);moon.position.set(-25,35,8);addC(moon);
const rimLight=new THREE.DirectionalLight(0x8070c0,0.22);rimLight.position.set(20,15,-10);addC(rimLight);
addC(mkStars());

// Terrain ‚Äî rolling Pyrenean foothills surrounding Lourdes valley
G.groundFn=rawTerrain;
addC(mkTerrain({season:‚Äòspring‚Äô,res:60}));
addC(mkMountains());

// Sky dome ‚Äî purple twilight above Lourdes
const skyDome=new THREE.Mesh(new THREE.SphereGeometry(240,16,8,0,Math.PI*2,0,Math.PI*0.5),new THREE.MeshBasicMaterial({color:0x080315,side:THREE.BackSide}));
skyDome.position.y=-10;addC(skyDome);
// Pyrenean twilight glow on the horizon
const horiz=new THREE.PointLight(0xff7733,1.2,250);horiz.position.set(-40,10,-80);addC(horiz);

// The Gave de Pau ‚Äî the sacred river
const gave=mkWater(8,120,0x0d1a3a);gave.position.set(9,0.08,0);addC(gave);G.springWater=gave;

// Our Lady ‚Äî luminous, hovering above valley near Massabielle cliff
const titleLadyGY=rawTerrain(0,-22);
const lady=createOurLady();
lady.position.set(0,titleLadyGY+4.5,-22);lady.scale.setScalar(2.0);addC(lady);G.ourLady=lady;
// Extra radiance around her
const radiance=new THREE.PointLight(0xaaccff,3.5,28);radiance.position.set(0,5,-22);addC(radiance);
const warmGlow=new THREE.PointLight(0xffeebb,1.8,18);warmGlow.position.set(0,2,-18);addC(warmGlow);

// Silhouette of the Basilica of Our Lady of the Immaculate Conception
// (built 1866-1872 atop the Massabielle cliff ‚Äî historically, the Lady asked for a chapel)
// Simple distinctive Gothic silhouette
const bM=new THREE.MeshPhongMaterial({color:0x0a0a18,emissive:0x050510,emissiveIntensity:0.8});
// Main nave
addC(pm(new THREE.Mesh(new THREE.BoxGeometry(8,6,16),bM),0,3,-42));
// Spire
addC(pm(new THREE.Mesh(new THREE.ConeGeometry(1.4,10,8),bM),0,12,-42));
// Stained glass glow (golden light within)
const w1=new THREE.PointLight(0xffbb55,2.5,12);w1.position.set(0,4,-42);addC(w1);
// Bell towers
[-4.5,4.5].forEach(x=>{
addC(pm(new THREE.Mesh(new THREE.BoxGeometry(2.2,8,2.2),bM),x,4,-38));
addC(pm(new THREE.Mesh(new THREE.ConeGeometry(1.2,5,6),bM),x,12,-38));
});
// The Crowned Basilica ramparts
addC(pm(new THREE.Mesh(new THREE.BoxGeometry(14,1.5,2),bM),0,5,-35));

// Candle procession dots (thousands of pilgrims carry candles)
const candleGeo=new THREE.BufferGeometry(),cn=300,cp=new Float32Array(cn*3),cc=new Float32Array(cn*3);
for(let i=0;i<cn;i++){
const t=i/cn,curve=Math.sin(t*Math.PI)*3;
cp[i*3]=rand(-10,10);cp[i*3+1]=0.8+rand(0,0.3);cp[i*3+2]=rand(-40,2);
cc[i*3]=1;cc[i*3+1]=0.82+rand(0,0.15);cc[i*3+2]=rand(0,0.3);
}
candleGeo.setAttribute(‚Äòposition‚Äô,new THREE.BufferAttribute(cp,3));
candleGeo.setAttribute(‚Äòcolor‚Äô,new THREE.BufferAttribute(cc,3));
const candlePts=new THREE.Points(candleGeo,new THREE.PointsMaterial({size:0.18,vertexColors:true,transparent:true,opacity:0.9,sizeAttenuation:true}));
addC(candlePts);

// Roadside candles and shrines ‚Äî Chemin du Rosaire
for(let i=0;i<18;i++){
const cz=rand(-35,-2),cx=rand(-4,4);
const cl=new THREE.PointLight(0xffaa33,rand(0.6,1.5),rand(2.5,5));
cl.position.set(cx,0.8+rand(0,0.4),cz);addC(cl);
}

// Trees framing the valley
for(let i=0;i<25;i++){
const tx=rand(-22,22),tz=rand(-50,-5),th=rand(4,9);
const tr=new THREE.Mesh(new THREE.CylinderGeometry(0.14,0.18,th,7),new THREE.MeshPhongMaterial({color:0x2a1a10}));
tr.position.set(tx,th/2,tz);addC(tr);
const cr=new THREE.Mesh(new THREE.SphereGeometry(rand(1.2,2.4),8,7),new THREE.MeshPhongMaterial({color:new THREE.Color(0.04,0.12,0.06)}));
cr.position.set(tx,th+1.2,tz);addC(cr);
}

camera.position.set(0,7,14);
camera.lookAt(0,3,0);
})();

animate();
</script>

</body>
</html>
